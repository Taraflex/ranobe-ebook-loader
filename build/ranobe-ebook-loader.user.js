// ==UserScript==
// @name         ranobe-ebook-loader
// @namespace    mailto:taraflex.red@gmail.com
// @version      0.2.1
// @author       Taraflex <taraflex.red@gmail.com>
// @description  Юзерскрипт для скачивания книг (fb2, epub) c https://ранобэ.рф/ , https://ranobes.com/ и https://tl.rulate.ru/
// @license      MIT
// @homepageURL  https://github.com/Taraflex/ranobe-ebook-loader
// @icon         https://raw.githubusercontent.com/Taraflex/ranobe-ebook-loader/master/icons/32.png
// @icon64       https://raw.githubusercontent.com/Taraflex/ranobe-ebook-loader/master/icons/64.png
// @downloadURL  https://raw.githubusercontent.com/Taraflex/ranobe-ebook-loader/master/build/ranobe-ebook-loader.user.js
// @updateURL    https://raw.githubusercontent.com/Taraflex/ranobe-ebook-loader/master/build/ranobe-ebook-loader.meta.js
// @supportURL   https://github.com/Taraflex/ranobe-ebook-loader/issues
// @match        https://ранобэ.рф/*
// @match        https://xn--80ac9aeh6f.xn--p1ai/*
// @match        https://ranobes.com/ranobe/*
// @match        https://tl.rulate.ru/book/*
// @connect      *
// @run-at       document-idle
// @grant        GM_registerMenuCommand
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest
// @noframes     
// ==/UserScript==
const t=()=>{document.removeEventListener("DOMContentLoaded",t);const e=document.createElement("div");e.id="ranobe-ebook-loader",document.body.appendChild(e),Promise.resolve().then((function(){return vn})).then(t=>new t.default({target:e}))};function e(){}"complete"===document.readyState||"interactive"===document.readyState?t():document.addEventListener("DOMContentLoaded",t);const n=t=>t;function r(t){return t()}function o(){return Object.create(null)}function i(t){t.forEach(r)}function a(t){return"function"==typeof t}function s(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function c(t,n,r){t.$$.on_destroy.push(function(t,...n){if(null==t)return e;const r=t.subscribe(...n);return r.unsubscribe?()=>r.unsubscribe():r}(n,r))}function l(t,e,n,r){return t[1]&&r?function(t,e){for(const n in e)t[n]=e[n];return t}(n.ctx.slice(),t[1](r(e))):n.ctx}function u(t,e,n,r,o,i,a){const s=function(t,e,n,r){if(t[2]&&r){const o=t[2](r(n));if(void 0===e.dirty)return o;if("object"==typeof o){const t=[],n=Math.max(e.dirty.length,o.length);for(let r=0;r<n;r+=1)t[r]=e.dirty[r]|o[r];return t}return e.dirty|o}return e.dirty}(e,r,o,i);if(s){const o=l(e,n,r,a);t.p(o,s)}}function d(t){return t&&a(t.destroy)?t.destroy:e}const f="undefined"!=typeof window;let p=f?()=>window.performance.now():()=>Date.now(),h=f?t=>requestAnimationFrame(t):e;const m=new Set;function g(t){m.forEach(e=>{e.c(t)||(m.delete(e),e.f())}),0!==m.size&&h(g)}function y(t,e){t.appendChild(e)}function b(t,e,n){t.insertBefore(e,n||null)}function v(t){t.parentNode.removeChild(t)}function w(t){return document.createElement(t)}function x(t){return document.createTextNode(t)}function $(){return x(" ")}function k(t,e,n,r){return t.addEventListener(e,n,r),()=>t.removeEventListener(e,n,r)}function _(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function S(t,e,n,r){t.style.setProperty(e,n,r?"important":"")}function A(t,e){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!1,e),n}class E{constructor(t=null){this.a=t,this.e=this.n=null}m(t,e,n=null){this.e||(this.e=w(e.nodeName),this.t=e,this.h(t)),this.i(n)}h(t){this.e.innerHTML=t,this.n=Array.from(this.e.childNodes)}i(t){for(let e=0;e<this.n.length;e+=1)b(this.t,this.n[e],t)}p(t){this.d(),this.h(t),this.i(this.a)}d(){this.n.forEach(v)}}const M=new Set;let O,C=0;function D(t,e,n,r,o,i,a,s=0){const c=16.666/r;let l="{\n";for(let t=0;t<=1;t+=c){const r=e+(n-e)*i(t);l+=100*t+`%{${a(r,1-r)}}\n`}const u=l+`100% {${a(n,1-n)}}\n}`,d=`__svelte_${function(t){let e=5381,n=t.length;for(;n--;)e=(e<<5)-e^t.charCodeAt(n);return e>>>0}(u)}_${s}`,f=t.ownerDocument;M.add(f);const p=f.__svelte_stylesheet||(f.__svelte_stylesheet=f.head.appendChild(w("style")).sheet),h=f.__svelte_rules||(f.__svelte_rules={});h[d]||(h[d]=!0,p.insertRule(`@keyframes ${d} ${u}`,p.cssRules.length));const m=t.style.animation||"";return t.style.animation=`${m?m+", ":""}${d} ${r}ms linear ${o}ms 1 both`,C+=1,d}function T(t,e){const n=(t.style.animation||"").split(", "),r=n.filter(e?t=>t.indexOf(e)<0:t=>-1===t.indexOf("__svelte")),o=n.length-r.length;o&&(t.style.animation=r.join(", "),C-=o,C||h(()=>{C||(M.forEach(t=>{const e=t.__svelte_stylesheet;let n=e.cssRules.length;for(;n--;)e.deleteRule(n);t.__svelte_rules={}}),M.clear())}))}function j(t){O=t}function L(){if(!O)throw new Error("Function called outside component initialization");return O}function P(t){L().$$.on_mount.push(t)}function q(t){L().$$.on_destroy.push(t)}function B(){const t=L();return(e,n)=>{const r=t.$$.callbacks[e];if(r){const o=A(e,n);r.slice().forEach(e=>{e.call(t,o)})}}}const N=[],U=[],I=[],R=[],H=Promise.resolve();let F=!1;function z(){F||(F=!0,H.then(W))}function K(t){I.push(t)}let Y=!1;const G=new Set;function W(){if(!Y){Y=!0;do{for(let t=0;t<N.length;t+=1){const e=N[t];j(e),J(e.$$)}for(N.length=0;U.length;)U.pop()();for(let t=0;t<I.length;t+=1){const e=I[t];G.has(e)||(G.add(e),e())}I.length=0}while(N.length);for(;R.length;)R.pop()();F=!1,Y=!1,G.clear()}}function J(t){if(null!==t.fragment){t.update(),i(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(K)}}let Z;function V(t,e,n){t.dispatchEvent(A(`${e?"intro":"outro"}${n}`))}const X=new Set;let Q;function tt(){Q={r:0,c:[],p:Q}}function et(){Q.r||i(Q.c),Q=Q.p}function nt(t,e){t&&t.i&&(X.delete(t),t.i(e))}function rt(t,e,n,r){if(t&&t.o){if(X.has(t))return;X.add(t),Q.c.push(()=>{X.delete(t),r&&(n&&t.d(1),r())}),t.o(e)}}const ot={duration:0};function it(t,r,o,s){let c=r(t,o),l=s?0:1,u=null,d=null,f=null;function y(){f&&T(t,f)}function b(t,e){const n=t.b-l;return e*=Math.abs(n),{a:l,b:t.b,d:n,duration:e,start:t.start,end:t.start+e,group:t.group}}function v(r){const{delay:o=0,duration:a=300,easing:s=n,tick:v=e,css:w}=c||ot,x={start:p()+o,b:r};r||(x.group=Q,Q.r+=1),u?d=x:(w&&(y(),f=D(t,l,r,a,o,s,w)),r&&v(0,1),u=b(x,a),K(()=>V(t,r,"start")),function(t){let e;0===m.size&&h(g),new Promise(n=>{m.add(e={c:t,f:n})})}(e=>{if(d&&e>d.start&&(u=b(d,a),d=null,V(t,u.b,"start"),w&&(y(),f=D(t,l,u.b,u.duration,0,s,c.css))),u)if(e>=u.end)v(l=u.b,1-l),V(t,u.b,"end"),d||(u.b?y():--u.group.r||i(u.group.c)),u=null;else if(e>=u.start){const t=e-u.start;l=u.a+u.d*s(t/u.duration),v(l,1-l)}return!(!u&&!d)}))}return{run(t){a(c)?(Z||(Z=Promise.resolve(),Z.then(()=>{Z=null})),Z).then(()=>{c=c(),v(t)}):v(t)},end(){y(),u=d=null}}}function at(t,e){rt(t,1,1,()=>{e.delete(t.key)})}function st(t){t&&t.c()}function ct(t,e,n){const{fragment:o,on_mount:s,on_destroy:c,after_update:l}=t.$$;o&&o.m(e,n),K(()=>{const e=s.map(r).filter(a);c?c.push(...e):i(e),t.$$.on_mount=[]}),l.forEach(K)}function lt(t,e){const n=t.$$;null!==n.fragment&&(i(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function ut(t,n,r,a,s,c,l=[-1]){const u=O;j(t);const d=n.props||{},f=t.$$={fragment:null,ctx:null,props:c,update:e,not_equal:s,bound:o(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(u?u.$$.context:[]),callbacks:o(),dirty:l,skip_bound:!1};let p=!1;if(f.ctx=r?r(t,d,(e,n,...r)=>{const o=r.length?r[0]:n;return f.ctx&&s(f.ctx[e],f.ctx[e]=o)&&(!f.skip_bound&&f.bound[e]&&f.bound[e](o),p&&function(t,e){-1===t.$$.dirty[0]&&(N.push(t),z(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}(t,e)),n}):[],f.update(),p=!0,i(f.before_update),f.fragment=!!a&&a(f.ctx),n.target){if(n.hydrate){const t=function(t){return Array.from(t.childNodes)}(n.target);f.fragment&&f.fragment.l(t),t.forEach(v)}else f.fragment&&f.fragment.c();n.intro&&nt(t.$$.fragment),ct(t,n.target,n.anchor),W()}j(u)}class dt{$destroy(){lt(this,1),this.$destroy=e}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const ft=function(t){var e=Object.prototype.hasOwnProperty;function n(t,r){return Array.isArray(t)?function(t,e){for(var r,o="",i="",s=Array.isArray(e),c=0;c<t.length;c++)(r=n(t[c]))&&(s&&e[c]&&(r=a(r)),o=o+i+r,i=" ");return o}(t,r):t&&"object"==typeof t?function(t){var n="",r="";for(var o in t)o&&t[o]&&e.call(t,o)&&(n=n+r+o,r=" ");return n}(t):t||""}function r(t){if(!t)return"";if("object"==typeof t){var n="";for(var r in t)e.call(t,r)&&(n=n+r+":"+t[r]+";");return n}return t+""}function o(t,e,n,r){if(!1===e||null==e||!e&&("class"===t||"style"===t))return"";if(!0===e)return" "+(r?t:t+'="'+t+'"');var o=typeof e;return"object"!==o&&"function"!==o||"function"!=typeof e.toJSON||(e=e.toJSON()),"string"==typeof e||(e=JSON.stringify(e),n||-1===e.indexOf('"'))?(n&&(e=a(e))," "+t+'="'+e+'"'):" "+t+"='"+e.replace(/'/g,"&#39;")+"'"}t.merge=function t(e,n){if(1===arguments.length){for(var o=e[0],i=1;i<e.length;i++)o=t(o,e[i]);return o}for(var a in n)if("class"===a){var s=e[a]||[];e[a]=(Array.isArray(s)?s:[s]).concat(n[a]||[])}else if("style"===a){s=(s=r(e[a]))&&";"!==s[s.length-1]?s+";":s;var c=r(n[a]);c=c&&";"!==c[c.length-1]?c+";":c,e[a]=s+c}else e[a]=n[a];return e},t.classes=n,t.style=r,t.attr=o,t.attrs=function(t,i){var a="";for(var s in t)if(e.call(t,s)){var c=t[s];if("class"===s){c=n(c),a=o(s,c,!1,i)+a;continue}"style"===s&&(c=r(c)),a+=o(s,c,!1,i)}return a};var i=/["&<>]/;function a(t){var e=""+t,n=i.exec(e);if(!n)return t;var r,o,a,s="";for(r=n.index,o=0;r<e.length;r++){switch(e.charCodeAt(r)){case 34:a="&quot;";break;case 38:a="&amp;";break;case 60:a="&lt;";break;case 62:a="&gt;";break;default:continue}o!==r&&(s+=e.substring(o,r)),o=r+1,s+=a}return o!==r?s+e.substring(o,r):s}return t.escape=a,t.rethrow=function t(e,n,r,o){if(!(e instanceof Error))throw e;if(!("undefined"==typeof window&&n||o))throw e.message+=" on line "+r,e;try{o=o||require("fs").readFileSync(n,"utf8")}catch(n){t(e,null,r)}var i=3,a=o.split("\n"),s=Math.max(r-i,0),c=Math.min(a.length,r+i);i=a.slice(s,c).map((function(t,e){var n=e+s+1;return(n==r?"  > ":"    ")+n+"| "+t})).join("\n");throw e.path=n,e.message=(n||"Pug")+":"+r+"\n"+i+"\n\n"+e.message,e},t}({});function pt(t){var e,n="",r=t||{};return function(t,r,o,i,a,s,c,l,u,d,f,p){n+="\n<description>\n  <title-info>",function(){var t=s;if("number"==typeof t.length)for(var r=0,o=t.length;r<o;r++){var i=t[r];n=n+"\n    <genre>"+ft.escape(null==(e=i)?"":e)+"</genre>"}else{o=0;for(var r in t){o++;i=t[r];n=n+"\n    <genre>"+ft.escape(null==(e=i)?"":e)+"</genre>"}}}.call(this),function(){var t=r;if("number"==typeof t.length)for(var o=0,i=t.length;o<i;o++){var a=t[o];n=n+"\n    <author>\n      <first-name>"+ft.escape(null==(e=a.name)?"":e)+"</first-name>\n      <last-name/>",a.homePage&&(n=n+"\n      <home-page>"+ft.escape(null==(e=a.homePage)?"":e)+"</home-page>"),n+="\n    </author>"}else{i=0;for(var o in t){i++;a=t[o];n=n+"\n    <author>\n      <first-name>"+ft.escape(null==(e=a.name)?"":e)+"</first-name>\n      <last-name/>",a.homePage&&(n=n+"\n      <home-page>"+ft.escape(null==(e=a.homePage)?"":e)+"</home-page>"),n+="\n    </author>"}}}.call(this),n=n+"\n    <book-title>"+ft.escape(null==(e=p)?"":e)+"</book-title>",t&&(n=n+"\n    <annotation>"+(null==(e=t)?"":e)+"</annotation>"),l&&(n=n+"\n    <keywords>"+ft.escape(null==(e=l)?"":e)+"</keywords>"),i&&(n+='\n    <coverpage>\n      <image l:href="#cover"/>\n    </coverpage>'),n+="\n    <lang>ru</lang>",u&&(n=n+"\n    <src-lang>"+ft.escape(null==(e=u)?"":e)+"</src-lang>"),n+="\n  </title-info>\n  <document-info>",function(){var t=r;if("number"==typeof t.length)for(var o=0,i=t.length;o<i;o++){var a=t[o];n=n+"\n    <author>\n      <first-name>"+ft.escape(null==(e=a.name)?"":e)+"</first-name>\n      <last-name/>",a.homePage&&(n=n+"\n      <home-page>"+ft.escape(null==(e=a.homePage)?"":e)+"</home-page>"),n+="\n    </author>"}else{i=0;for(var o in t){i++;a=t[o];n=n+"\n    <author>\n      <first-name>"+ft.escape(null==(e=a.name)?"":e)+"</first-name>\n      <last-name/>",a.homePage&&(n=n+"\n      <home-page>"+ft.escape(null==(e=a.homePage)?"":e)+"</home-page>"),n+="\n    </author>"}}}.call(this),n=n+"\n    <program-used>"+ft.escape(null==(e=d)?"":e)+"</program-used>\n    <date"+ft.attr("value",f,!0,!0)+">"+ft.escape(null==(e=a)?"":e)+"</date>\n    <src-url>"+ft.escape(null==(e=c)?"":e)+"</src-url>\n    <id>"+ft.escape(null==(e=o)?"":e)+"</id>\n    <version>1</version>\n  </document-info>\n</description>"}.call(this,"annotation"in r?r.annotation:"undefined"!=typeof annotation?annotation:void 0,"authors"in r?r.authors:"undefined"!=typeof authors?authors:void 0,"bookAlias"in r?r.bookAlias:"undefined"!=typeof bookAlias?bookAlias:void 0,"cover"in r?r.cover:"undefined"!=typeof cover?cover:void 0,"fullDate"in r?r.fullDate:"undefined"!=typeof fullDate?fullDate:void 0,"genres"in r?r.genres:"undefined"!=typeof genres?genres:void 0,"homePage"in r?r.homePage:"undefined"!=typeof homePage?homePage:void 0,"keywords"in r?r.keywords:"undefined"!=typeof keywords?keywords:void 0,"lang"in r?r.lang:"undefined"!=typeof lang?lang:void 0,"programName"in r?r.programName:"undefined"!=typeof programName?programName:void 0,"shortDate"in r?r.shortDate:"undefined"!=typeof shortDate?shortDate:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0),n}function ht(t){var e,n="",r=t||{};return function(t,r){n=n+"<!DOCTYPE html>\n<body>\n  <header>\n    <p>"+ft.escape(null==(e=r)?"":e)+"</p>\n  </header>",function(){var r=t;if("number"==typeof r.length)for(var o=0,i=r.length;o<i;o++){var a=r[o];n=n+"\n  <section>\n    <header>\n      <p>"+ft.escape(null==(e=a.title)?"":e)+"</p>\n    </header>"+(null==(e=a.text)?"":e)+"\n  </section>"}else{i=0;for(var o in r){i++;a=r[o];n=n+"\n  <section>\n    <header>\n      <p>"+ft.escape(null==(e=a.title)?"":e)+"</p>\n    </header>"+(null==(e=a.text)?"":e)+"\n  </section>"}}}.call(this),n+="\n</body>"}.call(this,"parts"in r?r.parts:"undefined"!=typeof parts?parts:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0),n}function mt(t){var e,n="",r=t||{};return function(t,r,o,i,a){n=n+'<?xml version="1.0" encoding="utf-8" ?>\n<ncx version="2005-1" xmlns="http://www.daisy.org/z3986/2005/ncx/">\n  <head>\n    <meta name="dtb:uid"'+ft.attr("content",a,!0,!1)+'></meta>\n    <meta name="dtb:generator"'+ft.attr("content",o,!0,!1)+'></meta>\n    <meta name="dtb:depth" content="1"></meta>\n    <meta name="dtb:totalPageCount" content="0"></meta>\n    <meta name="dtb:maxPageNumber" content="0"></meta>\n  </head>\n  <docTitle>\n    <text>'+ft.escape(null==(e=i)?"":e)+"</text>\n  </docTitle>",function(){var r=t;if("number"==typeof r.length)for(var o=0,i=r.length;o<i;o++){var a=r[o];n=n+"\n  <docAuthor>\n    <text>"+ft.escape(null==(e=a.name)?"":e)+"</text>\n  </docAuthor>"}else{i=0;for(var o in r){i++;a=r[o];n=n+"\n  <docAuthor>\n    <text>"+ft.escape(null==(e=a.name)?"":e)+"</text>\n  </docAuthor>"}}}.call(this),n+="\n  <navMap>",function(){var t=r;if("number"==typeof t.length)for(var o=0,i=t.length;o<i;o++){var a=t[o];n=n+'\n    <navPoint class="chapter"'+ft.attr("playOrder",o+1,!0,!1)+ft.attr("id",a.id,!0,!1)+">\n      <navLabel>\n        <text>"+ft.escape(null==(e=a.title)?"":e)+"</text>\n      </navLabel>\n      <content"+ft.attr("src",a.id+".xhtml",!0,!1)+"></content>\n    </navPoint>"}else{i=0;for(var o in t){i++;a=t[o];n=n+'\n    <navPoint class="chapter"'+ft.attr("playOrder",o+1,!0,!1)+ft.attr("id",a.id,!0,!1)+">\n      <navLabel>\n        <text>"+ft.escape(null==(e=a.title)?"":e)+"</text>\n      </navLabel>\n      <content"+ft.attr("src",a.id+".xhtml",!0,!1)+"></content>\n    </navPoint>"}}}.call(this),n+="\n  </navMap>\n</ncx>"}.call(this,"authors"in r?r.authors:"undefined"!=typeof authors?authors:void 0,"chapters"in r?r.chapters:"undefined"!=typeof chapters?chapters:void 0,"programName"in r?r.programName:"undefined"!=typeof programName?programName:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0,"uuid"in r?r.uuid:"undefined"!=typeof uuid?uuid:void 0),n}function gt(t){var e,n="",r=t||{};return function(t,r){n=n+'<?xml version="1.0" encoding="utf-8" ?>\n<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">\n  <head>\n    <title>'+ft.escape(null==(e=r)?"":e)+'</title>\n    <meta charset="utf-8"></meta>\n  </head>\n  <body>\n    <section epub:type="frontmatter toc">\n      <header>\n        <h1>Содержание</h1>\n      </header>\n      <nav id="toc" epub:type="toc">               \n        <ol>',function(){var r=t;if("number"==typeof r.length)for(var o=0,i=r.length;o<i;o++){var a=r[o];n=n+"\n          <li"+ft.attr("id",a.id,!0,!1)+"><a"+ft.attr("href",a.id+".xhtml",!0,!1)+">"+ft.escape(null==(e=a.title)?"":e)+"</a></li>"}else{i=0;for(var o in r){i++;a=r[o];n=n+"\n          <li"+ft.attr("id",a.id,!0,!1)+"><a"+ft.attr("href",a.id+".xhtml",!0,!1)+">"+ft.escape(null==(e=a.title)?"":e)+"</a></li>"}}}.call(this),n+="\n        </ol>\n      </nav>\n    </section>\n  </body>\n</html>"}.call(this,"chapters"in r?r.chapters:"undefined"!=typeof chapters?chapters:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0),n}function yt(t){var e,n="",r=t||{};return function(t,r,o,i,a,s,c,l,u){n=n+'<?xml version="1.0" encoding="utf-8" ?>\n<package version="3.0" unique-identifier="BookId" xmlns="http://www.idpf.org/2007/opf">\n  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n    <dc:identifier id="BookId">'+ft.escape(null==(e=u)?"":e)+'</dc:identifier>\n    <dc:title id="main">'+ft.escape(null==(e=l)?"":e)+'</dc:title>\n    <meta refines="#main" property="title-type">main</meta>',c&&(n=n+'\n    <dc:title id="subtitle">'+ft.escape(null==(e=c)?"":e)+'</dc:title>\n    <meta refines="#subtitle" property="title-type">subtitle</meta>'),n=n+"\n    <dc:language>ru</dc:language>\n    <dc:date>"+ft.escape(null==(e=s)?"":e)+"</dc:date>\n    <dc:description>"+ft.escape(null==(e=t)?"":e)+"</dc:description>",function(){var t=r;if("number"==typeof t.length)for(var o=0,i=t.length;o<i;o++){var a=t[o];n=0===o?n+'\n    <dc:creator id="author">'+ft.escape(null==(e=a.name)?"":e)+'</dc:creator>\n    <meta refines="#author" property="role" scheme="marc:relators">aut</meta>':n+"\n    <dc:creator>"+ft.escape(null==(e=a.name)?"":e)+"</dc:creator>"}else{i=0;for(var o in t){i++;a=t[o];n=0===o?n+'\n    <dc:creator id="author">'+ft.escape(null==(e=a.name)?"":e)+'</dc:creator>\n    <meta refines="#author" property="role" scheme="marc:relators">aut</meta>':n+"\n    <dc:creator>"+ft.escape(null==(e=a.name)?"":e)+"</dc:creator>"}}}.call(this),i&&(n+='\n    <meta name="cover" content="CoverImage"></meta>'),n=n+'\n    <meta property="dcterms:modified">'+(null==(e=s)?"":e)+"</meta>\n  </metadata>\n  <manifest>",i&&(n=n+'\n    <item id="CoverImage"'+ft.attr("href","images/"+i.id+i.ext,!0,!1)+ft.attr("media-type",i.mime,!0,!1)+' properties="cover-image"></item>'),function(){var t=a;if("number"==typeof t.length)for(var e=0,r=t.length;e<r;e++){var o=t[e];i!=o&&(n=n+"\n    <item"+(ft.attr("id",o.id,!0,!1)+ft.attr("media-type",o.mime,!0,!1)+ft.attr("href","images/"+o.id+o.ext,!0,!1))+"></item>")}else{r=0;for(var e in t){r++;o=t[e];i!=o&&(n=n+"\n    <item"+(ft.attr("id",o.id,!0,!1)+ft.attr("media-type",o.mime,!0,!1)+ft.attr("href","images/"+o.id+o.ext,!0,!1))+"></item>")}}}.call(this),n+='\n    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"></item>\n    <item id="nav" href="nav.xhtml" media-type="application/xhtml+xml" properties="nav"></item>',function(){var t=o;if("number"==typeof t.length)for(var e=0,r=t.length;e<r;e++){var i=t[e];n=n+"\n    <item"+(ft.attr("id",i.id,!0,!1)+ft.attr("href",i.id+".xhtml",!0,!1))+' media-type="application/xhtml+xml"></item>'}else{r=0;for(var e in t){r++;i=t[e];n=n+"\n    <item"+(ft.attr("id",i.id,!0,!1)+ft.attr("href",i.id+".xhtml",!0,!1))+' media-type="application/xhtml+xml"></item>'}}}.call(this),n+='\n  </manifest>\n  <spine toc="ncx">\n    <itemref idref="nav"></itemref>',function(){var t=o;if("number"==typeof t.length)for(var e=0,r=t.length;e<r;e++){var i=t[e];n=n+"\n    <itemref"+ft.attr("idref",i.id,!0,!1)+"></itemref>"}else{r=0;for(var e in t){r++;i=t[e];n=n+"\n    <itemref"+ft.attr("idref",i.id,!0,!1)+"></itemref>"}}}.call(this),n+="\n  </spine>\n</package>"}.call(this,"annotation"in r?r.annotation:"undefined"!=typeof annotation?annotation:void 0,"authors"in r?r.authors:"undefined"!=typeof authors?authors:void 0,"chapters"in r?r.chapters:"undefined"!=typeof chapters?chapters:void 0,"cover"in r?r.cover:"undefined"!=typeof cover?cover:void 0,"images"in r?r.images:"undefined"!=typeof images?images:void 0,"isoDate"in r?r.isoDate:"undefined"!=typeof isoDate?isoDate:void 0,"subtitle"in r?r.subtitle:"undefined"!=typeof subtitle?subtitle:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0,"uuid"in r?r.uuid:"undefined"!=typeof uuid?uuid:void 0),n}function bt(t){var e="";return e+='<?xml version="1.0" encoding="utf-8" ?>\n<display_options>\n  <platform name="*">\n    <option name="specified-fonts">true</option>\n    <option name="interactive">false</option>\n  </platform>\n</display_options>'}var vt="undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().indexOf("firefox")>0;function wt(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent&&t.attachEvent("on".concat(e),(function(){n(window.event)}))}function xt(t,e){for(var n=e.slice(0,e.length-1),r=0;r<n.length;r++)n[r]=t[n[r].toLowerCase()];return n}function $t(t){"string"!=typeof t&&(t="");for(var e=(t=t.replace(/\s/g,"")).split(","),n=e.lastIndexOf("");n>=0;)e[n-1]+=",",e.splice(n,1),n=e.lastIndexOf("");return e}for(var kt={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,"⇪":20,",":188,".":190,"/":191,"`":192,"-":vt?173:189,"=":vt?61:187,";":vt?59:186,"'":222,"[":219,"]":221,"\\":220},_t={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},St={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},At={16:!1,18:!1,17:!1,91:!1},Et={},Mt=1;Mt<20;Mt++)kt["f".concat(Mt)]=111+Mt;var Ot=[],Ct="all",Dt=[],Tt=function(t){return kt[t.toLowerCase()]||_t[t.toLowerCase()]||t.toUpperCase().charCodeAt(0)};function jt(t){Ct=t||"all"}function Lt(){return Ct||"all"}var Pt=function(t){var e=t.key,n=t.scope,r=t.method,o=t.splitKey,i=void 0===o?"+":o;$t(e).forEach((function(t){var e=t.split(i),o=e.length,a=e[o-1],s="*"===a?"*":Tt(a);if(Et[s]){n||(n=Lt());var c=o>1?xt(_t,e):[];Et[s]=Et[s].map((function(t){return(!r||t.method===r)&&t.scope===n&&function(t,e){for(var n=t.length>=e.length?t:e,r=t.length>=e.length?e:t,o=!0,i=0;i<n.length;i++)-1===r.indexOf(n[i])&&(o=!1);return o}(t.mods,c)?{}:t}))}}))};function qt(t,e,n){var r;if(e.scope===n||"all"===e.scope){for(var o in r=e.mods.length>0,At)Object.prototype.hasOwnProperty.call(At,o)&&(!At[o]&&e.mods.indexOf(+o)>-1||At[o]&&-1===e.mods.indexOf(+o))&&(r=!1);(0!==e.mods.length||At[16]||At[18]||At[17]||At[91])&&!r&&"*"!==e.shortcut||!1===e.method(t,e)&&(t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.cancelBubble&&(t.cancelBubble=!0))}}function Bt(t){var e=Et["*"],n=t.keyCode||t.which||t.charCode;if(Nt.filter.call(this,t)){if(93!==n&&224!==n||(n=91),-1===Ot.indexOf(n)&&229!==n&&Ot.push(n),["ctrlKey","altKey","shiftKey","metaKey"].forEach((function(e){var n=St[e];t[e]&&-1===Ot.indexOf(n)?Ot.push(n):!t[e]&&Ot.indexOf(n)>-1?Ot.splice(Ot.indexOf(n),1):"metaKey"===e&&t[e]&&3===Ot.length&&(t.ctrlKey||t.shiftKey||t.altKey||(Ot=Ot.slice(Ot.indexOf(n))))})),n in At){for(var r in At[n]=!0,_t)_t[r]===n&&(Nt[r]=!0);if(!e)return}for(var o in At)Object.prototype.hasOwnProperty.call(At,o)&&(At[o]=t[St[o]]);t.getModifierState&&(!t.altKey||t.ctrlKey)&&t.getModifierState("AltGraph")&&(-1===Ot.indexOf(17)&&Ot.push(17),-1===Ot.indexOf(18)&&Ot.push(18),At[17]=!0,At[18]=!0);var i=Lt();if(e)for(var a=0;a<e.length;a++)e[a].scope===i&&("keydown"===t.type&&e[a].keydown||"keyup"===t.type&&e[a].keyup)&&qt(t,e[a],i);if(n in Et)for(var s=0;s<Et[n].length;s++)if(("keydown"===t.type&&Et[n][s].keydown||"keyup"===t.type&&Et[n][s].keyup)&&Et[n][s].key){for(var c=Et[n][s],l=c.splitKey,u=c.key.split(l),d=[],f=0;f<u.length;f++)d.push(Tt(u[f]));d.sort().join("")===Ot.sort().join("")&&qt(t,c,i)}}}function Nt(t,e,n){Ot=[];var r=$t(t),o=[],i="all",a=document,s=0,c=!1,l=!0,u="+";for(void 0===n&&"function"==typeof e&&(n=e),"[object Object]"===Object.prototype.toString.call(e)&&(e.scope&&(i=e.scope),e.element&&(a=e.element),e.keyup&&(c=e.keyup),void 0!==e.keydown&&(l=e.keydown),"string"==typeof e.splitKey&&(u=e.splitKey)),"string"==typeof e&&(i=e);s<r.length;s++)o=[],(t=r[s].split(u)).length>1&&(o=xt(_t,t)),(t="*"===(t=t[t.length-1])?"*":Tt(t))in Et||(Et[t]=[]),Et[t].push({keyup:c,keydown:l,scope:i,mods:o,shortcut:r[s],method:n,key:r[s],splitKey:u});void 0!==a&&!function(t){return Dt.indexOf(t)>-1}(a)&&window&&(Dt.push(a),wt(a,"keydown",(function(t){Bt(t)})),wt(window,"focus",(function(){Ot=[]})),wt(a,"keyup",(function(t){Bt(t),function(t){var e=t.keyCode||t.which||t.charCode,n=Ot.indexOf(e);if(n>=0&&Ot.splice(n,1),t.key&&"meta"===t.key.toLowerCase()&&Ot.splice(0,Ot.length),93!==e&&224!==e||(e=91),e in At)for(var r in At[e]=!1,_t)_t[r]===e&&(Nt[r]=!1)}(t)})))}var Ut={setScope:jt,getScope:Lt,deleteScope:function(t,e){var n,r;for(var o in t||(t=Lt()),Et)if(Object.prototype.hasOwnProperty.call(Et,o))for(n=Et[o],r=0;r<n.length;)n[r].scope===t?n.splice(r,1):r++;Lt()===t&&jt(e||"all")},getPressedKeyCodes:function(){return Ot.slice(0)},isPressed:function(t){return"string"==typeof t&&(t=Tt(t)),-1!==Ot.indexOf(t)},filter:function(t){var e=t.target||t.srcElement,n=e.tagName,r=!0;return!e.isContentEditable&&("INPUT"!==n&&"TEXTAREA"!==n&&"SELECT"!==n||e.readOnly)||(r=!1),r},unbind:function(t){if(t){if(Array.isArray(t))t.forEach((function(t){t.key&&Pt(t)}));else if("object"==typeof t)t.key&&Pt(t);else if("string"==typeof t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var o=n[0],i=n[1];"function"==typeof o&&(i=o,o=""),Pt({key:t,scope:o,method:i,splitKey:"+"})}}else Object.keys(Et).forEach((function(t){return delete Et[t]}))}};for(var It in Ut)Object.prototype.hasOwnProperty.call(Ut,It)&&(Nt[It]=Ut[It]);if("undefined"!=typeof window){var Rt=window.hotkeys;Nt.noConflict=function(t){return t&&window.hotkeys===Nt&&(window.hotkeys=Rt),Nt},window.hotkeys=Nt}function Ht(t){let n,r,o;return{c:e,m(e,i){r||(o=d(n=t[0].call(null,window,t[1])),r=!0)},p:e,i:e,o:e,d(t){r=!1,o()}}}function Ft(t){const e=B();return[function(t,e){return Nt("ctrl+s",t=>{t.stopImmediatePropagation(),t.preventDefault(),e()}),{destroy(){Nt.unbind("ctrl+s")}}},function(){e("save")}]}class zt extends dt{constructor(t){super(),ut(this,t,Ft,Ht,s,{})}}function Kt(t){let n,r,o,i,a,s,c,l,u,d,f,p,h,m,g,x,A,M,O,C,D,T,j,L,P,q,B,N,U,I,R,H=t[0]+"%";return{c(){n=w("div"),r=w("div"),o=w("div"),i=$(),a=w("div"),s=$(),c=w("div"),l=$(),u=w("div"),d=$(),f=w("div"),p=$(),h=w("div"),m=$(),g=w("div"),x=$(),A=w("div"),M=$(),O=w("div"),C=$(),D=w("div"),T=$(),j=w("div"),L=$(),P=w("div"),q=$(),N=$(),U=w("button"),U.textContent="Cancel",_(o,"class","u_c1"),_(a,"class","u_c2"),_(c,"class","u_c3"),_(u,"class","u_c4"),_(f,"class","u_c5"),_(h,"class","u_c6"),_(g,"class","u_c7"),_(A,"class","u_c8"),_(O,"class","u_c9"),_(D,"class","u_c10"),_(j,"class","u_c11"),_(P,"class","u_c12"),B=new E(null),_(r,"class","u_c"),_(U,"class","u_cancel"),_(n,"class","u_b"),S(n,"--uc",t[1](1)),S(n,"--uch",t[1](.5)),S(n,"--uct",t[1](0))},m(e,v){b(e,n,v),y(n,r),y(r,o),y(r,i),y(r,a),y(r,s),y(r,c),y(r,l),y(r,u),y(r,d),y(r,f),y(r,p),y(r,h),y(r,m),y(r,g),y(r,x),y(r,A),y(r,M),y(r,O),y(r,C),y(r,D),y(r,T),y(r,j),y(r,L),y(r,P),y(r,q),B.m(H,r),y(n,N),y(n,U),I||(R=k(U,"click",t[2]),I=!0)},p(t,[e]){1&e&&H!==(H=t[0]+"%")&&B.p(H),2&e&&S(n,"--uc",t[1](1)),2&e&&S(n,"--uch",t[1](.5)),2&e&&S(n,"--uct",t[1](0))},i:e,o:e,d(t){t&&v(n),I=!1,R()}}}function Yt(t,e,n){let{percent:r=0}=e,{color:o=(()=>"red")}=e;const i=B();return t.$$set=t=>{"percent"in t&&n(0,r=t.percent),"color"in t&&n(1,o=t.color)},[r,o,function(){i("cancel")}]}class Gt extends dt{constructor(t){var e;super(),document.getElementById("svelte-10ltspy-style")||((e=w("style")).id="svelte-10ltspy-style",e.textContent='.u_b{position:fixed;z-index:16777270;right:0;bottom:0;background:hsla(0,0%,100%,.8);width:100vw;height:100vh;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:flex;flex-direction:column;align-items:center;justify-content:center}.u_cancel{margin-top:5%;border:0;background-color:var(--uc);color:#fff;padding:0 2em;line-height:2.7em;border-radius:3px;cursor:pointer;box-shadow:0 0 0 6px var(--uct);transition:box-shadow .1s;font-family:Ubuntu,Segoe UI,Optima,Trebuchet MS,-apple-system,BlinkMacSystemFont,sans-serif!important;font-size:16px}@media screen and (min-width:240px){.u_cancel{font-size:calc(16px + 8*(100vw - 240px)/720)}}@media screen and (min-width:960px){.u_cancel{font-size:24px}}.u_cancel:active,.u_cancel:focus,.u_cancel:hover{outline:0;box-shadow:0 0 0 6px var(--uch)}.u_c{position:relative;pointer-events:none;width:100px;height:100px;line-height:100px;text-align:center;color:var(--uc);font-family:Ubuntu,Segoe UI,Optima,Trebuchet MS,-apple-system,BlinkMacSystemFont,sans-serif!important;font-size:14px}@media screen and (min-width:240px){.u_c{font-size:calc(14px + 7*(100vw - 240px)/720)}}@media screen and (min-width:960px){.u_c{font-size:21px}}.u_c>*{width:100%;height:100%;position:absolute}.u_c>:before{content:"";display:block;margin:0 auto;width:15%;height:15%;background-color:var(--uc);border-radius:100%;animation:u_a 1.2s ease-in-out infinite both}.u_c2{transform:rotate(30deg)}.u_c2:before{animation-delay:-1.1s}.u_c3{transform:rotate(60deg)}.u_c3:before{animation-delay:-1s}.u_c4{transform:rotate(90deg)}.u_c4:before{animation-delay:-.9s}.u_c5{transform:rotate(120deg)}.u_c5:before{animation-delay:-.8s}.u_c6{transform:rotate(150deg)}.u_c6:before{animation-delay:-.7s}.u_c7{transform:rotate(180deg)}.u_c7:before{animation-delay:-.6s}.u_c8{transform:rotate(210deg)}.u_c8:before{animation-delay:-.5s}.u_c9{transform:rotate(240deg)}.u_c9:before{animation-delay:-.4s}.u_c10{transform:rotate(270deg)}.u_c10:before{animation-delay:-.3s}.u_c11{transform:rotate(300deg)}.u_c11:before{animation-delay:-.2s}.u_c12{transform:rotate(330deg)}.u_c12:before{animation-delay:-.1s}@keyframes u_a{0%,80%,to{transform:scale(0)}40%{transform:scale(1)}}',y(document.head,e)),ut(this,t,Yt,Kt,s,{percent:0,color:1})}}function Wt(t){let e,n;const r=t[2].default,o=function(t,e,n,r){if(t){const o=l(t,e,n,r);return t[0](o)}}(r,t,t[1],null);return{c(){e=w("menu"),o&&o.c(),_(e,"type","context"),_(e,"id",t[0])},m(t,r){b(t,e,r),o&&o.m(e,null),n=!0},p(t,[e]){o&&o.p&&2&e&&u(o,r,t,t[1],e,null,null)},i(t){n||(nt(o,t),n=!0)},o(t){rt(o,t),n=!1},d(t){t&&v(e),o&&o.d(t)}}}function Jt(t,e,n){const r="_menu_ranobe-ebook-loader_"+Math.random().toString(16).replace(".","");P(()=>document.body.setAttribute("contextmenu",r)),q(()=>document.body.removeAttribute("contextmenu"));let{$$slots:o={},$$scope:i}=e;return t.$$set=t=>{"$$scope"in t&&n(1,i=t.$$scope)},[r,i,o]}class Zt extends dt{constructor(t){super(),ut(this,t,Jt,Wt,s,{})}}function Vt(t){let n,r,o,s;return{c(){n=w("menuitem"),_(n,"label",t[0]),_(n,"icon",t[1])},m(e,i){b(e,n,i),o||(s=[k(n,"click",t[2]),d(r=t[3].call(null,n,t[0]))],o=!0)},p(t,[e]){1&e&&_(n,"label",t[0]),2&e&&_(n,"icon",t[1]),r&&a(r.update)&&1&e&&r.update.call(null,t[0])},i:e,o:e,d(t){t&&v(n),o=!1,i(s)}}}function Xt(t,e,n){let{label:r="ranobe-ebook-loader"}=e,{icon:o="https://raw.githubusercontent.com/Taraflex/ranobe-ebook-loader/master/icons/32.png"}=e;const i=B();function a(){i("trigger")}return t.$$set=t=>{"label"in t&&n(0,r=t.label),"icon"in t&&n(1,o=t.icon)},[r,o,a,function(t,e){let n="undefined"!=typeof GM_registerMenuCommand&&GM_registerMenuCommand(e,a);function r(){n&&GM_unregisterMenuCommand(n)}return{destroy:r,update(t){r(),n="undefined"!=typeof GM_registerMenuCommand&&GM_registerMenuCommand(t,a)}}}]}class Qt extends dt{constructor(t){super(),ut(this,t,Xt,Vt,s,{label:0,icon:1})}}function te(t){const e=t-1;return e*e*e+1}function ee(t,{delay:e=0,duration:n=400,easing:r=te}){const o=getComputedStyle(t),i=+o.opacity,a=parseFloat(o.height),s=parseFloat(o.paddingTop),c=parseFloat(o.paddingBottom),l=parseFloat(o.marginTop),u=parseFloat(o.marginBottom),d=parseFloat(o.borderTopWidth),f=parseFloat(o.borderBottomWidth);return{delay:e,duration:n,easing:r,css:t=>`overflow: hidden;opacity: ${Math.min(20*t,1)*i};height: ${t*a}px;padding-top: ${t*s}px;padding-bottom: ${t*c}px;margin-top: ${t*l}px;margin-bottom: ${t*u}px;border-top-width: ${t*d}px;border-bottom-width: ${t*f}px;`}}const ne=(t,e,n)=>new Promise((r,o)=>{if(n=Object.assign({concurrency:1/0},n),"function"!=typeof e)throw new TypeError("Mapper function is required");const{concurrency:i}=n;if(!("number"==typeof i&&i>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${i}\` (${typeof i})`);const a=[],s=t[Symbol.iterator]();let c=!1,l=!1,u=0,d=0;const f=()=>{if(c)return;const t=s.next(),n=d;if(d++,t.done)return l=!0,void(0===u&&r(a));u++,Promise.resolve(t.value).then(t=>e(t,n)).then(t=>{a[n]=t,u--,f()},t=>{c=!0,o(t)})};for(let t=0;t<i&&(f(),!l);t++);});var re=ne,oe=ne;re.default=oe;const ie=[];function ae(){let t,e;return{promise:new Promise((function(n,r){e=n,t=r})),resolve:e,reject:t}}const{subscribe:se,update:ce}=function(t,n=e){let r;const o=[];function i(e){if(s(t,e)&&(t=e,r)){const e=!ie.length;for(let e=0;e<o.length;e+=1){const n=o[e];n[1](),ie.push(n,t)}if(e){for(let t=0;t<ie.length;t+=2)ie[t][0](ie[t+1]);ie.length=0}}}return{set:i,update:function(e){i(e(t))},subscribe:function(a,s=e){const c=[a,s];return o.push(c),1===o.length&&(r=n(i)||e),a(t),()=>{const t=o.indexOf(c);-1!==t&&o.splice(t,1),0===o.length&&(r(),r=null)}}}}(new Set),le={subscribe:se,remove:t=>ce(e=>(e.delete(t),e)),add:t=>ce(e=>e.add(Ce(t))),clear:()=>ce(t=>(t.clear(),t))};function ue(t){const e=history[t];return Object.assign((function(){const n=e.apply(this,arguments);return window.dispatchEvent(new Event(t)),n}),{destroy(){history[t]=e}})}const de={"&#x22;":'"',"&#34;":'"',"&#034;":'"',"&quot;":'"',"&#x27;":"'","&#39;":"'","&#039;":"'","&apos;":"'","&#x60;":"`","&nbsp;":" ","&#95;":"_"},fe=RegExp("(?:"+Object.keys(de).join("|")+")","g");async function pe(t,e){const n=await fetch(t,{credentials:"include",signal:e});return 200===n.status?$e(await n.text()):null}function he(t){return{name:t.statusText,message:t.status}}function me(t){return async function(e,n){const r=await fetch(t+e,{credentials:"include",signal:n,headers:{"x-requested-with":"XMLHttpRequest"}});if(r.status>=400)throw he(r);return r.json()}}const ge=/^\s*data:([image\/jpnfwbpsv]+);base64/,ye={"image/gif":".gif","image/jpeg":".jpg","image/png":".png","image/x-ms-bmp":".bmp","image/bmp":".bmp","image/svg+xml":".svg","image/svg":".svg","image/webp":".webp","image/x-xbitmap":".xbm","image/x-xbm":".xbm"};function be(t){return t in ye?t:"image/jpeg"}async function ve(t,e){const n=be(e.type),r=new Uint8Array(await e.arrayBuffer());let o;return{url:t,ext:ye[n],id:await Be(r),mime:n,get cachedB64(){return o},b64:()=>o||new Promise((t,n)=>{const r=new FileReader;r.onloadend=async function(){try{if(2==r.readyState){const e=r.result;t(o=e.slice(e.indexOf(",")+1))}else n(r.error)}catch(t){n(t)}},r.readAsDataURL(e)}),data:()=>r}}const we="undefined"!=typeof GM_xmlhttpRequest?GM_xmlhttpRequest:GM.xmlHttpRequest;async function xe(t,e,n,r){try{if(n.has(e))return n.get(e);t=(t||"").trim();const o=await(ge.test(e)?async function(t){const e=be(function(t,e){const n=t&&t.match(e);return n&&n.length>0?n[n.length-1]:null}(t,ge)),n=await Be(t),r=t.slice(t.indexOf(",")+1);return{ext:ye[e],url:t,id:n,mime:e,get cachedB64(){return r},b64:()=>r,data(){const t=atob(r),e=t.length,n=new Uint8Array(e);for(let r=0;r<e;++r)n[r]=t.charCodeAt(r);return n}}}(e):async function(t,e,n){let r=new AbortController;const o=()=>{n.removeEventListener("abort",o),r.abort()};n.addEventListener("abort",o,{once:!0});try{if(location.host!==new URL(t).host&&we){const n=ae();function i(t){n.reject(t),r.signal.removeEventListener("abort",o),o()}const{abort:o}=we({url:t,method:"GET",responseType:"blob",headers:{Referer:location.href},onprogress:n=>e.has(t)?i({name:"Exist",url:t}):e.has(n.finalUrl)?i({name:"Exist",url:n.finalUrl}):void 0,onabort(){i({name:"AbortError"})},onerror(t){i(t.error)},onload(t){t.status>=400?i(he(t)):(n.resolve(t),r.signal.removeEventListener("abort",o))}});r.signal.addEventListener("abort",o,{once:!0});const{finalUrl:a,response:s}=await n.promise;return await ve(a,s)}{const n=await fetch(t,{credentials:"include",cache:"force-cache",referrer:location.href,signal:r.signal});if(e.has(t))return e.get(t);if(n.status>=400)throw he(n);return e.has(n.url)?e.get(n.url):await ve(n.url,await n.blob())}}catch(t){if("Exist"===(null==t?void 0:t.name))return e.get(t.url);throw t}finally{o()}}(e,n,r.signal));if(o)return n.set(e,o),n.set(o.id,o),n.set(o.url,o),o;if(n.has(e))return n.get(e)}catch(n){"AbortError"!=(null==n?void 0:n.name)&&(console.error(n),le.add(`Ошибка загрузки изображения\n${e}\n${t?`в главе\n"${t}"\n`:""}${Ce(n)}`))}}function $e(t,e){const n=(new DOMParser).parseFromString(t,e||"text/html"),r=n.querySelector("parsererror");if(r)throw r.textContent;return n}function ke(t,e,n){const r=t.createElementNS(e.namespaceURI,n);for(;e.firstChild;)r.appendChild(e.firstChild);return e.parentNode.replaceChild(r,e),r}function _e(t,e,...n){t.querySelectorAll(n.filter(t=>t!=e).join(",")).forEach(n=>ke(t,n,e))}const Se={image:"image",emphasis:"emphasis",strong:"strong",strikethrough:"strikethrough",underline:"strong",blockquote:"cite"},Ae={image:"img",emphasis:"i",strong:"b",strikethrough:"s",underline:"u",blockquote:"blockquote"};async function Ee(t,e,n,r){let o=$e(t=t.replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g,"</p><p>"));try{const{blockquote:a}=Ae;if(o.querySelectorAll(".message-delete,.splitnewsnavigation,script"+(r?"":",img")).forEach(t=>t.remove()),_e(o,n.emphasis,"i","em","dfn","var","q","dd","address"),_e(o,n.strong,"b","strong","mark"),_e(o,n.strikethrough,"s","strike","del"),_e(o,n.underline,"u","ins","abbr","a"),o.querySelectorAll(".game-message,.quote").forEach(t=>ke(o,t,a)),o.querySelectorAll(`body :not(header):not(section):not(${n.emphasis}):not(${n.strong}):not(${n.strikethrough}):not(${n.underline}):not(${a}):not(sub):not(sup):not(img):not(h1)`).forEach(t=>{"SECTION"!==t.parentElement.tagName&&getComputedStyle(t).display.includes("inline")?function(t){for(;t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);t.remove()}(t):ke(o,t,"div")}),t=o.documentElement.outerHTML,o.open(),o=$e(t.replace(/<\/?div>/g,"</p><p>").replace(/<(\/)?blockquote>/g,`</p><$1${a}><p>`)),r&&await re(Array.from(o.querySelectorAll("img")),async t=>{let i=await xe(t.closest("section").querySelector("header").textContent,t.src,r,e);if(i){const{alt:e}=t;if(n===Se){await i.b64();const r=o.createElement(n.image);r.setAttribute("l:href","#"+i.id),e&&r.setAttribute("alt",e),t.parentNode.replaceChild(r,t)}else n===Ae&&(Me(t),t.setAttribute("src","images/"+i.id+i.ext),e&&t.setAttribute("alt",e))}else t.remove()},{concurrency:5}),o.querySelectorAll(`body :not(${n.image})`).forEach(Me),n.blockquote!=a&&o.querySelectorAll(a).forEach(t=>ke(o,t,n.blockquote)),t=(i=o.body.innerHTML,i.replace(fe,t=>de[t])).replace(/(\s*<p>\s*<\/p>\s*)+/g," "),!r)return t;if(n===Se)return t.replace(/><\/image>/g,"/>");if(n===Ae)return t.replace(/(<img[^>]+)>/gi,"$1/>")}finally{o.open()}var i}function Me(t){for(;t.attributes.length>0;)t.removeAttribute(t.attributes.item(0).name)}function Oe(t,e){return e.appendChild(t),{update(n){n!=e&&(e=n).appendChild(t)},destroy(){t.remove()}}}function Ce(t){if(!t||t===!!t||t===+t)return String(t);if(t.constructor===String)return t;if(t.hasOwnProperty("toString")||"symbol"==typeof t)return t.toString();if(t.hasOwnProperty("toJSON"))return JSON.stringify(t,null,"  ");const e=t.message?Ce(t.message):JSON.stringify(t,null,"  "),n=t.name||t.constructor.name;return n&&"Object"!=n&&"Error"!=n?n+": "+e:e}const De=/[\/\?<>\\:\*\|"]/g,Te=/[\x00-\x1f\x80-\x9f]/g,je=/^\.+$/,Le=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,Pe=/[\. ]+$/;const qe=new TextEncoder;async function Be(t){const e=new Uint8Array(await crypto.subtle.digest("SHA-256",t.constructor===String?qe.encode(t):t));return"_"+btoa(String.fromCharCode.apply(null,e)).replace(/\//g,"_").replace(/\+/g,"-").replace(/=+$/,"")}function Ne(t,e,n){const r=t.slice();return r[5]=e[n],r}function Ue(t,e){let n,r,o,a,s,c,l,u,d,f,p,h,m=e[5]+"";function g(...t){return e[2](e[5],...t)}function S(...t){return e[3](e[5],...t)}return{key:t,first:null,c(){n=w("div"),r=w("div"),o=x(m),a=$(),s=w("div"),c=w("button"),c.textContent="🞩",l=$(),u=w("button"),u.textContent="⎀",_(r,"class","u_m"),_(c,"class","u_bf"),_(u,"class","u_bl"),_(u,"title","Click to copy"),_(s,"class","u_r"),_(n,"class","u_n"),this.first=n},m(t,e){b(t,n,e),y(n,r),y(r,o),y(n,a),y(n,s),y(s,c),y(s,l),y(s,u),f=!0,p||(h=[k(c,"click",g),k(u,"click",S)],p=!0)},p(t,n){e=t,(!f||1&n)&&m!==(m=e[5]+"")&&function(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}(o,m)},i(t){f||(t&&K(()=>{d||(d=it(n,ee,{},!0)),d.run(1)}),f=!0)},o(t){t&&(d||(d=it(n,ee,{},!1)),d.run(0)),f=!1},d(t){t&&v(n),t&&d&&d.end(),p=!1,i(h)}}}function Ie(t){let n,r,o,i,a;return{c(){n=w("button"),n.textContent="Close all",_(n,"class","u_bb")},m(e,r){b(e,n,r),o=!0,i||(a=k(n,"click",t[4]),i=!0)},p:e,i(t){o||(t&&K(()=>{r||(r=it(n,ee,{},!0)),r.run(1)}),o=!0)},o(t){t&&(r||(r=it(n,ee,{},!1)),r.run(0)),o=!1},d(t){t&&v(n),t&&r&&r.end(),i=!1,a()}}}function Re(t){let e,n,r,o=[],i=new Map,a=Array.from(t[0]);const s=t=>t[5];for(let e=0;e<a.length;e+=1){let n=Ne(t,a,e),r=s(n);i.set(r,o[e]=Ue(r,n))}let c=t[0].size>2&&Ie(t);return{c(){e=w("div");for(let t=0;t<o.length;t+=1)o[t].c();n=$(),c&&c.c(),_(e,"class","u_d")},m(t,i){b(t,e,i);for(let t=0;t<o.length;t+=1)o[t].m(e,null);y(e,n),c&&c.m(e,null),r=!0},p(t,[r]){if(3&r){const a=Array.from(t[0]);tt(),o=function(t,e,n,r,o,i,a,s,c,l,u,d){let f=t.length,p=i.length,h=f;const m={};for(;h--;)m[t[h].key]=h;const g=[],y=new Map,b=new Map;for(h=p;h--;){const t=d(o,i,h),s=n(t);let c=a.get(s);c?r&&c.p(t,e):(c=l(s,t),c.c()),y.set(s,g[h]=c),s in m&&b.set(s,Math.abs(h-m[s]))}const v=new Set,w=new Set;function x(t){nt(t,1),t.m(s,u),a.set(t.key,t),u=t.first,p--}for(;f&&p;){const e=g[p-1],n=t[f-1],r=e.key,o=n.key;e===n?(u=e.first,f--,p--):y.has(o)?!a.has(r)||v.has(r)?x(e):w.has(o)?f--:b.get(r)>b.get(o)?(w.add(r),x(e)):(v.add(o),f--):(c(n,a),f--)}for(;f--;){const e=t[f];y.has(e.key)||c(e,a)}for(;p;)x(g[p-1]);return g}(o,r,s,1,t,a,i,e,at,Ue,n,Ne),et()}t[0].size>2?c?(c.p(t,r),1&r&&nt(c,1)):(c=Ie(t),c.c(),nt(c,1),c.m(e,null)):c&&(tt(),rt(c,1,1,()=>{c=null}),et())},i(t){if(!r){for(let t=0;t<a.length;t+=1)nt(o[t]);nt(c),r=!0}},o(t){for(let t=0;t<o.length;t+=1)rt(o[t]);rt(c),r=!1},d(t){t&&v(e);for(let t=0;t<o.length;t+=1)o[t].d();c&&c.d()}}}function He(t,e,n){let r;function o(t,e){navigator.clipboard.writeText(t).then(()=>{const t=e.target.closest(".u_n");t.style.animation=null,t.getBoundingClientRect(),t.style.animation="u_shake 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97)"}).catch(t=>le.add(t))}c(t,le,t=>n(0,r=t));return[r,o,t=>le.remove(t),(t,e)=>o(t,e),()=>le.clear()]}class Fe extends dt{constructor(t){var e;super(),document.getElementById("svelte-16jg1d2-style")||((e=w("style")).id="svelte-16jg1d2-style",e.textContent=".u_d{position:fixed;z-index:16777270;right:0;bottom:0;bottom:3px;right:3px;display:flex;flex-direction:column;align-items:flex-end;color:#fff;pointer-events:none}.u_bb,.u_n{margin:3px;display:flex;pointer-events:auto;transform:translateZ(0);-webkit-backface-visibility:hidden;backface-visibility:hidden}.u_m{flex-grow:1;padding:6px 9px;border-top-left-radius:3px;border-bottom-left-radius:3px;white-space:pre-wrap;word-wrap:break-word;max-width:calc(100vw - 70px);font-family:Ubuntu,Segoe UI,Optima,Trebuchet MS,-apple-system,BlinkMacSystemFont,sans-serif!important;font-size:14px}.u_m,.u_r{background-color:rgba(213,0,0,.85)}.u_r{display:flex;flex-direction:column;border-top-right-radius:3px;border-bottom-right-radius:3px;margin-left:1px}.u_b,.u_bb,.u_bf,.u_bl{background-color:transparent;padding:6px;border:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;color:#fff;text-align:center;cursor:pointer;font-family:Ubuntu,Segoe UI,Optima,Trebuchet MS,-apple-system,BlinkMacSystemFont,sans-serif!important;font-size:14px}.u_bf{padding-bottom:0}.u_bl{padding-top:0}.u_bb{background-color:rgba(213,0,0,.85);border-radius:3px}@keyframes u_shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}",y(document.head,e)),ut(this,t,He,Re,s,{})}}var ze="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Ke(t,e,n){return t(n={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&n.path)}},n.exports),n.exports}var Ye=Ke((function(t,e){!function(){function e(t,e){return void 0===e?e={autoBom:!1}:"object"!=typeof e&&(console.warn("Deprecated: Expected third argument to be a object"),e={autoBom:!e}),e.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\ufeff",t],{type:t.type}):t}function n(t,e,n){var r=new XMLHttpRequest;r.open("GET",t),r.responseType="blob",r.onload=function(){a(r.response,e,n)},r.onerror=function(){console.error("could not download file")},r.send()}function r(t){var e=new XMLHttpRequest;e.open("HEAD",t,!1);try{e.send()}catch(t){}return 200<=e.status&&299>=e.status}function o(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(n){var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}var i="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof ze&&ze.global===ze?ze:void 0,a=i.saveAs||("object"!=typeof window||window!==i?function(){}:"download"in HTMLAnchorElement.prototype?function(t,e,a){var s=i.URL||i.webkitURL,c=document.createElement("a");e=e||t.name||"download",c.download=e,c.rel="noopener","string"==typeof t?(c.href=t,c.origin===location.origin?o(c):r(c.href)?n(t,e,a):o(c,c.target="_blank")):(c.href=s.createObjectURL(t),setTimeout((function(){s.revokeObjectURL(c.href)}),4e4),setTimeout((function(){o(c)}),0))}:"msSaveOrOpenBlob"in navigator?function(t,i,a){if(i=i||t.name||"download","string"!=typeof t)navigator.msSaveOrOpenBlob(e(t,a),i);else if(r(t))n(t,i,a);else{var s=document.createElement("a");s.href=t,s.target="_blank",setTimeout((function(){o(s)}))}}:function(t,e,r,o){if((o=o||open("","_blank"))&&(o.document.title=o.document.body.innerText="downloading..."),"string"==typeof t)return n(t,e,r);var a="application/octet-stream"===t.type,s=/constructor/i.test(i.HTMLElement)||i.safari,c=/CriOS\/[\d]+/.test(navigator.userAgent);if((c||a&&s)&&"object"==typeof FileReader){var l=new FileReader;l.onloadend=function(){var t=l.result;t=c?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=t:location=t,o=null},l.readAsDataURL(t)}else{var u=i.URL||i.webkitURL,d=u.createObjectURL(t);o?o.location=d:location.href=d,o=null,setTimeout((function(){u.revokeObjectURL(d)}),4e4)}});i.saveAs=a.saveAs=a,t.exports=a}()}));const Ge={once:!0};function We(...t){const e=ae();function n(){for(let[e,...r]of t)for(let t of r)e.removeEventListener(t,n);e.resolve(void 0)}for(let[e,...r]of t)for(let t of r)e.addEventListener(t,n,Ge);return e}const Je=function(t){const e=t.replace(/-/g,"");if(32!==e.length)throw new Error("uuid string length must be 32 with -'s removed");const n=[];for(let t=0;t<16;t++)n[t]=parseInt(e.substr(2*t,2),16);return new Uint8Array(n)}("00000000-0000-0000-0000-000000000000");async function Ze(t,e){const n=new Uint8Array(e.byteLength+t.length);n.set(e,0),n.set(t,e.byteLength);const r=new Uint8Array(await crypto.subtle.digest("SHA-1",n)),o=new Uint8Array(16);return o.set(r.subarray(0,4),0),o.set(r.subarray(4,10),4),o.set(r.subarray(6,14),6),o[6]=15&o[6]|80,o[8]=63&r[8]|128,o[9]=r[9],o.set(r.subarray(10,16),10),o}function Ve(t){const e=t.toString(16);return 1===e.length?"0"+e:e}let Xe=null;async function Qe(t){return Xe||(Xe=await Ze(qe.encode("ranobe-ebook-loader"),Je)),function(t){let e="";for(let n=0;n<16;n++)e+=Ve(t[n]);return[(n=e).substr(0,8),n.substr(8,4),n.substr(12,4),n.substr(16,4),n.substr(20)].join("-").toLowerCase();var n}(await Ze(qe.encode(t),Xe))}var tn=Ke((function(t,e){t.exports=function(){var t="millisecond",e="second",n="minute",r="hour",o="day",i="week",a="month",s="quarter",c="year",l="date",u=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[^0-9]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?.?(\d+)?$/,d=/\[([^\]]+)]|Y{2,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,f=function(t,e,n){var r=String(t);return!r||r.length>=e?t:""+Array(e+1-r.length).join(n)+t},p={s:f,z:function(t){var e=-t.utcOffset(),n=Math.abs(e),r=Math.floor(n/60),o=n%60;return(e<=0?"+":"-")+f(r,2,"0")+":"+f(o,2,"0")},m:function t(e,n){if(e.date()<n.date())return-t(n,e);var r=12*(n.year()-e.year())+(n.month()-e.month()),o=e.add(r,a),i=n-o<0,s=e.add(r+(i?-1:1),a);return+(-(r+(n-o)/(i?o-s:s-o))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(u){return{M:a,y:c,w:i,d:o,D:l,h:r,m:n,s:e,ms:t,Q:s}[u]||String(u||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},h={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},m="en",g={};g[m]=h;var y=function(t){return t instanceof x},b=function(t,e,n){var r;if(!t)return m;if("string"==typeof t)g[t]&&(r=t),e&&(g[t]=e,r=t);else{var o=t.name;g[o]=t,r=o}return!n&&r&&(m=r),r||!n&&m},v=function(t,e){if(y(t))return t.clone();var n="object"==typeof e?e:{};return n.date=t,n.args=arguments,new x(n)},w=p;w.l=b,w.i=y,w.w=function(t,e){return v(t,{locale:e.$L,utc:e.$u,$offset:e.$offset})};var x=function(){function f(t){this.$L=this.$L||b(t.locale,null,!0),this.parse(t)}var p=f.prototype;return p.parse=function(t){this.$d=function(t){var e=t.date,n=t.utc;if(null===e)return new Date(NaN);if(w.u(e))return new Date;if(e instanceof Date)return new Date(e);if("string"==typeof e&&!/Z$/i.test(e)){var r=e.match(u);if(r){var o=r[2]-1||0,i=(r[7]||"0").substring(0,3);return n?new Date(Date.UTC(r[1],o,r[3]||1,r[4]||0,r[5]||0,r[6]||0,i)):new Date(r[1],o,r[3]||1,r[4]||0,r[5]||0,r[6]||0,i)}}return new Date(e)}(t),this.init()},p.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},p.$utils=function(){return w},p.isValid=function(){return!("Invalid Date"===this.$d.toString())},p.isSame=function(t,e){var n=v(t);return this.startOf(e)<=n&&n<=this.endOf(e)},p.isAfter=function(t,e){return v(t)<this.startOf(e)},p.isBefore=function(t,e){return this.endOf(e)<v(t)},p.$g=function(t,e,n){return w.u(t)?this[e]:this.set(n,t)},p.unix=function(){return Math.floor(this.valueOf()/1e3)},p.valueOf=function(){return this.$d.getTime()},p.startOf=function(t,s){var u=this,d=!!w.u(s)||s,f=w.p(t),p=function(t,e){var n=w.w(u.$u?Date.UTC(u.$y,e,t):new Date(u.$y,e,t),u);return d?n:n.endOf(o)},h=function(t,e){return w.w(u.toDate()[t].apply(u.toDate("s"),(d?[0,0,0,0]:[23,59,59,999]).slice(e)),u)},m=this.$W,g=this.$M,y=this.$D,b="set"+(this.$u?"UTC":"");switch(f){case c:return d?p(1,0):p(31,11);case a:return d?p(1,g):p(0,g+1);case i:var v=this.$locale().weekStart||0,x=(m<v?m+7:m)-v;return p(d?y-x:y+(6-x),g);case o:case l:return h(b+"Hours",0);case r:return h(b+"Minutes",1);case n:return h(b+"Seconds",2);case e:return h(b+"Milliseconds",3);default:return this.clone()}},p.endOf=function(t){return this.startOf(t,!1)},p.$set=function(i,s){var u,d=w.p(i),f="set"+(this.$u?"UTC":""),p=(u={},u[o]=f+"Date",u[l]=f+"Date",u[a]=f+"Month",u[c]=f+"FullYear",u[r]=f+"Hours",u[n]=f+"Minutes",u[e]=f+"Seconds",u[t]=f+"Milliseconds",u)[d],h=d===o?this.$D+(s-this.$W):s;if(d===a||d===c){var m=this.clone().set(l,1);m.$d[p](h),m.init(),this.$d=m.set(l,Math.min(this.$D,m.daysInMonth())).$d}else p&&this.$d[p](h);return this.init(),this},p.set=function(t,e){return this.clone().$set(t,e)},p.get=function(t){return this[w.p(t)]()},p.add=function(t,s){var l,u=this;t=Number(t);var d=w.p(s),f=function(e){var n=v(u);return w.w(n.date(n.date()+Math.round(e*t)),u)};if(d===a)return this.set(a,this.$M+t);if(d===c)return this.set(c,this.$y+t);if(d===o)return f(1);if(d===i)return f(7);var p=(l={},l[n]=6e4,l[r]=36e5,l[e]=1e3,l)[d]||1,h=this.$d.getTime()+t*p;return w.w(h,this)},p.subtract=function(t,e){return this.add(-1*t,e)},p.format=function(t){var e=this;if(!this.isValid())return"Invalid Date";var n=t||"YYYY-MM-DDTHH:mm:ssZ",r=w.z(this),o=this.$locale(),i=this.$H,a=this.$m,s=this.$M,c=o.weekdays,l=o.months,u=function(t,r,o,i){return t&&(t[r]||t(e,n))||o[r].substr(0,i)},f=function(t){return w.s(i%12||12,t,"0")},p=o.meridiem||function(t,e,n){var r=t<12?"AM":"PM";return n?r.toLowerCase():r},h={YY:String(this.$y).slice(-2),YYYY:this.$y,M:s+1,MM:w.s(s+1,2,"0"),MMM:u(o.monthsShort,s,l,3),MMMM:u(l,s),D:this.$D,DD:w.s(this.$D,2,"0"),d:String(this.$W),dd:u(o.weekdaysMin,this.$W,c,2),ddd:u(o.weekdaysShort,this.$W,c,3),dddd:c[this.$W],H:String(i),HH:w.s(i,2,"0"),h:f(1),hh:f(2),a:p(i,a,!0),A:p(i,a,!1),m:String(a),mm:w.s(a,2,"0"),s:String(this.$s),ss:w.s(this.$s,2,"0"),SSS:w.s(this.$ms,3,"0"),Z:r};return n.replace(d,(function(t,e){return e||h[t]||r.replace(":","")}))},p.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},p.diff=function(t,l,u){var d,f=w.p(l),p=v(t),h=6e4*(p.utcOffset()-this.utcOffset()),m=this-p,g=w.m(this,p);return g=(d={},d[c]=g/12,d[a]=g,d[s]=g/3,d[i]=(m-h)/6048e5,d[o]=(m-h)/864e5,d[r]=m/36e5,d[n]=m/6e4,d[e]=m/1e3,d)[f]||m,u?g:w.a(g)},p.daysInMonth=function(){return this.endOf(a).$D},p.$locale=function(){return g[this.$L]},p.locale=function(t,e){if(!t)return this.$L;var n=this.clone(),r=b(t,e,!0);return r&&(n.$L=r),n},p.clone=function(){return w.w(this.$d,this)},p.toDate=function(){return new Date(this.valueOf())},p.toJSON=function(){return this.isValid()?this.toISOString():null},p.toISOString=function(){return this.$d.toISOString()},p.toString=function(){return this.$d.toUTCString()},f}(),$=x.prototype;return v.prototype=$,[["$ms",t],["$s",e],["$m",n],["$H",r],["$W",o],["$M",a],["$y",c],["$D",l]].forEach((function(t){$[t[1]]=function(e){return this.$g(e,t[0],t[1])}})),v.extend=function(t,e){return t(e,x,v),v},v.locale=b,v.isDayjs=y,v.unix=function(t){return v(1e3*t)},v.en=g[m],v.Ls=g,v}()}));class en{constructor(t){this.progress=t,this.programName="ranobe-ebook-loader 0.2.1",this.homePage=location.href}date(t){return this.d.format(t)}get isoDate(){return this.d.toISOString().replace(".000","")}extractTitle(t){return t.querySelector("h1").firstChild.textContent}}const nn=me("https://xn--80ac9aeh6f.xn--p1ai/api/v2/books/");class rn extends en{constructor(){super(...arguments),this.bookAlias=location.pathname.split("/",2).find(Boolean),this.homePage=`https://xn--80ac9aeh6f.xn--p1ai/${this.bookAlias}/`}static get injectTarget(){return document.getElementsByClassName("BookPageActions__actions")[0]}async init({signal:t}){const{fullTitle:e,titleEn:n,genres:r,author:o,description:i,createTime:a,title:s,images:c,country:l}=await nn(this.bookAlias,t);this.covers=[c.vertical.find(t=>"bookMain"===t.processor).url],this.d=tn(a),this.genres=r.map(t=>t.title),this.title=s,this.subtitle=[e,n].filter(Boolean).join(" • "),this.description=i||"",this.lang=null==l?void 0:l.code,this.authors=[o].filter(Boolean)}async parts(t,e){const{bookAlias:n}=this,{items:r}=await nn(n+"/chapters",t.signal);return re(r.filter(t=>t.isFull||"free"===t.availabilityStatus).reverse(),async({slug:o},i)=>{try{const{title:a,text:{text:s}}=await nn(n+"/chapters/"+o,t.signal);if(s.includes("<img ")){const n=$e(s);for(let r of Array.from(n.getElementsByTagName("img")))await xe(a,r.src,e,t);n.open()}return this.progress(i,r.length),{title:a,text:s}}catch(e){throw t.abort(),e}},{concurrency:5})}}rn.spa=!0,rn.component="Link Link_size_md Link_bordered Link_hover_filled BookPageActions__action",rn.color=t=>`rgba(48,55,69,${t})`;class on extends en{static get injectTarget(){return document.getElementById("mc-fs-rate")}async init(t){this.bookAlias=document.querySelector(".r-fullstory-chapters-foot > a:nth-child(3n)").href.split("/",5).slice(-1)[0],this.covers=[document.querySelector('[itemprop="image"]').href],this.d=tn(document.querySelector('[itemprop="datePublished"]').getAttribute("content")),this.genres=Array.from(document.querySelectorAll('[itemprop="genre"] a'),t=>t.textContent),this.keywords=Array.from(document.querySelectorAll('[itemprop="keywords"] a'),t=>t.textContent).join(", "),this.title=this.extractTitle(document),this.subtitle=document.querySelector('[itemprop="alternateName"]').textContent,this.description=document.querySelector('[itemprop="description"]').innerHTML,this.authors=Array.from(document.querySelectorAll('[itemprop="creator"] a'),t=>({name:t.textContent,homePage:t.href}))}async parts(t,e){const{bookAlias:n}=this,r=[];for(let e=1;;++e){const o=await pe(`https://ranobes.com/chapters/${n}/page/${e}/`,t.signal);if(!o)break;o.querySelectorAll(`.cat_block a[href^="https://ranobes.com/chapters/${n}/"]`).forEach(t=>r.push(t.href))}return re(r.reverse(),async(o,i)=>{try{let a="",s="";const c=[o];for(let r of c){const o=await pe(r,t.signal);if(!o)break;const i=o.getElementById("arrticle");if(a+=i.outerHTML,!s){s=this.extractTitle(o);const t=o.querySelector(".splitnewsnavigation");t&&t.querySelectorAll(`a[href^="https://ranobes.com/chapters/${n}/"]`).forEach(t=>c.push(t.href))}for(let n of Array.from(i.getElementsByTagName("img")))await xe(s,n.src,e,t);o.open()}return this.progress(i,r.length),{title:s,text:a}}catch(e){throw t.abort(),e}},{concurrency:5})}}on.component="btn btn-block",on.color=t=>`rgba(149,172,124,${t})`;const an={янв:"jan",фев:"feb",мар:"mar",апр:"apr",мая:"may",июн:"jun",июл:"jul",авг:"aug",сен:"sep",окт:"oct",ноя:"nov",дек:"dec"};const sn=me("");class cn extends en{constructor(){super(...arguments),this.chapterElements=Array.from(document.querySelectorAll("#Chapters .btn-info"))}static get injectTarget(){return document.querySelector("#Info > .btn-toolbar")}async init(t){const e=document.getElementById("Info");this.covers=Array.from(e.querySelectorAll(".slick img"),t=>t.src);const n=this.covers.find(t=>/\.jpe?g($|\?)/i.test(t));var r;n&&this.covers.unshift(n),this.covers=Array.from(new Set(this.covers)),this.d=(r=this.chapterElements[this.chapterElements.length-1].parentElement.previousElementSibling.previousElementSibling.firstElementChild.getAttribute("title"),tn(r.replace(/(янв|фев|мар|апр|мая|июн|июл|авг|сен|окт|ноя|дек)[а-я]*/i,(t,e)=>an[e]).replace(/[^\w:\+\s]+/g,"").replace(/\s+/g," "))),this.genres=Array.from(document.querySelectorAll('.info a[href^="/search?genres"]'),t=>t.textContent),this.keywords=Array.from(document.querySelectorAll('.info a[href^="/search?tags"]'),t=>t.textContent).join(", "),this.subtitle=this.extractTitle(document),this.title=this.subtitle.substring(this.subtitle.lastIndexOf(" / ")+3);let o="",i=e.querySelector(".btn-toolbar + p");for(;i;)o+=i.outerHTML,i=i.nextElementSibling,i&&"H2"===i.tagName&&(i=null);this.description=o,this.authors=Array.from(document.getElementById("Info").querySelectorAll('a[href^="/search?from=book&t="]')).filter(t=>"Автор:"===t.parentElement.previousElementSibling.textContent).map(t=>({name:t.textContent,homePage:t.href})),this.bookAlias=this.title.replace(De,"-").replace(Te,"-").replace(je,"-").replace(Le,"-").replace(Pe,"-")}async parts(t,e){return re(this.chapterElements.map(t=>t.href),async(n,r)=>{try{let{title:o,content:i}=await sn(n.replace(/_new$/,"")+"ajax?is_new=true",t.signal);if(i=i.split(/<div class="content-text" style="word-wrap: break-word;">|<p>https?:\/\/tl\.rulate\.ru\/book\//,3)[1],i.includes("<img ")){const n=$e(i);for(let r of Array.from(n.getElementsByTagName("img")))await xe(o,r.src,e,t);n.open()}return this.progress(r,this.chapterElements.length),{title:o,text:i}}catch(e){throw t.abort(),e}},{concurrency:5})}}cn.component="btn btn-info",cn.color=t=>`rgba(0,85,128,${t})`;const ln=[];for(let t=0;t<256;t++){let e=t;for(let t=0;t<8;t++)e=1&e?3988292384^e>>>1:e>>>1;ln[t]=e}function un(t){let e=-1;for(const n of t)e=e>>>8^ln[255&(e^n)];return-1^e}function dn(t,e){const n=[];for(;e--;)n.push(255&t),t>>>=8;return n}function fn(t){let e,n,r,o,s,c,l,u,f,p,h,m,g,S,A,E;return e=new zt({}),e.$on("save",t[5]),r=new Zt({props:{$$slots:{default:[hn]},$$scope:{ctx:t}}}),{c(){st(e.$$.fragment),n=$(),st(r.$$.fragment),o=$(),s=w("button"),c=x(gn),f=$(),p=w("button"),h=x(yn),_(s,"class",l=t[3].component),_(p,"class",m=t[3].component)},m(i,a){ct(e,i,a),b(i,n,a),ct(r,i,a),b(i,o,a),b(i,s,a),y(s,c),b(i,f,a),b(i,p,a),y(p,h),S=!0,A||(E=[k(s,"click",t[5]),d(u=Oe.call(null,s,t[2])),k(p,"click",t[6]),d(g=Oe.call(null,p,t[2]))],A=!0)},p(t,e){const n={};1024&e&&(n.$$scope={dirty:e,ctx:t}),r.$set(n),u&&a(u.update)&&4&e&&u.update.call(null,t[2]),g&&a(g.update)&&4&e&&g.update.call(null,t[2])},i(t){S||(nt(e.$$.fragment,t),nt(r.$$.fragment,t),S=!0)},o(t){rt(e.$$.fragment,t),rt(r.$$.fragment,t),S=!1},d(t){lt(e,t),t&&v(n),lt(r,t),t&&v(o),t&&v(s),t&&v(f),t&&v(p),A=!1,i(E)}}}function pn(t){let e,n;return e=new Gt({props:{percent:t[1],color:t[3].color}}),e.$on("cancel",t[4]),{c(){st(e.$$.fragment)},m(t,r){ct(e,t,r),n=!0},p(t,n){const r={};2&n&&(r.percent=t[1]),e.$set(r)},i(t){n||(nt(e.$$.fragment,t),n=!0)},o(t){rt(e.$$.fragment,t),n=!1},d(t){lt(e,t)}}}function hn(t){let n,r,o,i;return n=new Qt({props:{label:gn}}),n.$on("trigger",t[5]),o=new Qt({props:{label:yn}}),o.$on("trigger",t[6]),{c(){st(n.$$.fragment),r=$(),st(o.$$.fragment)},m(t,e){ct(n,t,e),b(t,r,e),ct(o,t,e),i=!0},p:e,i(t){i||(nt(n.$$.fragment,t),nt(o.$$.fragment,t),i=!0)},o(t){rt(n.$$.fragment,t),rt(o.$$.fragment,t),i=!1},d(t){lt(n,t),t&&v(r),lt(o,t)}}}function mn(t){let e,n,r,o,i;const a=[pn,fn],s=[];function c(t,e){return t[0]?0:t[2]?1:-1}return~(e=c(t))&&(n=s[e]=a[e](t)),o=new Fe({}),{c(){n&&n.c(),r=$(),st(o.$$.fragment)},m(t,n){~e&&s[e].m(t,n),b(t,r,n),ct(o,t,n),i=!0},p(t,[o]){let i=e;e=c(t),e===i?~e&&s[e].p(t,o):(n&&(tt(),rt(s[i],1,1,()=>{s[i]=null}),et()),~e?(n=s[e],n||(n=s[e]=a[e](t),n.c()),nt(n,1),n.m(r.parentNode,r)):n=null)},i(t){i||(nt(n),nt(o.$$.fragment,t),i=!0)},o(t){rt(n),rt(o.$$.fragment,t),i=!1},d(t){~e&&s[e].d(t),t&&v(r),lt(o,t)}}}const gn="Скачать *.fb2",yn="Скачать *.epub";function bn(t,e,n){const r={"ранобэ.рф":rn,"xn--80ac9aeh6f.xn--p1ai":rn,"ranobes.com":on,"tl.rulate.ru":cn}[location.hostname];let o,i=!1,a=0,s=null;function c(){o&&(o.abort(),o=null),i&&n(0,i=!1),a&&n(1,a=0)}const l=new AbortController;P(async()=>{if(r.spa){history.pushState=ue("pushState"),history.replaceState=ue("replaceState");const t=t=>setTimeout(t,2e3);for(;!l.signal.aborted;){for(;!n(2,s=r.injectTarget);)if(await new Promise(t),l.signal.aborted)return;await We([l.signal,"abort"],[window,"pushState","replaceState","popstate"]).promise,c(),await new Promise(t)}}else n(2,s=await r.injectTarget)}),q(()=>{var t,e,n,o;l.abort(),c(),r.spa&&(null===(e=(t=history.pushState).destroy)||void 0===e||e.call(t),null===(o=(n=history.replaceState).destroy)||void 0===o||o.call(n))});const u=f.bind(null,Se),d=f.bind(null,Ae);async function f(t){var e;if(!i&&s)try{c(),n(0,i=!0),le.clear(),await(z(),H),o=new AbortController;const s=new r((t,e)=>n(1,a=Math.max(a,100*(t+1)/e|0)));await s.init(o),s.genres.length<1&&s.genres.push("unrecognised");const l=new Map,u=await s.parts(o,l);switch(t){case Ae:u.unshift({title:"Аннотация",text:s.description+s.covers.map(t=>`<p><img src="${t}"/></p>`).join("")});const n=await re(u,async e=>(e.id=await Be(e.title),e.text=await Ee(function(t){var e,n="",r=t||{};return function(t,r){n=n+"<!DOCTYPE html>\n<body>\n  <section>\n    <header>\n      <h1>"+ft.escape(null==(e=r)?"":e)+"</h1>\n    </header>"+(null==(e=t)?"":e)+"\n  </section>\n</body>"}.call(this,"text"in r?r.text:"undefined"!=typeof text?text:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0),n}(e),o,t,l),e.text=function(t){var e,n="",r=t||{};return function(t,r){n=n+'<?xml version="1.0" encoding="utf-8" ?>\n<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">\n  <head>\n    <title>'+ft.escape(null==(e=r)?"":e)+'</title>\n    <style type="text/css">img{display:inline-block;width:auto;height:auto;max-width:100%;max-height:100%;page-break-before:avoid;page-break-after:auto;page-break-inside:avoid;}</style>\n  </head>\n  <body>'+(null==(e=t)?"":e)+"</body>\n</html>"}.call(this,"text"in r?r.text:"undefined"!=typeof text?text:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0),n}(e),e),{concurrency:5}),r=Array.from(new Set(l.values())),i=$e(n[0].text).querySelector("section");i.firstElementChild.remove();const a={...s,cover:l.get(s.covers[0]),isoDate:s.isoDate,uuid:"urn:uuid:"+await Qe(s.title+s.subtitle),annotation:i.innerText,chapters:n,images:r};i.ownerDocument.open(),l.clear();const c="application/epub+zip",d=new Blob(Array.from(function*(t){let e=0;const n=[];let r=0;for(const{path:o,data:i}of t){const t=i instanceof Uint8Array?i:qe.encode(i),a=qe.encode(o),s=[10,0,0,0,0,0,0,0,0,0,...dn(un(t),4),...dn(t.length,4),...dn(t.length,4),...dn(a.length,2),0,0];n.push(80,75,1,2,20,0,...s,0,0,0,0,0,0,0,0,0,0,...dn(e,4),...a);const c=new Uint8Array([80,75,3,4,...s]);e+=c.byteLength+t.byteLength+a.byteLength,++r,yield c,yield a,yield t}n.push(80,75,5,6,0,0,0,0,...dn(r,2),...dn(r,2),...dn(n.length,4),...dn(e,4),0,0),yield new Uint8Array(n)}([{path:"mimetype",data:c},{path:"META-INF/container.xml",data:(e="",e+='<?xml version="1.0" encoding="utf-8" ?>\n<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n  <rootfiles>\n    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"></rootfile>\n  </rootfiles>\n</container>')},{path:"META-INF/com.apple.ibooks.display-options.xml",data:bt()},{path:"OEBPS/toc.ncx",data:mt(a)},{path:"OEBPS/nav.xhtml",data:gt(a)},{path:"OEBPS/content.opf",data:yt(a)},...r.map(t=>({path:"OEBPS/images/"+t.id+t.ext,data:t.data()})),...n.map(t=>({path:`OEBPS/${t.id}.xhtml`,data:t.text}))])),{type:c});return Ye.saveAs(d,s.bookAlias+".epub");case Se:const f=await(s.covers[0]&&xe("Обложка",s.covers[0],l,o));await(null==f?void 0:f.b64());const p=['<?xml version="1.0" encoding="utf-8"?><FictionBook xmlns="http://www.gribuser.ru/xml/fictionbook/2.0" xmlns:l="http://www.w3.org/1999/xlink">',pt({...s,cover:f,annotation:await Ee("<div>"+s.description+"</div>",o,t),shortDate:s.date("YYYY-MM-DD"),fullDate:s.date("DD.MM.YYYY")}),"<body>",(await Ee(ht({title:s.title,parts:u}),o,t,l)).replace(/<(\/)?header>/g,"<$1title>"),"</body>"];for(let t of new Set(l.values()))t.cachedB64&&p.push(`<binary id="${t.id}" content-type="${t.mime}">`,t.cachedB64,"</binary>");l.clear(),p.push("</FictionBook>");const h=new Blob(p,{type:"application/x-fictionbook+xml;charset=utf-8"});return Ye.saveAs(h,s.bookAlias+".fb2")}}catch(t){"AbortError"!=(null==t?void 0:t.name)&&(console.error(t),le.add(t))}finally{c()}}return console.log("ranobe-ebook-loader 0.2.1"),[i,a,s,r,c,u,d]}const vn={__proto__:null,default:class extends dt{constructor(t){var e;super(),document.getElementById("svelte-jnedj2-style")||((e=w("style")).id="svelte-jnedj2-style",e.textContent="#ranobe-ebook-loader{position:fixed;z-index:16777270;right:0;bottom:0}",y(document.head,e)),ut(this,t,bn,mn,s,{})}}};
