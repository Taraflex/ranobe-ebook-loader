// ==UserScript==
// @name         ranobe-rf-fb2-loader
// @namespace    taraflex
// @version      0.0.1
// @description  Юзерскрипт для скачивания книг в формате fb2 c https://ранобэ.рф/
// @author       taraflex.red@gmail.com
// @downloadURL  https://raw.githubusercontent.com/Taraflex/ranobe-rf-fb2-loader/master/build/ranobe-rf-fb2-loader.user.js
// @updateURL    https://raw.githubusercontent.com/Taraflex/ranobe-rf-fb2-loader/master/build/ranobe-rf-fb2-loader.user.js
// @match        https://xn--80ac9aeh6f.xn--p1ai/*
// ==/UserScript==
!function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=10)}([function(t,e,n){"use strict";var r=Object.prototype.hasOwnProperty;function o(t,e){return Array.isArray(t)?function(t,e){for(var n,r="",i="",s=Array.isArray(e),a=0;a<t.length;a++)n=o(t[a]),n&&(s&&e[a]&&(n=l(n)),r=r+i+n,i=" ");return r}(t,e):t&&"object"==typeof t?function(t){var e="",n="";for(var o in t)o&&t[o]&&r.call(t,o)&&(e=e+n+o,n=" ");return e}(t):t||""}function i(t){if(!t)return"";if("object"==typeof t){var e="";for(var n in t)r.call(t,n)&&(e=e+n+":"+t[n]+";");return e}return t+""}function s(t,e,n,r){return!1!==e&&null!=e&&(e||"class"!==t&&"style"!==t)?!0===e?" "+(r?t:t+'="'+t+'"'):("function"==typeof e.toJSON&&(e=e.toJSON()),"string"==typeof e||(e=JSON.stringify(e),n||-1===e.indexOf('"'))?(n&&(e=l(e))," "+t+'="'+e+'"'):" "+t+"='"+e.replace(/'/g,"&#39;")+"'"):""}e.merge=function t(e,n){if(1===arguments.length){for(var r=e[0],o=1;o<e.length;o++)r=t(r,e[o]);return r}for(var s in n)if("class"===s){var a=e[s]||[];e[s]=(Array.isArray(a)?a:[a]).concat(n[s]||[])}else if("style"===s){var a=i(e[s]);a=a&&";"!==a[a.length-1]?a+";":a;var l=i(n[s]);l=l&&";"!==l[l.length-1]?l+";":l,e[s]=a+l}else e[s]=n[s];return e},e.classes=o,e.style=i,e.attr=s,e.attrs=function(t,e){var n="";for(var a in t)if(r.call(t,a)){var l=t[a];if("class"===a){l=o(l),n=s(a,l,!1,e)+n;continue}"style"===a&&(l=i(l)),n+=s(a,l,!1,e)}return n};var a=/["&<>]/;function l(t){var e=""+t,n=a.exec(e);if(!n)return t;var r,o,i,s="";for(r=n.index,o=0;r<e.length;r++){switch(e.charCodeAt(r)){case 34:i="&quot;";break;case 38:i="&amp;";break;case 60:i="&lt;";break;case 62:i="&gt;";break;default:continue}o!==r&&(s+=e.substring(o,r)),o=r+1,s+=i}return o!==r?s+e.substring(o,r):s}e.escape=l,e.rethrow=function t(e,r,o,i){if(!(e instanceof Error))throw e;if(!("undefined"==typeof window&&r||i))throw e.message+=" on line "+o,e;try{i=i||n(9).readFileSync(r,"utf8")}catch(n){t(e,null,o)}var s=3,a=i.split("\n"),l=Math.max(o-s,0),c=Math.min(a.length,o+s);var s=a.slice(l,c).map(function(t,e){var n=e+l+1;return(n==o?"  > ":"    ")+n+"| "+t}).join("\n");e.path=r;e.message=(r||"Pug")+":"+o+"\n"+s+"\n\n"+e.message;throw e}},function(t,e,n){var r,o,i;o=[],r=function(){"use strict";function e(t,e,n){var r=new XMLHttpRequest;r.open("GET",t),r.responseType="blob",r.onload=function(){i(r.response,e,n)},r.onerror=function(){console.error("could not download file")},r.send()}function n(t){var e=new XMLHttpRequest;return e.open("HEAD",t,!1),e.send(),200<=e.status&&299>=e.status}function r(t){try{t.dispatchEvent(new MouseEvent("click"))}catch(n){var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(e)}}var o="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0,i=o.saveAs||"object"!=typeof window||window!==o?function(){}:"download"in HTMLAnchorElement.prototype?function(t,i,s){var a=o.URL||o.webkitURL,l=document.createElement("a");i=i||t.name||"download",l.download=i,l.rel="noopener","string"==typeof t?(l.href=t,l.origin===location.origin?r(l):n(l.href)?e(t,i,s):r(l,l.target="_blank")):(l.href=a.createObjectURL(t),setTimeout(function(){a.revokeObjectURL(l.href)},4e4),setTimeout(function(){r(l)},0))}:"msSaveOrOpenBlob"in navigator?function(t,o,i){if(o=o||t.name||"download","string"!=typeof t)navigator.msSaveOrOpenBlob(function(t,e){return void 0===e?e={autoBom:!1}:"object"!=typeof e&&(console.warn("Depricated: Expected third argument to be a object"),e={autoBom:!e}),e.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\ufeff",t],{type:t.type}):t}(t,i),o);else if(n(t))e(t,o,i);else{var s=document.createElement("a");s.href=t,s.target="_blank",setTimeout(function(){r(s)})}}:function(t,n,r,i){if(i=i||open("","_blank"),i&&(i.document.title=i.document.body.innerText="downloading..."),"string"==typeof t)return e(t,n,r);var s="application/octet-stream"===t.type,a=/constructor/i.test(o.HTMLElement)||o.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent);if((l||s&&a)&&"object"==typeof FileReader){var c=new FileReader;c.onloadend=function(){var t=c.result;t=l?t:t.replace(/^data:[^;]*;/,"data:attachment/file;"),i?i.location.href=t:location=t,i=null},c.readAsDataURL(t)}else{var f=o.URL||o.webkitURL,u=f.createObjectURL(t);i?i.location=u:location.href=u,i=null,setTimeout(function(){f.revokeObjectURL(u)},4e4)}};o.saveAs=i.saveAs=i,t.exports=i},i="function"==typeof r?r.apply(e,o):r,void 0===i||(t.exports=i)},function(t,e,n){t.exports=function(){"use strict";var t="millisecond",e="second",n="minute",r="hour",o="day",i="week",s="month",a="year",l=/^(\d{4})-?(\d{1,2})-?(\d{0,2})(.*?(\d{1,2}):(\d{1,2}):(\d{1,2}))?.?(\d{1,3})?$/,c=/\[.*?\]|Y{2,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,f={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},u=function(t,e,n){var r=String(t);return!r||r.length>=e?t:""+Array(e+1-r.length).join(n)+t},d={padStart:u,padZoneStr:function(t){var e=Math.abs(t),n=Math.floor(e/60),r=e%60;return(t<=0?"+":"-")+u(n,2,"0")+":"+u(r,2,"0")},monthDiff:function(t,e){var n=12*(e.year()-t.year())+(e.month()-t.month()),r=t.clone().add(n,"months"),o=e-r<0,i=t.clone().add(n+(o?-1:1),"months");return Number(-(n+(e-r)/(o?r-i:i-r)))},absFloor:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},prettyUnit:function(l){return{M:s,y:a,w:i,d:o,h:r,m:n,s:e,ms:t}[l]||String(l||"").toLowerCase().replace(/s$/,"")},isUndefined:function(t){return void 0===t}},h="en",m={};m[h]=f;var v=function(t){return t instanceof k},p=function(t,e,n){var r;if(!t)return null;if("string"==typeof t)m[t]&&(r=t),e&&(m[t]=e,r=t);else{var o=t.name;m[o]=t,r=o}return n||(h=r),r},g=function(t,e){if(v(t))return t.clone();var n=e||{};return n.date=t,new k(n)},y=function(t,e){return g(t,{locale:e.$L})},b=d;b.parseLocale=p,b.isDayjs=v,b.wrapper=y;var k=function(){function f(t){this.parse(t)}var u=f.prototype;return u.parse=function(t){var e,n;this.$d=null===(e=t.date)?new Date(NaN):b.isUndefined(e)?new Date:e instanceof Date?e:"string"==typeof e&&/.*[^Z]$/i.test(e)&&(n=e.match(l))?new Date(n[1],n[2]-1,n[3]||1,n[5]||0,n[6]||0,n[7]||0,n[8]||0):new Date(e),this.init(t)},u.init=function(t){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds(),this.$L=this.$L||p(t.locale,null,!0)||h},u.$utils=function(){return b},u.isValid=function(){return!("Invalid Date"===this.$d.toString())},u.isSame=function(t,e){var n=g(t);return this.startOf(e)<=n&&n<=this.endOf(e)},u.isAfter=function(t,e){return g(t)<this.startOf(e)},u.isBefore=function(t,e){return this.endOf(e)<g(t)},u.year=function(){return this.$y},u.month=function(){return this.$M},u.day=function(){return this.$W},u.date=function(){return this.$D},u.hour=function(){return this.$H},u.minute=function(){return this.$m},u.second=function(){return this.$s},u.millisecond=function(){return this.$ms},u.unix=function(){return Math.floor(this.valueOf()/1e3)},u.valueOf=function(){return this.$d.getTime()},u.startOf=function(t,l){var c=this,f=!!b.isUndefined(l)||l,u=function(t,e){var n=y(new Date(c.$y,e,t),c);return f?n:n.endOf(o)},d=function(t,e){return y(c.toDate()[t].apply(c.toDate(),(f?[0,0,0,0]:[23,59,59,999]).slice(e)),c)};switch(b.prettyUnit(t)){case a:return f?u(1,0):u(31,11);case s:return f?u(1,this.$M):u(0,this.$M+1);case i:return u(f?this.$D-this.$W:this.$D+(6-this.$W),this.$M);case o:case"date":return d("setHours",0);case r:return d("setMinutes",1);case n:return d("setSeconds",2);case e:return d("setMilliseconds",3);default:return this.clone()}},u.endOf=function(t){return this.startOf(t,!1)},u.$set=function(i,l){var c,f=b.prettyUnit(i),u=(c={},c[o]="setDate",c.date="setDate",c[s]="setMonth",c[a]="setFullYear",c[r]="setHours",c[n]="setMinutes",c[e]="setSeconds",c[t]="setMilliseconds",c)[f],d=f===o?this.$D+(l-this.$W):l;return this.$d[u]&&this.$d[u](d),this.init(),this},u.set=function(t,e){return this.clone().$set(t,e)},u.add=function(t,l){var c,f=this;t=Number(t);var u=b.prettyUnit(l),d=function(e,n){var r=f.set("date",1).set(e,n+t);return r.set("date",Math.min(f.$D,r.daysInMonth()))},h=function(e){var n=new Date(f.$d);return n.setDate(n.getDate()+e*t),y(n,f)};if(u===s)return d(s,this.$M);if(u===a)return d(a,this.$y);if(u===o)return h(1);if(u===i)return h(7);var m=(c={},c[n]=6e4,c[r]=36e5,c[e]=1e3,c)[u]||1,v=this.valueOf()+t*m;return y(v,this)},u.subtract=function(t,e){return this.add(-1*t,e)},u.format=function(t){var e=this,n=t||"YYYY-MM-DDTHH:mm:ssZ",r=b.padZoneStr(this.$d.getTimezoneOffset()),o=this.$locale(),i=o.weekdays,s=o.months,a=function(t,e,n,r){return t&&t[e]||n[e].substr(0,r)},l=function(t){return 0===e.$H?12:b.padStart(e.$H<13?e.$H:e.$H-12,"hh"===t?2:1,"0")};return n.replace(c,function(t){return t.indexOf("[")>-1?t.replace(/\[|\]/g,""):{YY:String(e.$y).slice(-2),YYYY:String(e.$y),M:String(e.$M+1),MM:b.padStart(e.$M+1,2,"0"),MMM:a(o.monthsShort,e.$M,s,3),MMMM:s[e.$M],D:String(e.$D),DD:b.padStart(e.$D,2,"0"),d:String(e.$W),dd:a(o.weekdaysMin,e.$W,i,2),ddd:a(o.weekdaysShort,e.$W,i,3),dddd:i[e.$W],H:String(e.$H),HH:b.padStart(e.$H,2,"0"),h:l(t),hh:l(t),a:e.$H<12?"am":"pm",A:e.$H<12?"AM":"PM",m:String(e.$m),mm:b.padStart(e.$m,2,"0"),s:String(e.$s),ss:b.padStart(e.$s,2,"0"),SSS:b.padStart(e.$ms,3,"0"),Z:r}[t]||r.replace(":","")})},u.diff=function(t,l,c){var f,u=b.prettyUnit(l),d=g(t),h=this-d,m=b.monthDiff(this,d);return m=(f={},f[a]=m/12,f[s]=m,f.quarter=m/3,f[i]=h/6048e5,f[o]=h/864e5,f[r]=h/36e5,f[n]=h/6e4,f[e]=h/1e3,f)[u]||h,c?m:b.absFloor(m)},u.daysInMonth=function(){return this.endOf(s).$D},u.$locale=function(){return m[this.$L]},u.locale=function(t,e){var n=this.clone();return n.$L=p(t,e,!0),n},u.clone=function(){return y(this.toDate(),this)},u.toDate=function(){return new Date(this.$d)},u.toArray=function(){return[this.$y,this.$M,this.$D,this.$H,this.$m,this.$s,this.$ms]},u.toJSON=function(){return this.toISOString()},u.toISOString=function(){return this.$d.toISOString()},u.toObject=function(){return{years:this.$y,months:this.$M,date:this.$D,hours:this.$H,minutes:this.$m,seconds:this.$s,milliseconds:this.$ms}},u.toString=function(){return this.$d.toUTCString()},f}();return g.extend=function(t,e){return t(e,k,g),g},g.locale=p,g.isDayjs=v,g.unix=function(t){return g(1e3*t)},g.en=m[h],g}()},function(t,e,n){"use strict";t.exports=function(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)}},function(t,e,n){var r=n(0);t.exports=function(t){var e,n="",o=t||{};return function(t,o,i,s,a,l,c,f,u,d,h,m){n=n+'<?xml version="1.0" encoding="utf-8" ?><FictionBook'+r.attr("xmlns",t,!0,!1)+' xmlns:l="http://www.w3.org/1999/xlink"><description><title-info>',function(){var t=f;if("number"==typeof t.length)for(var o=0,i=t.length;o<i;o++){var s=t[o];n=n+"<genre>"+r.escape(null==(e=s)?"":e)+"</genre>"}else for(var o in i=0,t)i++,s=t[o],n=n+"<genre>"+r.escape(null==(e=s)?"":e)+"</genre>"}.call(this),n=n+"<author><nickname>"+r.escape(null==(e=s)?"":e)+"</nickname></author><book-title>"+r.escape(null==(e=m)?"":e)+"</book-title>",o&&(n=n+"<annotation>"+(null==(e=o)?"":e)+"</annotation>"),n+='<coverpage><image l:href="#cover"/></coverpage><lang>ru</lang>',u&&(n=n+"<src-lang>"+r.escape(null==(e=u)?"":e)+"</src-lang>"),n=n+"</title-info><document-info><author><nickname>ранобэ.рф</nickname><home-page>https://xn--80ac9aeh6f.xn--p1ai/"+r.escape(null==(e=l)?"":e)+"/                </home-page></author><program-used>"+r.escape(null==(e=d)?"":e)+"</program-used><date"+r.attr("value",h,!0,!1)+">"+r.escape(null==(e=c)?"":e)+"</date><src-url>https://xn--80ac9aeh6f.xn--p1ai/"+r.escape(null==(e=l)?"":e)+"/</src-url><id>"+r.escape(null==(e=l)?"":e)+"</id><version>1</version></document-info></description><body>"+(null==(e=a)?"":e)+"</body>",function(){var t=i;if("number"==typeof t.length)for(var o=0,s=t.length;o<s;o++){var a=t[o];n=n+"<binary"+(r.attr("id",a.id,!0,!1)+r.attr("content-type",a.mime,!0,!1))+">"+(null==(e=a.data)?"":e)+"</binary>"}else for(var o in s=0,t)s++,a=t[o],n=n+"<binary"+(r.attr("id",a.id,!0,!1)+r.attr("content-type",a.mime,!0,!1))+">"+(null==(e=a.data)?"":e)+"</binary>"}.call(this),n+="</FictionBook>"}.call(this,"NS"in o?o.NS:"undefined"!=typeof NS?NS:void 0,"annotation"in o?o.annotation:"undefined"!=typeof annotation?annotation:void 0,"attaches"in o?o.attaches:"undefined"!=typeof attaches?attaches:void 0,"author"in o?o.author:"undefined"!=typeof author?author:void 0,"body"in o?o.body:"undefined"!=typeof body?body:void 0,"bookAlias"in o?o.bookAlias:"undefined"!=typeof bookAlias?bookAlias:void 0,"fullDate"in o?o.fullDate:"undefined"!=typeof fullDate?fullDate:void 0,"genres"in o?o.genres:"undefined"!=typeof genres?genres:void 0,"lang"in o?o.lang:"undefined"!=typeof lang?lang:void 0,"programName"in o?o.programName:"undefined"!=typeof programName?programName:void 0,"shortDate"in o?o.shortDate:"undefined"!=typeof shortDate?shortDate:void 0,"title"in o?o.title:"undefined"!=typeof title?title:void 0),n}},function(t,e,n){var r=n(0);t.exports=function(t){var e,n="",o=t||{};return function(t,o){n=n+"<!DOCTYPE html><body><header><p>"+r.escape(null==(e=o)?"":e)+"</p></header>",function(){var o=t;if("number"==typeof o.length)for(var i=0,s=o.length;i<s;i++){var a=o[i];a.result.part.content&&(n=n+"<section> <header><p>"+r.escape(null==(e=a.result.part.title)?"":e)+"</p></header>"+(null==(e=a.result.part.content)?"":e)+"</section>")}else for(var i in s=0,o)s++,a=o[i],a.result.part.content&&(n=n+"<section> <header><p>"+r.escape(null==(e=a.result.part.title)?"":e)+"</p></header>"+(null==(e=a.result.part.content)?"":e)+"</section>")}.call(this),n+="</body>"}.call(this,"parts"in o?o.parts:"undefined"!=typeof parts?parts:void 0,"title"in o?o.title:"undefined"!=typeof title?title:void 0),n}},function(t,e,n){"use strict";t.exports=function(t,e){const n=t&&t.match(e);return n&&n.length>0?n[n.length-1]:null}},function(t,e,n){"use strict";const r=(t,e,n)=>new Promise((r,o)=>{if(n=Object.assign({concurrency:1/0},n),"function"!=typeof e)throw new TypeError("Mapper function is required");const{concurrency:i}=n;if(!("number"==typeof i&&i>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${i}\` (${typeof i})`);const s=[],a=t[Symbol.iterator]();let l=!1,c=!1,f=0,u=0;const d=()=>{if(l)return;const t=a.next(),n=u;if(u++,t.done)return c=!0,void(0===f&&r(s));f++,Promise.resolve(t.value).then(t=>e(t,n)).then(t=>{s[n]=t,f--,d()},t=>{l=!0,o(t)})};for(let t=0;t<i&&(d(),!c);t++);});t.exports=r,t.exports.default=r},function(t,e){window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(t,e){e=e||window;for(var n=0;n<this.length;n++)t.call(e,this[n],n,this)})},function(t,e){},function(t,e,n){"use strict";function r(){}function o(t,e){for(var n in e)t[n]=e[n];return t}function i(t,e){t.appendChild(e)}function s(t,e,n){t.insertBefore(e,n)}function a(t){t.parentNode.removeChild(t)}function l(t){return document.createElement(t)}function c(t){return document.createTextNode(t)}n.r(e);function f(){return Object.create(null)}function u(t){this.destroy=r,this.fire("destroy"),this.set=r,this._fragment.d(!1!==t),this._fragment=null,this._state={}}function d(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function h(t,e){var n=t in this._handlers&&this._handlers[t].slice();if(n)for(var r=0;r<n.length;r+=1){var o=n[r];if(!o.__calling)try{o.__calling=!0,o.call(this,e)}finally{o.__calling=!1}}}function m(t){t._lock=!0,k(t._beforecreate),k(t._oncreate),k(t._aftercreate),t._lock=!1}function v(){return this._state}function p(t,e){var n=this._handlers[t]||(this._handlers[t]=[]);return n.push(e),{cancel:function(){var t=n.indexOf(e);~t&&n.splice(t,1)}}}function g(t){this._set(o({},t)),this.root._lock||m(this.root)}function y(t){var e=this._state,n={},r=!1;for(var i in t=o(this._staged,t),this._staged={},t)this._differs(t[i],e[i])&&(n[i]=r=!0);r&&(this._state=o(o({},e),t),this._recompute(n,this._state),this._bind&&this._bind(n,this._state),this._fragment&&(this.fire("state",{changed:n,current:this._state,previous:e}),this._fragment.p(n,this._state),this.fire("update",{changed:n,current:this._state,previous:e})))}function b(t){o(this._staged,t)}function k(t){for(;t&&t.length;)t.shift()()}function w(t,e){this._fragment[this._fragment.i?"i":"m"](t,e||null)}var _={destroy:u,get:v,fire:h,on:p,set:g,_recompute:r,_set:y,_stage:b,_mount:w,_differs:d},$=(n(8),n(1)),S=n.n($),M="undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().indexOf("firefox")>0;function x(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent&&t.attachEvent("on"+e,function(){n(window.event)})}function O(t,e){for(var n=e.slice(0,e.length-1),r=0;r<n.length;r++)n[r]=t[n[r].toLowerCase()];return n}function D(t){t||(t=""),t=t.replace(/\s/g,"");for(var e=t.split(","),n=e.lastIndexOf("");n>=0;)e[n-1]+=",",e.splice(n,1),n=e.lastIndexOf("");return e}function E(t,e){for(var n=t.length>=e.length?t:e,r=t.length>=e.length?e:t,o=!0,i=0;i<n.length;i++)-1===r.indexOf(n[i])&&(o=!1);return o}for(var A={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,"⇪":20,",":188,".":190,"/":191,"`":192,"-":M?173:189,"=":M?61:187,";":M?59:186,"'":222,"[":219,"]":221,"\\":220},j={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":M?224:91,cmd:M?224:91,command:M?224:91},C=[],L={16:"shiftKey",18:"altKey",17:"ctrlKey"},N={16:!1,18:!1,17:!1},T={},H=1;H<20;H++)A["f"+H]=111+H;L[M?224:91]="metaKey",N[M?224:91]=!1;var P="all",Y=!1,U=function(t){return A[t.toLowerCase()]||j[t.toLowerCase()]||t.toUpperCase().charCodeAt(0)};function B(t){P=t||"all"}function R(){return P||"all"}function q(t,e,n){var r=void 0;if(e.scope===n||"all"===e.scope){for(var o in r=e.mods.length>0,N)Object.prototype.hasOwnProperty.call(N,o)&&(!N[o]&&e.mods.indexOf(+o)>-1||N[o]&&-1===e.mods.indexOf(+o))&&(r=!1);(0!==e.mods.length||N[16]||N[18]||N[17]||N[91])&&!r&&"*"!==e.shortcut||!1===e.method(t,e)&&(t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.cancelBubble&&(t.cancelBubble=!0))}}function F(t,e,n){var r=D(t),o=[],i="all",s=document,a=0;for(void 0===n&&"function"==typeof e&&(n=e),"[object Object]"===Object.prototype.toString.call(e)&&(e.scope&&(i=e.scope),e.element&&(s=e.element)),"string"==typeof e&&(i=e);a<r.length;a++)t=r[a].split("+"),o=[],t.length>1&&(o=O(j,t)),t=t[t.length-1],t="*"===t?"*":U(t),t in T||(T[t]=[]),T[t].push({scope:i,mods:o,shortcut:r[a],method:n,key:r[a]});void 0===s||Y||(Y=!0,x(s,"keydown",function(t){!function(t){var e=T["*"],n=t.keyCode||t.which||t.charCode;if(-1===C.indexOf(n)&&C.push(n),93!==n&&224!==n||(n=91),n in N){for(var r in N[n]=!0,j)j[r]===n&&(F[r]=!0);if(!e)return}for(var o in N)Object.prototype.hasOwnProperty.call(N,o)&&(N[o]=t[L[o]]);if(F.filter.call(this,t)){var i=R();if(e)for(var s=0;s<e.length;s++)e[s].scope===i&&q(t,e[s],i);if(n in T)for(var a=0;a<T[n].length;a++)q(t,T[n][a],i)}}(t)}),x(s,"keyup",function(t){!function(t){var e=t.keyCode||t.which||t.charCode,n=C.indexOf(e);if(n>=0&&C.splice(n,1),93!==e&&224!==e||(e=91),e in N)for(var r in N[e]=!1,j)j[r]===e&&(F[r]=!1)}(t)}))}var I={setScope:B,getScope:R,deleteScope:function(t,e){var n=void 0,r=void 0;for(var o in t||(t=R()),T)if(Object.prototype.hasOwnProperty.call(T,o))for(n=T[o],r=0;r<n.length;)n[r].scope===t?n.splice(r,1):r++;R()===t&&B(e||"all")},getPressedKeyCodes:function(){return C.slice(0)},isPressed:function(t){return"string"==typeof t&&(t=U(t)),-1!==C.indexOf(t)},filter:function(t){var e=t.target||t.srcElement,n=e.tagName;return!("INPUT"===n||"SELECT"===n||"TEXTAREA"===n||e.isContentEditable)},unbind:function(t,e,n){var r=D(t),o=void 0,i=[],s=void 0;"function"==typeof e&&(n=e,e="all");for(var a=0;a<r.length;a++){if(o=r[a].split("+"),o.length>1&&(i=O(j,o)),t=o[o.length-1],t="*"===t?"*":U(t),e||(e=R()),!T[t])return;for(var l=0;l<T[t].length;l++){if(s=T[t][l],n&&s.method!==n)return;s.scope===e&&E(s.mods,i)&&(T[t][l]={})}}}};for(var W in I)Object.prototype.hasOwnProperty.call(I,W)&&(F[W]=I[W]);if("undefined"!=typeof window){var J=window.hotkeys;F.noConflict=function(t){return t&&window.hotkeys===F&&(window.hotkeys=J),F},window.hotkeys=F}var X=F,Z=n(2),z=n.n(Z),K=n(3),G=n(4),V=n(5),Q=n(6),tt=n(7);const et=function(t){const e=function(e){return t[e]},n="(?:"+Object.keys(t).join("|")+")",r=RegExp(n),o=RegExp(n,"g");return function(t){return t=null==t?"":""+t,r.test(t)?t.replace(o,e):t}}({"&quot;":'"',"&quote;":'"',"&#x27;":"'","&#39;":"'","&apos;":"'","&#x60;":"`","&nbsp;":" ","&#95;":"_","&#34;":'"'}),nt="http://www.gribuser.ru/xml/fictionbook/2.0",rt={"Боевик":"det_action","Боевые Искусства":"fantasy_fight","Вампиры":"vampire_book","Виртуальный Мир":"sf","Героическое Фэнтези":"sf_heroic","Детектив":"detective","Дзёсэй":"sf_action","Драма":"dramaturgy","Игра":"sf","История":"sci_history","Комедия":"humor","Меха":"sf","Мистика":"sf_horror","Научная Фантастика":"sf","Приключения":"adventure","Психология":"sci_psychology","Сверхъестественное":"sf_horror","Сёнэн":"sf_action","Спорт":"home_sport","Сэйнэн":"sf_action","сянься":"sf_fantasy","Триллер":"thriller","Ужасы":"sf_horror","Фантастика":"sf","Фэнтези":"sf_fantasy","Школьная Жизнь":"children","Экшн":"sf_action","Этти":"love_erotica",Adult:"home_sex",Josei:"sf_action",Shounen:"sf_action",Xianxia:"sf_fantasy",Xuanhuan:"sf_fantasy"};async function ot(t,e){return(await fetch(`https://xn--80ac9aeh6f.xn--p1ai/v1/${t}/get/?`+Object.keys(e).map(t=>`${t}=${e[t]}`).join("&"),{credentials:"include"})).json()}const it=ot.bind(null,"book"),st=ot.bind(null,"part");function at(t,e){return{mime:Q(t.split(",",1)[0],/data:(.+);base64/)||e,data:t.slice(t.indexOf(",")+1)}}async function lt(t){if(/data:(.+);base64/.test(t))return at(t);{const r=await fetch(t);return e=await r.blob(),n=r.headers.get("content-type"),new Promise((t,r)=>{var o=new FileReader;o.onloadend=function(e){try{2==o.readyState?t(at(o.result,n)):r(o.error)}catch(t){r(t)}},o.readAsDataURL(e)})}var e,n}function ct(t,e){const n=(new DOMParser).parseFromString(t,e),r=n.querySelector("parsererror");if(r)throw r.textContent;return n}function ft(t,e){return Promise.all(t.map(({url:t})=>st({bookAlias:e,partAlias:function(t){return t[t.length-1]}(t.split("/").filter(t=>t))})))}function ut(t,e,n){const r=t.createElement(n);for(;e.firstChild;)r.appendChild(e.firstChild);e.parentNode.replaceChild(r,e)}function dt(t,e){t=t.replace(/>(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g,">").replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+<\//g,"</").replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g,"</p><p>");const n=ct(t,"text/html");let r;for(n.querySelectorAll("i,em").forEach(t=>{ut(n,t,"emphasis")}),n.querySelectorAll("b").forEach(t=>{ut(n,t,"strong")}),n.querySelectorAll("s,strike").forEach(t=>{ut(n,t,"strikethrough")}),n.querySelectorAll("div").forEach(t=>{ut(n,t,"p")}),n.querySelectorAll("img").forEach(t=>{const r="_"+K();e.push({src:t.src,id:r});const o=n.createElement("image");o.setAttribute("l:href","#"+r),t.parentNode.replaceChild(o,t)}),n.querySelectorAll("body :not(section):not(emphasis):not(code):not(header):not(strong):not(strikethrough):not(p):not(empty-line):not(sub):not(sup):not(image)").forEach(t=>{ut(n,t,"code")});(r=n.querySelectorAll("p > p"))&&r.length>0;)r.forEach(t=>{for(;t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);t.parentNode.removeChild(t)});return n.querySelectorAll("body :not(image)").forEach(t=>{t.attributes.length>0&&Array.from(t.attributes).forEach(e=>t.removeAttribute(e.name))}),et(n.body.innerHTML).replace(/><\/image>/g,"/>").replace(/(\s*<code>\s*<\/code>\s*)+/g," ").replace(/(\s*<p>\s*<\/p>\s*)+/g," ")}var ht={async load(){try{this.set({loading:!0,error:null});const t=location.pathname.split("/",2).filter(t=>t)[0],{result:e}=await it({bookAlias:t}),{book:n,genres:r,parts:o}=e,i=z()(n.publishedAt),s=new Set(r.map(t=>rt[t.title]));s.delete(void 0),s.size<1&&s.add("unrecognised");const{mime:a,data:l}=await lt(n.image.desktop.image),c=10,f=[];for(let e of function*(t,e){if(t.length>0)if(e>0&&t.length>e){const n=Math.ceil(t.length/e),r=Math.ceil(t.length/n);let o=[];for(let e of t)o.length<r?o.push(e):(yield o,o=[e]);o.length&&(yield o)}else yield t}(o.reverse(),c)){try{f.push(...await ft(e,t))}catch(n){f.push(...await ft(e,t))}this.set({percent:100*f.length/o.length|0})}const u=[],d=dt(V({title:n.title,parts:f}),u),h=dt(n.description,u),m=ct(G({NS:nt,genres:Array.from(s),title:n.title,annotation:h,author:n.author,programName:"ranobe-rf-fb2-loader",bookAlias:t,shortDate:i.format("YYYY-MM-DD"),fullDate:i.format("DD.MM.YYYY"),body:d,attaches:[{data:l,mime:a,id:"cover"},...await tt(u,async t=>Object.assign(t,await lt(t.src)),{concurrency:c})]}),"application/xml");m.querySelectorAll("header").forEach(t=>{const e=m.createElementNS(nt,"title");for(;t.firstChild;)e.appendChild(t.firstChild);t.parentNode.replaceChild(e,t)}),S()(new Blob(['<?xml version="1.0" encoding="utf-8" ?>'+m.documentElement.outerHTML],{type:"text/xml;charset=utf-8"}),t+".fb2")}catch(t){console.error(t),alert("Ошибка загрузки. Попробуйте снова.")}finally{this.set({loading:!1,percent:0})}}};function mt(t,e){var n,r,o,f,u;return{c(){n=l("div"),r=l("div"),r.innerHTML='<div class="sk-circle1 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle2 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle3 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle4 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle5 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle6 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle7 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle8 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle9 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle10 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle11 sk-child svelte-ffmv3n"></div>\n\t\t\t\t\t\t<div class="sk-circle12 sk-child svelte-ffmv3n"></div>',o=c("\n\t\t"),f=c(e.percent),u=c("%"),r.className="sk-circle svelte-ffmv3n",n.className="rg-loader-bg svelte-ffmv3n"},m(t,e){s(t,n,e),i(n,r),i(n,o),i(n,f),i(n,u)},p(t,e){var n,r;t.percent&&(n=f,r=e.percent,n.data=""+r)},d(t){t&&a(n)}}}function vt(t,e){return{c:r,m:r,d:r}}function pt(t){var e,n,r,u,d,h;!function(t,e){t._handlers=f(),t._slots=f(),t._bind=e._bind,t._staged={},t.options=e,t.root=e.root||t,t.store=e.store||t.root.store,e.root||(t._beforecreate=[],t._oncreate=[],t._aftercreate=[])}(this,t),this._state=o({loading:!1,percent:0,error:null},t.data),this._intro=!0,document.getElementById("svelte-ffmv3n-style")||(e=l("style"),e.id="svelte-ffmv3n-style",e.textContent=".sk-circle.svelte-ffmv3n{margin:auto;top:0;bottom:0;left:0;right:0;position:absolute;pointer-events:none}.sk-circle.svelte-ffmv3n{width:100px;height:100px}.sk-circle.svelte-ffmv3n .sk-child.svelte-ffmv3n{width:100%;height:100%;position:absolute;left:0;top:0}.sk-circle.svelte-ffmv3n .sk-child.svelte-ffmv3n:before{content:'';display:block;margin:0 auto;width:15%;height:15%;background-color:#303745;border-radius:100%;-webkit-animation:svelte-ffmv3n-sk-circleBounceDelay 1.2s infinite ease-in-out both;animation:svelte-ffmv3n-sk-circleBounceDelay 1.2s infinite ease-in-out both}.sk-circle.svelte-ffmv3n .sk-circle2.svelte-ffmv3n{-webkit-transform:rotate(30deg);-ms-transform:rotate(30deg);transform:rotate(30deg)}.sk-circle.svelte-ffmv3n .sk-circle3.svelte-ffmv3n{-webkit-transform:rotate(60deg);-ms-transform:rotate(60deg);transform:rotate(60deg)}.sk-circle.svelte-ffmv3n .sk-circle4.svelte-ffmv3n{-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg)}.sk-circle.svelte-ffmv3n .sk-circle5.svelte-ffmv3n{-webkit-transform:rotate(120deg);-ms-transform:rotate(120deg);transform:rotate(120deg)}.sk-circle.svelte-ffmv3n .sk-circle6.svelte-ffmv3n{-webkit-transform:rotate(150deg);-ms-transform:rotate(150deg);transform:rotate(150deg)}.sk-circle.svelte-ffmv3n .sk-circle7.svelte-ffmv3n{-webkit-transform:rotate(180deg);-ms-transform:rotate(180deg);transform:rotate(180deg)}.sk-circle.svelte-ffmv3n .sk-circle8.svelte-ffmv3n{-webkit-transform:rotate(210deg);-ms-transform:rotate(210deg);transform:rotate(210deg)}.sk-circle.svelte-ffmv3n .sk-circle9.svelte-ffmv3n{-webkit-transform:rotate(240deg);-ms-transform:rotate(240deg);transform:rotate(240deg)}.sk-circle.svelte-ffmv3n .sk-circle10.svelte-ffmv3n{-webkit-transform:rotate(270deg);-ms-transform:rotate(270deg);transform:rotate(270deg)}.sk-circle.svelte-ffmv3n .sk-circle11.svelte-ffmv3n{-webkit-transform:rotate(300deg);-ms-transform:rotate(300deg);transform:rotate(300deg)}.sk-circle.svelte-ffmv3n .sk-circle12.svelte-ffmv3n{-webkit-transform:rotate(330deg);-ms-transform:rotate(330deg);transform:rotate(330deg)}.sk-circle.svelte-ffmv3n .sk-circle2.svelte-ffmv3n:before{-webkit-animation-delay:-1.1s;animation-delay:-1.1s}.sk-circle.svelte-ffmv3n .sk-circle3.svelte-ffmv3n:before{-webkit-animation-delay:-1s;animation-delay:-1s}.sk-circle.svelte-ffmv3n .sk-circle4.svelte-ffmv3n:before{-webkit-animation-delay:-0.9s;animation-delay:-0.9s}.sk-circle.svelte-ffmv3n .sk-circle5.svelte-ffmv3n:before{-webkit-animation-delay:-0.8s;animation-delay:-0.8s}.sk-circle.svelte-ffmv3n .sk-circle6.svelte-ffmv3n:before{-webkit-animation-delay:-0.7s;animation-delay:-0.7s}.sk-circle.svelte-ffmv3n .sk-circle7.svelte-ffmv3n:before{-webkit-animation-delay:-0.6s;animation-delay:-0.6s}.sk-circle.svelte-ffmv3n .sk-circle8.svelte-ffmv3n:before{-webkit-animation-delay:-0.5s;animation-delay:-0.5s}.sk-circle.svelte-ffmv3n .sk-circle9.svelte-ffmv3n:before{-webkit-animation-delay:-0.4s;animation-delay:-0.4s}.sk-circle.svelte-ffmv3n .sk-circle10.svelte-ffmv3n:before{-webkit-animation-delay:-0.3s;animation-delay:-0.3s}.sk-circle.svelte-ffmv3n .sk-circle11.svelte-ffmv3n:before{-webkit-animation-delay:-0.2s;animation-delay:-0.2s}.sk-circle.svelte-ffmv3n .sk-circle12.svelte-ffmv3n:before{-webkit-animation-delay:-0.1s;animation-delay:-0.1s}@-webkit-keyframes svelte-ffmv3n-sk-circleBounceDelay{0%,80%,100%{-webkit-transform:scale(0);transform:scale(0)}40%{-webkit-transform:scale(1);transform:scale(1)}}@keyframes svelte-ffmv3n-sk-circleBounceDelay{0%,80%,100%{-webkit-transform:scale(0);transform:scale(0)}40%{-webkit-transform:scale(1);transform:scale(1)}}.rg-loader-bg.svelte-ffmv3n{background:rgba(255, 255, 255, 0.8);width:100vw;height:100vh;line-height:100vh;display:block;position:fixed;top:0;left:0;text-align:center;font-size:16px;color:#303745;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none}",i(document.head,e)),this._fragment=(n=this._state,d=n.loading&&mt(0,n),h=n.error&&vt(),{c(){r=l("div"),d&&d.c(),u=c("\n\t"),h&&h.c()},m(t,e){s(t,r,e),d&&d.m(r,null),i(r,u),h&&h.m(r,null)},p(t,e){e.loading?d?d.p(t,e):(d=mt(0,e),d.c(),d.m(r,u)):d&&(d.d(1),d=null),e.error?h||(h=vt(),h.c(),h.m(r,null)):h&&(h.d(1),h=null)},d(t){t&&a(r),d&&d.d(),h&&h.d()}}),this.root._oncreate.push(()=>{(function(){X("ctrl+s",(t,e)=>{t.preventDefault();const{loading:n}=this.get();n||this.load()})}).call(this),this.fire("update",{changed:function(t,e){for(var n in e)t[n]=1;return t}({},this._state),current:this._state})}),t.target&&(this._fragment.c(),this._mount(t.target,t.anchor),m(this))}o(pt.prototype,_),o(pt.prototype,ht);var gt=pt,yt=["interactive","complete"],bt=function(t,e){return new Promise(function(n){t&&"function"!=typeof t&&(e=t,t=null),e=e||window.document;var r=function(){return n(void(t&&setTimeout(t)))};-1!==yt.indexOf(e.readyState)?r():e.addEventListener("DOMContentLoaded",r)})};bt.resume=function(t){return function(e){return bt(t).then(function(){return e})}};var kt=bt;kt(()=>{const t=document.createElement("div");t.style.zIndex="16777270",t.style.position="fixed",t.style.top="0",t.style.left="0",document.body.appendChild(t),new gt({target:t})})}]);