// ==UserScript==
// @name         ranobe-rf-fb2-loader
// @namespace    taraflex
// @version      0.0.11
// @description  Юзерскрипт для скачивания книг в формате fb2 c https://ранобэ.рф/
// @author       taraflex.red@gmail.com
// @downloadURL  https://raw.githubusercontent.com/Taraflex/ranobe-rf-fb2-loader/master/build/ranobe-rf-fb2-loader.user.js
// @updateURL    https://raw.githubusercontent.com/Taraflex/ranobe-rf-fb2-loader/master/build/ranobe-rf-fb2-loader.user.js
// @match        https://xn--80ac9aeh6f.xn--p1ai/*
// ==/UserScript==
!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t,n){const r=(e,t,n)=>new Promise((r,o)=>{if(n=Object.assign({concurrency:1/0},n),"function"!=typeof t)throw new TypeError("Mapper function is required");const{concurrency:i}=n;if(!("number"==typeof i&&i>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${i}\` (${typeof i})`);const a=[],s=e[Symbol.iterator]();let c=!1,l=!1,u=0,f=0;const d=()=>{if(c)return;const e=s.next(),n=f;if(f++,e.done)return l=!0,void(0===u&&r(a));u++,Promise.resolve(e.value).then(e=>t(e,n)).then(e=>{a[n]=e,u--,d()},e=>{c=!0,o(e)})};for(let e=0;e<i&&(d(),!l);e++);});e.exports=r,e.exports.default=r},function(e,t,n){var r=Object.prototype.hasOwnProperty;function o(e,t){return Array.isArray(e)?function(e,t){for(var n,r="",i="",a=Array.isArray(t),s=0;s<e.length;s++)(n=o(e[s]))&&(a&&t[s]&&(n=c(n)),r=r+i+n,i=" ");return r}(e,t):e&&"object"==typeof e?function(e){var t="",n="";for(var o in e)o&&e[o]&&r.call(e,o)&&(t=t+n+o,n=" ");return t}(e):e||""}function i(e){if(!e)return"";if("object"==typeof e){var t="";for(var n in e)r.call(e,n)&&(t=t+n+":"+e[n]+";");return t}return e+""}function a(e,t,n,r){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(r?e:e+'="'+e+'"');var o=typeof t;return"object"!==o&&"function"!==o||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),n||-1===t.indexOf('"'))?(n&&(t=c(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}t.merge=function e(t,n){if(1===arguments.length){for(var r=t[0],o=1;o<t.length;o++)r=e(r,t[o]);return r}for(var a in n)if("class"===a){var s=t[a]||[];t[a]=(Array.isArray(s)?s:[s]).concat(n[a]||[])}else if("style"===a){s=(s=i(t[a]))&&";"!==s[s.length-1]?s+";":s;var c=i(n[a]);c=c&&";"!==c[c.length-1]?c+";":c,t[a]=s+c}else t[a]=n[a];return t},t.classes=o,t.style=i,t.attr=a,t.attrs=function(e,t){var n="";for(var s in e)if(r.call(e,s)){var c=e[s];if("class"===s){n=a(s,c=o(c),!1,t)+n;continue}"style"===s&&(c=i(c)),n+=a(s,c,!1,t)}return n};var s=/["&<>]/;function c(e){var t=""+e,n=s.exec(t);if(!n)return e;var r,o,i,a="";for(r=n.index,o=0;r<t.length;r++){switch(t.charCodeAt(r)){case 34:i="&quot;";break;case 38:i="&amp;";break;case 60:i="&lt;";break;case 62:i="&gt;";break;default:continue}o!==r&&(a+=t.substring(o,r)),o=r+1,a+=i}return o!==r?a+t.substring(o,r):a}t.escape=c,t.rethrow=function e(t,r,o,i){if(!(t instanceof Error))throw t;if(!("undefined"==typeof window&&r||i))throw t.message+=" on line "+o,t;try{i=i||n(8).readFileSync(r,"utf8")}catch(n){e(t,null,o)}var a=3,s=i.split("\n"),c=Math.max(o-a,0),l=Math.min(s.length,o+a);throw a=s.slice(c,l).map((function(e,t){var n=t+c+1;return(n==o?"  > ":"    ")+n+"| "+e})).join("\n"),t.path=r,t.message=(r||"Pug")+":"+o+"\n"+a+"\n\n"+t.message,t}},function(e,t,n){var r,o;void 0===(o="function"==typeof(r=function(){function t(e,t,n){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="blob",r.onload=function(){i(r.response,t,n)},r.onerror=function(){console.error("could not download file")},r.send()}function n(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function r(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(n){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var o="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0,i=o.saveAs||("object"!=typeof window||window!==o?function(){}:"download"in HTMLAnchorElement.prototype?function(e,i,a){var s=o.URL||o.webkitURL,c=document.createElement("a");i=i||e.name||"download",c.download=i,c.rel="noopener","string"==typeof e?(c.href=e,c.origin===location.origin?r(c):n(c.href)?t(e,i,a):r(c,c.target="_blank")):(c.href=s.createObjectURL(e),setTimeout((function(){s.revokeObjectURL(c.href)}),4e4),setTimeout((function(){r(c)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,o,i){if(o=o||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(function(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}(e,i),o);else if(n(e))t(e,o,i);else{var a=document.createElement("a");a.href=e,a.target="_blank",setTimeout((function(){r(a)}))}}:function(e,n,r,i){if((i=i||open("","_blank"))&&(i.document.title=i.document.body.innerText="downloading..."),"string"==typeof e)return t(e,n,r);var a="application/octet-stream"===e.type,s=/constructor/i.test(o.HTMLElement)||o.safari,c=/CriOS\/[\d]+/.test(navigator.userAgent);if((c||a&&s)&&"object"==typeof FileReader){var l=new FileReader;l.onloadend=function(){var e=l.result;e=c?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),i?i.location.href=e:location=e,i=null},l.readAsDataURL(e)}else{var u=o.URL||o.webkitURL,f=u.createObjectURL(e);i?i.location=f:location.href=f,i=null,setTimeout((function(){u.revokeObjectURL(f)}),4e4)}});o.saveAs=i.saveAs=i,e.exports=i})?r.apply(t,[]):r)||(e.exports=o)},function(e,t,n){e.exports=function(){var e="millisecond",t="second",n="minute",r="hour",o="day",i="week",a="month",s="quarter",c="year",l=/^(\d{4})-?(\d{1,2})-?(\d{0,2})[^0-9]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?.?(\d{1,3})?$/,u=/\[([^\]]+)]|Y{2,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,f=function(e,t,n){var r=String(e);return!r||r.length>=t?e:""+Array(t+1-r.length).join(n)+e},d={s:f,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),r=Math.floor(n/60),o=n%60;return(t<=0?"+":"-")+f(r,2,"0")+":"+f(o,2,"0")},m:function(e,t){var n=12*(t.year()-e.year())+(t.month()-e.month()),r=e.clone().add(n,a),o=t-r<0,i=e.clone().add(n+(o?-1:1),a);return Number(-(n+(t-r)/(o?r-i:i-r))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(l){return{M:a,y:c,w:i,d:o,h:r,m:n,s:t,ms:e,Q:s}[l]||String(l||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},h={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},y="en",p={};p[y]=h;var v=function(e){return e instanceof k},m=function(e,t,n){var r;if(!e)return y;if("string"==typeof e)p[e]&&(r=e),t&&(p[e]=t,r=e);else{var o=e.name;p[o]=e,r=o}return n||(y=r),r},g=function(e,t,n){if(v(e))return e.clone();var r=t?"string"==typeof t?{format:t,pl:n}:t:{};return r.date=e,new k(r)},b=d;b.l=m,b.i=v,b.w=function(e,t){return g(e,{locale:t.$L,utc:t.$u})};var k=function(){function f(e){this.$L=this.$L||m(e.locale,null,!0),this.parse(e)}var d=f.prototype;return d.parse=function(e){this.$d=function(e){var t=e.date,n=e.utc;if(null===t)return new Date(NaN);if(b.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var r=t.match(l);if(r)return n?new Date(Date.UTC(r[1],r[2]-1,r[3]||1,r[4]||0,r[5]||0,r[6]||0,r[7]||0)):new Date(r[1],r[2]-1,r[3]||1,r[4]||0,r[5]||0,r[6]||0,r[7]||0)}return new Date(t)}(e),this.init()},d.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},d.$utils=function(){return b},d.isValid=function(){return!("Invalid Date"===this.$d.toString())},d.isSame=function(e,t){var n=g(e);return this.startOf(t)<=n&&n<=this.endOf(t)},d.isAfter=function(e,t){return g(e)<this.startOf(t)},d.isBefore=function(e,t){return this.endOf(t)<g(e)},d.$g=function(e,t,n){return b.u(e)?this[t]:this.set(n,e)},d.year=function(e){return this.$g(e,"$y",c)},d.month=function(e){return this.$g(e,"$M",a)},d.day=function(e){return this.$g(e,"$W",o)},d.date=function(e){return this.$g(e,"$D","date")},d.hour=function(e){return this.$g(e,"$H",r)},d.minute=function(e){return this.$g(e,"$m",n)},d.second=function(e){return this.$g(e,"$s",t)},d.millisecond=function(t){return this.$g(t,"$ms",e)},d.unix=function(){return Math.floor(this.valueOf()/1e3)},d.valueOf=function(){return this.$d.getTime()},d.startOf=function(e,s){var l=this,u=!!b.u(s)||s,f=b.p(e),d=function(e,t){var n=b.w(l.$u?Date.UTC(l.$y,t,e):new Date(l.$y,t,e),l);return u?n:n.endOf(o)},h=function(e,t){return b.w(l.toDate()[e].apply(l.toDate(),(u?[0,0,0,0]:[23,59,59,999]).slice(t)),l)},y=this.$W,p=this.$M,v=this.$D,m="set"+(this.$u?"UTC":"");switch(f){case c:return u?d(1,0):d(31,11);case a:return u?d(1,p):d(0,p+1);case i:var g=this.$locale().weekStart||0,k=(y<g?y+7:y)-g;return d(u?v-k:v+(6-k),p);case o:case"date":return h(m+"Hours",0);case r:return h(m+"Minutes",1);case n:return h(m+"Seconds",2);case t:return h(m+"Milliseconds",3);default:return this.clone()}},d.endOf=function(e){return this.startOf(e,!1)},d.$set=function(i,s){var l,u=b.p(i),f="set"+(this.$u?"UTC":""),d=(l={},l[o]=f+"Date",l.date=f+"Date",l[a]=f+"Month",l[c]=f+"FullYear",l[r]=f+"Hours",l[n]=f+"Minutes",l[t]=f+"Seconds",l[e]=f+"Milliseconds",l)[u],h=u===o?this.$D+(s-this.$W):s;if(u===a||u===c){var y=this.clone().set("date",1);y.$d[d](h),y.init(),this.$d=y.set("date",Math.min(this.$D,y.daysInMonth())).toDate()}else d&&this.$d[d](h);return this.init(),this},d.set=function(e,t){return this.clone().$set(e,t)},d.get=function(e){return this[b.p(e)]()},d.add=function(e,s){var l,u=this;e=Number(e);var f=b.p(s),d=function(t){var n=g(u);return b.w(n.date(n.date()+Math.round(t*e)),u)};if(f===a)return this.set(a,this.$M+e);if(f===c)return this.set(c,this.$y+e);if(f===o)return d(1);if(f===i)return d(7);var h=(l={},l[n]=6e4,l[r]=36e5,l[t]=1e3,l)[f]||1,y=this.valueOf()+e*h;return b.w(y,this)},d.subtract=function(e,t){return this.add(-1*e,t)},d.format=function(e){var t=this;if(!this.isValid())return"Invalid Date";var n=e||"YYYY-MM-DDTHH:mm:ssZ",r=b.z(this),o=this.$locale(),i=this.$H,a=this.$m,s=this.$M,c=o.weekdays,l=o.months,f=function(e,r,o,i){return e&&(e[r]||e(t,n))||o[r].substr(0,i)},d=function(e){return b.s(i%12||12,e,"0")},h=o.meridiem||function(e,t,n){var r=e<12?"AM":"PM";return n?r.toLowerCase():r},y={YY:String(this.$y).slice(-2),YYYY:this.$y,M:s+1,MM:b.s(s+1,2,"0"),MMM:f(o.monthsShort,s,l,3),MMMM:l[s]||l(this,n),D:this.$D,DD:b.s(this.$D,2,"0"),d:String(this.$W),dd:f(o.weekdaysMin,this.$W,c,2),ddd:f(o.weekdaysShort,this.$W,c,3),dddd:c[this.$W],H:String(i),HH:b.s(i,2,"0"),h:d(1),hh:d(2),a:h(i,a,!0),A:h(i,a,!1),m:String(a),mm:b.s(a,2,"0"),s:String(this.$s),ss:b.s(this.$s,2,"0"),SSS:b.s(this.$ms,3,"0"),Z:r};return n.replace(u,(function(e,t){return t||y[e]||r.replace(":","")}))},d.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},d.diff=function(e,l,u){var f,d=b.p(l),h=g(e),y=6e4*(h.utcOffset()-this.utcOffset()),p=this-h,v=b.m(this,h);return v=(f={},f[c]=v/12,f[a]=v,f[s]=v/3,f[i]=(p-y)/6048e5,f[o]=(p-y)/864e5,f[r]=p/36e5,f[n]=p/6e4,f[t]=p/1e3,f)[d]||p,u?v:b.a(v)},d.daysInMonth=function(){return this.endOf(a).$D},d.$locale=function(){return p[this.$L]},d.locale=function(e,t){if(!e)return this.$L;var n=this.clone();return n.$L=m(e,t,!0),n},d.clone=function(){return b.w(this.toDate(),this)},d.toDate=function(){return new Date(this.$d)},d.toJSON=function(){return this.isValid()?this.toISOString():null},d.toISOString=function(){return this.$d.toISOString()},d.toString=function(){return this.$d.toUTCString()},f}();return g.prototype=k.prototype,g.extend=function(e,t){return e(t,k,g),g},g.locale=m,g.isDayjs=v,g.unix=function(e){return g(1e3*e)},g.en=p[y],g.Ls=p,g}()},function(e,t,n){var r=n(1);e.exports=function(e){var t,n="",o=e||{};return function(e,o,i,a,s,c,l,u,f,d,h,y){n=n+'<?xml version="1.0" encoding="utf-8" ?><FictionBook'+r.attr("xmlns",e,!0,!1)+' xmlns:l="http://www.w3.org/1999/xlink"><description><title-info>',function(){var e=u;if("number"==typeof e.length)for(var o=0,i=e.length;o<i;o++){var a=e[o];n=n+"<genre>"+r.escape(null==(t=a)?"":t)+"</genre>"}else for(var o in i=0,e)i++,a=e[o],n=n+"<genre>"+r.escape(null==(t=a)?"":t)+"</genre>"}.call(this),n=n+"<author><nickname>"+r.escape(null==(t=a)?"":t)+"</nickname></author><book-title>"+r.escape(null==(t=y)?"":t)+"</book-title>",o&&(n=n+"<annotation>"+(null==(t=o)?"":t)+"</annotation>"),n+='<coverpage><image l:href="#cover"/></coverpage><lang>ru</lang>',f&&(n=n+"<src-lang>"+r.escape(null==(t=f)?"":t)+"</src-lang>"),n=n+"</title-info><document-info><author><nickname>ранобэ.рф</nickname><home-page>https://xn--80ac9aeh6f.xn--p1ai/"+r.escape(null==(t=c)?"":t)+"/</home-page></author><program-used>"+r.escape(null==(t=d)?"":t)+"</program-used><date"+r.attr("value",h,!0,!1)+">"+r.escape(null==(t=l)?"":t)+"</date><src-url>https://xn--80ac9aeh6f.xn--p1ai/"+r.escape(null==(t=c)?"":t)+"/</src-url><id>"+r.escape(null==(t=c)?"":t)+"</id><version>1</version></document-info></description><body>"+(null==(t=s)?"":t)+"</body>",function(){var e=i;if("number"==typeof e.length)for(var o=0,a=e.length;o<a;o++){var s=e[o];n=n+"<binary"+(r.attr("id",s.id,!0,!1)+r.attr("content-type",s.mime,!0,!1))+">"+(null==(t=s.data)?"":t)+"</binary>"}else for(var o in a=0,e)a++,s=e[o],n=n+"<binary"+(r.attr("id",s.id,!0,!1)+r.attr("content-type",s.mime,!0,!1))+">"+(null==(t=s.data)?"":t)+"</binary>"}.call(this),n+="</FictionBook>"}.call(this,"NS"in o?o.NS:"undefined"!=typeof NS?NS:void 0,"annotation"in o?o.annotation:"undefined"!=typeof annotation?annotation:void 0,"attaches"in o?o.attaches:"undefined"!=typeof attaches?attaches:void 0,"author"in o?o.author:"undefined"!=typeof author?author:void 0,"body"in o?o.body:"undefined"!=typeof body?body:void 0,"bookAlias"in o?o.bookAlias:"undefined"!=typeof bookAlias?bookAlias:void 0,"fullDate"in o?o.fullDate:"undefined"!=typeof fullDate?fullDate:void 0,"genres"in o?o.genres:"undefined"!=typeof genres?genres:void 0,"lang"in o?o.lang:"undefined"!=typeof lang?lang:void 0,"programName"in o?o.programName:"undefined"!=typeof programName?programName:void 0,"shortDate"in o?o.shortDate:"undefined"!=typeof shortDate?shortDate:void 0,"title"in o?o.title:"undefined"!=typeof title?title:void 0),n}},function(e,t,n){var r=n(1);e.exports=function(e){var t,n="",o=e||{};return function(e,o){n=n+"<!DOCTYPE html><body><header><p>"+r.escape(null==(t=o)?"":t)+"</p></header>",function(){var o=e;if("number"==typeof o.length)for(var i=0,a=o.length;i<a;i++)(s=o[i]).text&&s.text.text&&(n=n+"<section><header><p>"+r.escape(null==(t=s.title.trim())?"":t)+"</p></header>"+(null==(t=s.text.text)?"":t)+"</section>");else for(var i in a=0,o){var s;a++,(s=o[i]).text&&s.text.text&&(n=n+"<section><header><p>"+r.escape(null==(t=s.title.trim())?"":t)+"</p></header>"+(null==(t=s.text.text)?"":t)+"</section>")}}.call(this),n+="</body>"}.call(this,"parts"in o?o.parts:"undefined"!=typeof parts?parts:void 0,"title"in o?o.title:"undefined"!=typeof title?title:void 0),n}},function(e,t,n){e.exports=function(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){const n=e&&e.match(t);return n&&n.length>0?n[n.length-1]:null}},function(e,t){},function(e,t){window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)})},function(e,t,n){function r(){}function o(e){return e()}function i(){return Object.create(null)}function a(e){e.forEach(o)}function s(e){return"function"==typeof e}function c(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function l(e,t){e.appendChild(t)}function u(e,t,n){e.insertBefore(t,n||null)}function f(e){e.parentNode.removeChild(e)}function d(e){return document.createElement(e)}function h(e){return document.createTextNode(e)}function y(e,t,n){null==n?e.removeAttribute(t):e.setAttribute(t,n)}let p;function v(e){p=e}n.r(t),new Set;const m=[],g=[],b=[],k=[],w=Promise.resolve();let $=!1;function x(e){b.push(e)}function S(){const e=new Set;do{for(;m.length;){const e=m.shift();v(e),(t=e.$$).fragment&&(t.update(t.dirty),a(t.before_update),t.fragment.p(t.dirty,t.ctx),t.dirty=null,t.after_update.forEach(x))}for(;g.length;)g.pop()();for(let t=0;t<b.length;t+=1){const n=b[t];e.has(n)||(n(),e.add(n))}b.length=0}while(m.length);for(var t;k.length;)k.pop()();$=!1}const O=new Set;let M;function _(e,t){e.$$.fragment&&(a(e.$$.on_destroy),e.$$.fragment.d(t),e.$$.on_destroy=e.$$.fragment=null,e.$$.ctx={})}function D(e,t,n,c,l,u){const f=p;v(e);const d=t.props||{},h=e.$$={fragment:null,ctx:null,props:u,update:r,not_equal:l,bound:i(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(f?f.$$.context:[]),callbacks:i(),dirty:null};let y=!1;var g,b,k;h.ctx=n?n(e,d,(t,n,r=n)=>(h.ctx&&l(h.ctx[t],h.ctx[t]=r)&&(h.bound[t]&&h.bound[t](r),y&&function(e,t){e.$$.dirty||(m.push(e),$||($=!0,w.then(S)),e.$$.dirty=i()),e.$$.dirty[t]=!0}(e,t)),n)):d,h.update(),y=!0,a(h.before_update),h.fragment=c(h.ctx),t.target&&(t.hydrate?h.fragment.l((g=t.target,Array.from(g.childNodes))):h.fragment.c(),t.intro&&((b=e.$$.fragment)&&b.i&&(O.delete(b),b.i(k))),function(e,t,n){const{fragment:r,on_mount:i,on_destroy:c,after_update:l}=e.$$;r.m(t,n),x(()=>{const t=i.map(o).filter(s);c?c.push(...t):a(t),e.$$.on_mount=[]}),l.forEach(x)}(e,t.target,t.anchor),S()),v(f)}"undefined"!=typeof window?window:global,"undefined"!=typeof HTMLElement&&(M=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){for(const e in this.$$.slotted)this.appendChild(this.$$.slotted[e])}attributeChangedCallback(e,t,n){this[e]=n}$destroy(){_(this,1),this.$destroy=r}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(){}});var E=n(0),A=n.n(E),j=n(2),L=n.n(j),C=n(3),T=n.n(C);function N(e){return(N="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var P="undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().indexOf("firefox")>0;function H(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on".concat(t),(function(){n(window.event)}))}function Y(e,t){for(var n=t.slice(0,t.length-1),r=0;r<n.length;r++)n[r]=e[n[r].toLowerCase()];return n}function B(e){"string"!=typeof e&&(e="");for(var t=(e=e.replace(/\s/g,"")).split(","),n=t.lastIndexOf("");n>=0;)t[n-1]+=",",t.splice(n,1),n=t.lastIndexOf("");return t}for(var K={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,"⇪":20,",":188,".":190,"/":191,"`":192,"-":P?173:189,"=":P?61:187,";":P?59:186,"'":222,"[":219,"]":221,"\\":220},R={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},q={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},U={16:!1,18:!1,17:!1,91:!1},F={},I=1;I<20;I++)K["f".concat(I)]=111+I;var W=[],z="all",J=[],X=function(e){return K[e.toLowerCase()]||R[e.toLowerCase()]||e.toUpperCase().charCodeAt(0)};function V(e){z=e||"all"}function Z(){return z||"all"}var G=function(e){var t=e.key,n=e.scope,r=e.method,o=e.splitKey,i=void 0===o?"+":o;B(t).forEach((function(e){var t=e.split(i),o=t.length,a=t[o-1],s="*"===a?"*":X(a);if(F[s]){n||(n=Z());var c=o>1?Y(R,t):[];F[s]=F[s].map((function(e){return r&&e.method!==r||e.scope!==n||!function(e,t){for(var n=e.length>=t.length?e:t,r=e.length>=t.length?t:e,o=!0,i=0;i<n.length;i++)-1===r.indexOf(n[i])&&(o=!1);return o}(e.mods,c)?e:{}}))}}))};function Q(e,t,n){var r;if(t.scope===n||"all"===t.scope){for(var o in r=t.mods.length>0,U)Object.prototype.hasOwnProperty.call(U,o)&&(!U[o]&&t.mods.indexOf(+o)>-1||U[o]&&-1===t.mods.indexOf(+o))&&(r=!1);(0!==t.mods.length||U[16]||U[18]||U[17]||U[91])&&!r&&"*"!==t.shortcut||!1===t.method(e,t)&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}function ee(e){var t=F["*"],n=e.keyCode||e.which||e.charCode;if(te.filter.call(this,e)){if(93!==n&&224!==n||(n=91),-1===W.indexOf(n)&&229!==n&&W.push(n),["ctrlKey","altKey","shiftKey","metaKey"].forEach((function(t){var n=q[t];e[t]&&-1===W.indexOf(n)?W.push(n):!e[t]&&W.indexOf(n)>-1&&W.splice(W.indexOf(n),1)})),n in U){for(var r in U[n]=!0,R)R[r]===n&&(te[r]=!0);if(!t)return}for(var o in U)Object.prototype.hasOwnProperty.call(U,o)&&(U[o]=e[q[o]]);var i=Z();if(t)for(var a=0;a<t.length;a++)t[a].scope===i&&("keydown"===e.type&&t[a].keydown||"keyup"===e.type&&t[a].keyup)&&Q(e,t[a],i);if(n in F)for(var s=0;s<F[n].length;s++)if(("keydown"===e.type&&F[n][s].keydown||"keyup"===e.type&&F[n][s].keyup)&&F[n][s].key){for(var c=F[n][s],l=c.splitKey,u=c.key.split(l),f=[],d=0;d<u.length;d++)f.push(X(u[d]));f.sort().join("")===W.sort().join("")&&Q(e,c,i)}}}function te(e,t,n){W=[];var r=B(e),o=[],i="all",a=document,s=0,c=!1,l=!0,u="+";for(void 0===n&&"function"==typeof t&&(n=t),"[object Object]"===Object.prototype.toString.call(t)&&(t.scope&&(i=t.scope),t.element&&(a=t.element),t.keyup&&(c=t.keyup),void 0!==t.keydown&&(l=t.keydown),"string"==typeof t.splitKey&&(u=t.splitKey)),"string"==typeof t&&(i=t);s<r.length;s++)o=[],(e=r[s].split(u)).length>1&&(o=Y(R,e)),(e="*"===(e=e[e.length-1])?"*":X(e))in F||(F[e]=[]),F[e].push({keyup:c,keydown:l,scope:i,mods:o,shortcut:r[s],method:n,key:r[s],splitKey:u});void 0!==a&&!function(e){return J.indexOf(e)>-1}(a)&&window&&(J.push(a),H(a,"keydown",(function(e){ee(e)})),H(window,"focus",(function(){W=[]})),H(a,"keyup",(function(e){ee(e),function(e){var t=e.keyCode||e.which||e.charCode,n=W.indexOf(t);if(n>=0&&W.splice(n,1),e.key&&"meta"===e.key.toLowerCase()&&W.splice(0,W.length),93!==t&&224!==t||(t=91),t in U)for(var r in U[t]=!1,R)R[r]===t&&(te[r]=!1)}(e)})))}var ne={setScope:V,getScope:Z,deleteScope:function(e,t){var n,r;for(var o in e||(e=Z()),F)if(Object.prototype.hasOwnProperty.call(F,o))for(n=F[o],r=0;r<n.length;)n[r].scope===e?n.splice(r,1):r++;Z()===e&&V(t||"all")},getPressedKeyCodes:function(){return W.slice(0)},isPressed:function(e){return"string"==typeof e&&(e=X(e)),-1!==W.indexOf(e)},filter:function(e){var t=e.target||e.srcElement,n=t.tagName,r=!0;return!t.isContentEditable&&"TEXTAREA"!==n&&("INPUT"!==n&&"TEXTAREA"!==n||t.readOnly)||(r=!1),r},unbind:function(e){if(e){if(Array.isArray(e))e.forEach((function(e){e.key&&G(e)}));else if("object"===N(e))e.key&&G(e);else if("string"==typeof e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var o=n[0],i=n[1];"function"==typeof o&&(i=o,o=""),G({key:e,scope:o,method:i,splitKey:"+"})}}else Object.keys(F).forEach((function(e){return delete F[e]}))}};for(var re in ne)Object.prototype.hasOwnProperty.call(ne,re)&&(te[re]=ne[re]);if("undefined"!=typeof window){var oe=window.hotkeys;te.noConflict=function(e){return e&&window.hotkeys===te&&(window.hotkeys=oe),te},window.hotkeys=te}var ie=te,ae=n(4),se=n(5),ce=(n(9),n(6)),le=n(7),ue=n.n(le);const fe=function(){const e={"&#x22;":'"',"&#34;":'"',"&#034;":'"',"&quot;":'"',"&#x27;":"'","&#39;":"'","&#039;":"'","&apos;":"'","&#x60;":"`","&nbsp;":" ","&#95;":"_"},t="(?:"+Object.keys(e).join("|")+")",n=RegExp(t,"g");return t=>t.replace(n,t=>e[t])}(),de={Adult:"home_sex",Josei:"sf_action",Mature:"",Shounen:"sf_action",Xianxia:"sf_fantasy",Xuanhuan:"sf_fantasy","Боевик":"det_action","Боевые Искусства":"fantasy_fight","Вампиры":"vampire_book","Виртуальный Мир":"sf","Гарем":"","Гендерная Интрига":"","Героическое Фэнтези":"sf_heroic","Детектив":"detective","Дзёсэй":"sf_action","Драма":"dramaturgy","Игра":"sf","История":"sci_history","Комедия":"humor","Меха":"sf","Мистика":"sf_horror","Научная Фантастика":"sf","Оригинальный сюжет":"","Повседневность":"","Приключения":"adventure","Психология":"sci_psychology","Романтика":"","Сверхъестественное":"sf_horror","Смена Пола":"","Спорт":"home_sport","Сэйнэн":"sf_action","Сёдзе":"","Сёдзе-ай":"","Сёнэн":"sf_action","Трагедия":"","Триллер":"thriller","Ужасы":"sf_horror","Уся":"fantasy_fight","Фэнтези":"sf_fantasy","Хентай":"home_sex","Школьная Жизнь":"children","Экшн":"sf_action","Эротика":"love_erotica","Этти":"love_erotica","Юри":""};async function he(e){return(await fetch("https://xn--80ac9aeh6f.xn--p1ai/api/v2/books/"+e,{credentials:"include"})).json()}const ye=/^\s*data:([image\/jpnf]+);base64/;function pe(e,t){return{mime:ue()(e,ye)||t,data:e.slice(e.indexOf(",")+1)}}async function ve(e){if(ye.test(e))return pe(e);{const r=await fetch(e);return t=await r.blob(),n=r.headers.get("content-type"),new Promise((e,r)=>{const o=new FileReader;o.onloadend=function(t){try{2==o.readyState?e(pe(o.result,n)):r(o.error)}catch(e){r(e)}},o.readAsDataURL(t)})}var t,n}function me(e,t){const n=(new DOMParser).parseFromString(e,t),r=n.querySelector("parsererror");if(r)throw r.textContent;return n}function ge(e,t,n,r){const o=r?e.createElementNS(r,n):e.createElement(n);for(;t.firstChild;)o.appendChild(t.firstChild);t.parentNode.replaceChild(o,t)}function be(e,t){let n=me(e=e.replace(/>(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g,">").replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+<\//g,"</").replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g,"</p><p>"),"text/html");return n.querySelectorAll(".message-delete").forEach(e=>{e.remove()}),n.querySelectorAll("i,em").forEach(e=>{ge(n,e,"emphasis")}),n.querySelectorAll("b").forEach(e=>{ge(n,e,"strong")}),n.querySelectorAll("s,strike").forEach(e=>{ge(n,e,"strikethrough")}),n.querySelectorAll("div").forEach(e=>{ge(n,e,"p")}),n.querySelectorAll("body :not(section):not(emphasis):not(code):not(header):not(strong):not(strikethrough):not(p):not(empty-line):not(sub):not(sup):not(img)").forEach(e=>{ge(n,e,"code")}),(n=me(n.documentElement.outerHTML,"text/html")).querySelectorAll("img").forEach(e=>{const r="_"+ce();t.push({src:e.src,id:r});const o=n.createElement("image");o.setAttribute("l:href","#"+r),e.parentNode.replaceChild(o,e)}),n.querySelectorAll("body :not(image)").forEach(e=>{e.attributes.length>0&&Array.from(e.attributes).forEach(t=>e.removeAttribute(t.name))}),fe(n.body.innerHTML).replace(/><\/image>/g,"/>").replace(/(\s*<code>\s*<\/code>\s*)+/g," ").replace(/(\s*<p>\s*<\/p>\s*)+/g," ")}function ke(e){var t,n,r,o,i;return{c(){t=d("div"),(n=d("div")).innerHTML='<div class="sk-circle1 sk-child svelte-c1yrhu"></div> <div class="sk-circle2 sk-child svelte-c1yrhu"></div> <div class="sk-circle3 sk-child svelte-c1yrhu"></div> <div class="sk-circle4 sk-child svelte-c1yrhu"></div> <div class="sk-circle5 sk-child svelte-c1yrhu"></div> <div class="sk-circle6 sk-child svelte-c1yrhu"></div> <div class="sk-circle7 sk-child svelte-c1yrhu"></div> <div class="sk-circle8 sk-child svelte-c1yrhu"></div> <div class="sk-circle9 sk-child svelte-c1yrhu"></div> <div class="sk-circle10 sk-child svelte-c1yrhu"></div> <div class="sk-circle11 sk-child svelte-c1yrhu"></div> <div class="sk-circle12 sk-child svelte-c1yrhu"></div>',r=h(" "),o=h(e.percent),i=h("%"),y(n,"class","sk-circle svelte-c1yrhu"),y(t,"class","rg-loader-bg svelte-c1yrhu")},m(e,a){u(e,t,a),l(t,n),l(t,r),l(t,o),l(t,i)},p(e,t){var n,r;e.percent&&(n=o,r=""+(r=t.percent),n.data!==r&&(n.data=r))},d(e){e&&f(t)}}}function we(e){var t,n=e.loading&&ke(e);return{c(){n&&n.c(),t=h("")},m(e,r){n&&n.m(e,r),u(e,t,r)},p(e,r){r.loading?n?n.p(e,r):((n=ke(r)).c(),n.m(t.parentNode,t)):n&&(n.d(1),n=null)},i:r,o:r,d(e){n&&n.d(e),e&&f(t)}}}const $e="http://www.gribuser.ru/xml/fictionbook/2.0";function xe(e,t,n){let r=!1,o=0;var i;return i=()=>{ie("ctrl+s",e=>{e.stopPropagation(),e.preventDefault(),r||async function(){try{n("loading",r=!0),n("percent",o=0);const e=location.pathname.split("/",2).find(Boolean),{genres:t,chapters:i,author:a,description:s,createTime:c,title:l,images:u,country:f}=await he(e),d=T()(c),h=new Set(t.map(e=>de[e.title]));h.delete(void 0),h.delete(""),h.size<1&&h.add("unrecognised");const{mime:y,data:p}=await ve(u[0].url),v=5,m=await A()(i.reverse(),async({slug:t},r)=>{try{return he(e+"/chapters/"+t)}catch(n){return he(e+"/chapters/"+t)}finally{n("percent",o=Math.max(o,100*(r+1)/i.length|0))}},{concurrency:v}),g=[],b=be(se({title:l,parts:m}),g),k=be(s,g),w=me(ae({NS:$e,genres:Array.from(h),title:l,annotation:k,lang:f?f.code:void 0,author:a?a.name:void 0,programName:"ranobe-rf-fb2-loader",bookAlias:e,shortDate:d.format("YYYY-MM-DD"),fullDate:d.format("DD.MM.YYYY"),body:b,attaches:[{id:"cover",mime:y,data:p},...await A()(g,async e=>Object.assign(e,await ve(e.src)),{concurrency:v})]}),"application/xml");w.querySelectorAll("header").forEach(e=>ge(w,e,"title",$e)),L()(new Blob(['<?xml version="1.0" encoding="utf-8" ?>'+w.documentElement.outerHTML],{type:"text/xml;charset=utf-8"}),e+".fb2")}catch(e){console.error(e),alert("Ошибка загрузки. Попробуйте снова.")}finally{n("loading",r=!1)}}()}),console.log("ranobe-rf-fb2-loader loaded")},function(){if(!p)throw new Error("Function called outside component initialization");return p}().$$.on_mount.push(i),{loading:r,percent:o}}var Se=["interactive","complete"],Oe=function(e,t){return new Promise((function(n){e&&"function"!=typeof e&&(t=e,e=null),t=t||window.document;var r=function(){return n(void(e&&setTimeout(e)))};-1!==Se.indexOf(t.readyState)?r():t.addEventListener("DOMContentLoaded",r)}))};Oe.resume=function(e){return function(t){return Oe(e).then((function(){return t}))}},Oe(()=>{const e=document.createElement("div");e.style.zIndex="16777270",e.style.position="fixed",e.style.top="0",e.style.left="0",document.body.appendChild(e),new class extends class{$destroy(){_(this,1),this.$destroy=r}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(){}}{constructor(e){var t;super(),document.getElementById("svelte-c1yrhu-style")||((t=d("style")).id="svelte-c1yrhu-style",t.textContent=".sk-circle.svelte-c1yrhu{margin:auto;top:0;bottom:0;left:0;right:0;position:absolute;pointer-events:none}.sk-circle.svelte-c1yrhu{width:100px;height:100px}.sk-circle.svelte-c1yrhu .sk-child.svelte-c1yrhu{width:100%;height:100%;position:absolute;left:0;top:0}.sk-circle.svelte-c1yrhu .sk-child.svelte-c1yrhu:before{content:'';display:block;margin:0 auto;width:15%;height:15%;background-color:#303745;border-radius:100%;-webkit-animation:svelte-c1yrhu-sk-circleBounceDelay 1.2s infinite ease-in-out both;animation:svelte-c1yrhu-sk-circleBounceDelay 1.2s infinite ease-in-out both}.sk-circle.svelte-c1yrhu .sk-circle2.svelte-c1yrhu{-webkit-transform:rotate(30deg);transform:rotate(30deg)}.sk-circle.svelte-c1yrhu .sk-circle3.svelte-c1yrhu{-webkit-transform:rotate(60deg);transform:rotate(60deg)}.sk-circle.svelte-c1yrhu .sk-circle4.svelte-c1yrhu{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.sk-circle.svelte-c1yrhu .sk-circle5.svelte-c1yrhu{-webkit-transform:rotate(120deg);transform:rotate(120deg)}.sk-circle.svelte-c1yrhu .sk-circle6.svelte-c1yrhu{-webkit-transform:rotate(150deg);transform:rotate(150deg)}.sk-circle.svelte-c1yrhu .sk-circle7.svelte-c1yrhu{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.sk-circle.svelte-c1yrhu .sk-circle8.svelte-c1yrhu{-webkit-transform:rotate(210deg);transform:rotate(210deg)}.sk-circle.svelte-c1yrhu .sk-circle9.svelte-c1yrhu{-webkit-transform:rotate(240deg);transform:rotate(240deg)}.sk-circle.svelte-c1yrhu .sk-circle10.svelte-c1yrhu{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.sk-circle.svelte-c1yrhu .sk-circle11.svelte-c1yrhu{-webkit-transform:rotate(300deg);transform:rotate(300deg)}.sk-circle.svelte-c1yrhu .sk-circle12.svelte-c1yrhu{-webkit-transform:rotate(330deg);transform:rotate(330deg)}.sk-circle.svelte-c1yrhu .sk-circle2.svelte-c1yrhu:before{-webkit-animation-delay:-1.1s;animation-delay:-1.1s}.sk-circle.svelte-c1yrhu .sk-circle3.svelte-c1yrhu:before{-webkit-animation-delay:-1s;animation-delay:-1s}.sk-circle.svelte-c1yrhu .sk-circle4.svelte-c1yrhu:before{-webkit-animation-delay:-0.9s;animation-delay:-0.9s}.sk-circle.svelte-c1yrhu .sk-circle5.svelte-c1yrhu:before{-webkit-animation-delay:-0.8s;animation-delay:-0.8s}.sk-circle.svelte-c1yrhu .sk-circle6.svelte-c1yrhu:before{-webkit-animation-delay:-0.7s;animation-delay:-0.7s}.sk-circle.svelte-c1yrhu .sk-circle7.svelte-c1yrhu:before{-webkit-animation-delay:-0.6s;animation-delay:-0.6s}.sk-circle.svelte-c1yrhu .sk-circle8.svelte-c1yrhu:before{-webkit-animation-delay:-0.5s;animation-delay:-0.5s}.sk-circle.svelte-c1yrhu .sk-circle9.svelte-c1yrhu:before{-webkit-animation-delay:-0.4s;animation-delay:-0.4s}.sk-circle.svelte-c1yrhu .sk-circle10.svelte-c1yrhu:before{-webkit-animation-delay:-0.3s;animation-delay:-0.3s}.sk-circle.svelte-c1yrhu .sk-circle11.svelte-c1yrhu:before{-webkit-animation-delay:-0.2s;animation-delay:-0.2s}.sk-circle.svelte-c1yrhu .sk-circle12.svelte-c1yrhu:before{-webkit-animation-delay:-0.1s;animation-delay:-0.1s}@-webkit-keyframes svelte-c1yrhu-sk-circleBounceDelay{0%,80%,100%{-webkit-transform:scale(0);transform:scale(0)}40%{-webkit-transform:scale(1);transform:scale(1)}}@keyframes svelte-c1yrhu-sk-circleBounceDelay{0%,80%,100%{-webkit-transform:scale(0);transform:scale(0)}40%{-webkit-transform:scale(1);transform:scale(1)}}.rg-loader-bg.svelte-c1yrhu{background:rgba(255, 255, 255, 0.8);width:100vw;height:100vh;line-height:100vh;display:block;position:fixed;top:0;left:0;text-align:center;font-size:16px;color:#303745;-moz-user-select:none;-webkit-user-select:none;user-select:none}",l(document.head,t)),D(this,e,xe,we,c,[])}}({target:e})})}]);