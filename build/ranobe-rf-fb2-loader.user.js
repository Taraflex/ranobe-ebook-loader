// ==UserScript==
// @name         ranobe-rf-fb2-loader
// @namespace    taraflex
// @version      0.1.0
// @description  Юзерскрипт для скачивания книг в формате fb2 c https://ранобэ.рф/ и https://ranobes.com/
// @author       taraflex.red@gmail.com
// @downloadURL  https://raw.githubusercontent.com/Taraflex/ranobe-rf-fb2-loader/master/build/ranobe-rf-fb2-loader.user.js
// @match        https://xn--80ac9aeh6f.xn--p1ai/*
// @match        https://ranobes.com/ranobe/*
// @run-at       document-body
// @homepageURL  https://github.com/Taraflex/ranobe-rf-fb2-loader
// @supportURL   https://github.com/Taraflex/ranobe-rf-fb2-loader/issues
// @noframes
// ==/UserScript==
!function(){function e(){}function t(e){return e()}function n(){return Object.create(null)}function r(e){e.forEach(t)}function o(e){return"function"==typeof e}function i(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function a(e,t){e.appendChild(t)}function s(e,t,n){e.insertBefore(t,n||null)}function c(e){e.parentNode.removeChild(e)}function l(e){return document.createElement(e)}function u(e){return document.createTextNode(e)}function f(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}let d;function h(e){d=e}function p(e){(function(){if(!d)throw new Error("Function called outside component initialization");return d})().$$.on_mount.push(e)}window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)});const v=[],m=[],y=[],g=[],w=Promise.resolve();let b=!1;function k(e){y.push(e)}let $=!1;const x=new Set;function S(){if(!$){$=!0;do{for(let e=0;e<v.length;e+=1){const t=v[e];h(t),j(t.$$)}for(v.length=0;m.length;)m.pop()();for(let e=0;e<y.length;e+=1){const t=y[e];x.has(t)||(x.add(t),t())}y.length=0}while(v.length);for(;g.length;)g.pop()();b=!1,$=!1,x.clear()}}function j(e){if(null!==e.fragment){e.update(),r(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(k)}}const O=new Set;function M(e,t){-1===e.$$.dirty[0]&&(v.push(e),b||(b=!0,w.then(S)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function E(i,a,s,l,u,f,p=[-1]){const v=d;h(i);const m=a.props||{},y=i.$$={fragment:null,ctx:null,props:f,update:e,not_equal:u,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(v?v.$$.context:[]),callbacks:n(),dirty:p,skip_bound:!1};let g=!1;if(y.ctx=s?s(i,m,(e,t,...n)=>{const r=n.length?n[0]:t;return y.ctx&&u(y.ctx[e],y.ctx[e]=r)&&(!y.skip_bound&&y.bound[e]&&y.bound[e](r),g&&M(i,e)),t}):[],y.update(),g=!0,r(y.before_update),y.fragment=!!l&&l(y.ctx),a.target){if(a.hydrate){const e=function(e){return Array.from(e.childNodes)}(a.target);y.fragment&&y.fragment.l(e),e.forEach(c)}else y.fragment&&y.fragment.c();a.intro&&((w=i.$$.fragment)&&w.i&&(O.delete(w),w.i(b))),function(e,n,i){const{fragment:a,on_mount:s,on_destroy:c,after_update:l}=e.$$;a&&a.m(n,i),k(()=>{const n=s.map(t).filter(o);c?c.push(...n):r(n),e.$$.on_mount=[]}),l.forEach(k)}(i,a.target,a.anchor),S()}var w,b;h(v)}const A=(e,t,n)=>new Promise((r,o)=>{if(n=Object.assign({concurrency:1/0},n),"function"!=typeof t)throw new TypeError("Mapper function is required");const{concurrency:i}=n;if(!("number"==typeof i&&i>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${i}\` (${typeof i})`);const a=[],s=e[Symbol.iterator]();let c=!1,l=!1,u=0,f=0;const d=()=>{if(c)return;const e=s.next(),n=f;if(f++,e.done)return l=!0,void(0===u&&r(a));u++,Promise.resolve(e.value).then(e=>t(e,n)).then(e=>{a[n]=e,u--,d()},e=>{c=!0,o(e)})};for(let e=0;e<i&&(d(),!l);e++);});var D=A,_=A;D.default=_;var C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function L(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}var T=L((function(e,t){!function(){function t(e,t){return void 0===t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}function n(e,t,n){var r=new XMLHttpRequest;r.open("GET",e),r.responseType="blob",r.onload=function(){a(r.response,t,n)},r.onerror=function(){console.error("could not download file")},r.send()}function r(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function o(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(n){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var i="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof C&&C.global===C?C:void 0,a=i.saveAs||("object"!=typeof window||window!==i?function(){}:"download"in HTMLAnchorElement.prototype?function(e,t,a){var s=i.URL||i.webkitURL,c=document.createElement("a");t=t||e.name||"download",c.download=t,c.rel="noopener","string"==typeof e?(c.href=e,c.origin===location.origin?o(c):r(c.href)?n(e,t,a):o(c,c.target="_blank")):(c.href=s.createObjectURL(e),setTimeout((function(){s.revokeObjectURL(c.href)}),4e4),setTimeout((function(){o(c)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,i,a){if(i=i||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(t(e,a),i);else if(r(e))n(e,i,a);else{var s=document.createElement("a");s.href=e,s.target="_blank",setTimeout((function(){o(s)}))}}:function(e,t,r,o){if((o=o||open("","_blank"))&&(o.document.title=o.document.body.innerText="downloading..."),"string"==typeof e)return n(e,t,r);var a="application/octet-stream"===e.type,s=/constructor/i.test(i.HTMLElement)||i.safari,c=/CriOS\/[\d]+/.test(navigator.userAgent);if((c||a&&s)&&"object"==typeof FileReader){var l=new FileReader;l.onloadend=function(){var e=l.result;e=c?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=e:location=e,o=null},l.readAsDataURL(e)}else{var u=i.URL||i.webkitURL,f=u.createObjectURL(e);o?o.location=f:location.href=f,o=null,setTimeout((function(){u.revokeObjectURL(f)}),4e4)}});i.saveAs=a.saveAs=a,e.exports=a}()})),q=L((function(e,t){e.exports=function(){var e="millisecond",t="second",n="minute",r="hour",o="day",i="week",a="month",s="quarter",c="year",l="date",u=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[^0-9]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?.?(\d{1,3})?$/,f=/\[([^\]]+)]|Y{2,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,d=function(e,t,n){var r=String(e);return!r||r.length>=t?e:""+Array(t+1-r.length).join(n)+e},h={s:d,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),r=Math.floor(n/60),o=n%60;return(t<=0?"+":"-")+d(r,2,"0")+":"+d(o,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var r=12*(n.year()-t.year())+(n.month()-t.month()),o=t.add(r,a),i=n-o<0,s=t.add(r+(i?-1:1),a);return+(-(r+(n-o)/(i?o-s:s-o))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(u){return{M:a,y:c,w:i,d:o,D:l,h:r,m:n,s:t,ms:e,Q:s}[u]||String(u||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},p={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},v="en",m={};m[v]=p;var y=function(e){return e instanceof k},g=function(e,t,n){var r;if(!e)return v;if("string"==typeof e)m[e]&&(r=e),t&&(m[e]=t,r=e);else{var o=e.name;m[o]=e,r=o}return!n&&r&&(v=r),r||!n&&v},w=function(e,t){if(y(e))return e.clone();var n="object"==typeof t?t:{};return n.date=e,n.args=arguments,new k(n)},b=h;b.l=g,b.i=y,b.w=function(e,t){return w(e,{locale:t.$L,utc:t.$u,$offset:t.$offset})};var k=function(){function d(e){this.$L=this.$L||g(e.locale,null,!0),this.parse(e)}var h=d.prototype;return h.parse=function(e){this.$d=function(e){var t=e.date,n=e.utc;if(null===t)return new Date(NaN);if(b.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var r=t.match(u);if(r){var o=r[2]-1||0;return n?new Date(Date.UTC(r[1],o,r[3]||1,r[4]||0,r[5]||0,r[6]||0,r[7]||0)):new Date(r[1],o,r[3]||1,r[4]||0,r[5]||0,r[6]||0,r[7]||0)}}return new Date(t)}(e),this.init()},h.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},h.$utils=function(){return b},h.isValid=function(){return!("Invalid Date"===this.$d.toString())},h.isSame=function(e,t){var n=w(e);return this.startOf(t)<=n&&n<=this.endOf(t)},h.isAfter=function(e,t){return w(e)<this.startOf(t)},h.isBefore=function(e,t){return this.endOf(t)<w(e)},h.$g=function(e,t,n){return b.u(e)?this[t]:this.set(n,e)},h.unix=function(){return Math.floor(this.valueOf()/1e3)},h.valueOf=function(){return this.$d.getTime()},h.startOf=function(e,s){var u=this,f=!!b.u(s)||s,d=b.p(e),h=function(e,t){var n=b.w(u.$u?Date.UTC(u.$y,t,e):new Date(u.$y,t,e),u);return f?n:n.endOf(o)},p=function(e,t){return b.w(u.toDate()[e].apply(u.toDate("s"),(f?[0,0,0,0]:[23,59,59,999]).slice(t)),u)},v=this.$W,m=this.$M,y=this.$D,g="set"+(this.$u?"UTC":"");switch(d){case c:return f?h(1,0):h(31,11);case a:return f?h(1,m):h(0,m+1);case i:var w=this.$locale().weekStart||0,k=(v<w?v+7:v)-w;return h(f?y-k:y+(6-k),m);case o:case l:return p(g+"Hours",0);case r:return p(g+"Minutes",1);case n:return p(g+"Seconds",2);case t:return p(g+"Milliseconds",3);default:return this.clone()}},h.endOf=function(e){return this.startOf(e,!1)},h.$set=function(i,s){var u,f=b.p(i),d="set"+(this.$u?"UTC":""),h=(u={},u[o]=d+"Date",u[l]=d+"Date",u[a]=d+"Month",u[c]=d+"FullYear",u[r]=d+"Hours",u[n]=d+"Minutes",u[t]=d+"Seconds",u[e]=d+"Milliseconds",u)[f],p=f===o?this.$D+(s-this.$W):s;if(f===a||f===c){var v=this.clone().set(l,1);v.$d[h](p),v.init(),this.$d=v.set(l,Math.min(this.$D,v.daysInMonth())).$d}else h&&this.$d[h](p);return this.init(),this},h.set=function(e,t){return this.clone().$set(e,t)},h.get=function(e){return this[b.p(e)]()},h.add=function(e,s){var l,u=this;e=Number(e);var f=b.p(s),d=function(t){var n=w(u);return b.w(n.date(n.date()+Math.round(t*e)),u)};if(f===a)return this.set(a,this.$M+e);if(f===c)return this.set(c,this.$y+e);if(f===o)return d(1);if(f===i)return d(7);var h=(l={},l[n]=6e4,l[r]=36e5,l[t]=1e3,l)[f]||1,p=this.$d.getTime()+e*h;return b.w(p,this)},h.subtract=function(e,t){return this.add(-1*e,t)},h.format=function(e){var t=this;if(!this.isValid())return"Invalid Date";var n=e||"YYYY-MM-DDTHH:mm:ssZ",r=b.z(this),o=this.$locale(),i=this.$H,a=this.$m,s=this.$M,c=o.weekdays,l=o.months,u=function(e,r,o,i){return e&&(e[r]||e(t,n))||o[r].substr(0,i)},d=function(e){return b.s(i%12||12,e,"0")},h=o.meridiem||function(e,t,n){var r=e<12?"AM":"PM";return n?r.toLowerCase():r},p={YY:String(this.$y).slice(-2),YYYY:this.$y,M:s+1,MM:b.s(s+1,2,"0"),MMM:u(o.monthsShort,s,l,3),MMMM:u(l,s),D:this.$D,DD:b.s(this.$D,2,"0"),d:String(this.$W),dd:u(o.weekdaysMin,this.$W,c,2),ddd:u(o.weekdaysShort,this.$W,c,3),dddd:c[this.$W],H:String(i),HH:b.s(i,2,"0"),h:d(1),hh:d(2),a:h(i,a,!0),A:h(i,a,!1),m:String(a),mm:b.s(a,2,"0"),s:String(this.$s),ss:b.s(this.$s,2,"0"),SSS:b.s(this.$ms,3,"0"),Z:r};return n.replace(f,(function(e,t){return t||p[e]||r.replace(":","")}))},h.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},h.diff=function(e,l,u){var f,d=b.p(l),h=w(e),p=6e4*(h.utcOffset()-this.utcOffset()),v=this-h,m=b.m(this,h);return m=(f={},f[c]=m/12,f[a]=m,f[s]=m/3,f[i]=(v-p)/6048e5,f[o]=(v-p)/864e5,f[r]=v/36e5,f[n]=v/6e4,f[t]=v/1e3,f)[d]||v,u?m:b.a(m)},h.daysInMonth=function(){return this.endOf(a).$D},h.$locale=function(){return m[this.$L]},h.locale=function(e,t){if(!e)return this.$L;var n=this.clone(),r=g(e,t,!0);return r&&(n.$L=r),n},h.clone=function(){return b.w(this.$d,this)},h.toDate=function(){return new Date(this.valueOf())},h.toJSON=function(){return this.isValid()?this.toISOString():null},h.toISOString=function(){return this.$d.toISOString()},h.toString=function(){return this.$d.toUTCString()},d}(),$=k.prototype;return w.prototype=$,[["$ms",e],["$s",t],["$m",n],["$H",r],["$W",o],["$M",a],["$y",c],["$D",l]].forEach((function(e){$[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),w.extend=function(e,t){return e(t,k,w),w},w.locale=g,w.isDayjs=y,w.unix=function(e){return w(1e3*e)},w.en=m[v],w.Ls=m,w}()}));const N={"&#x22;":'"',"&#34;":'"',"&#034;":'"',"&quot;":'"',"&#x27;":"'","&#39;":"'","&#039;":"'","&apos;":"'","&#x60;":"`","&nbsp;":" ","&#95;":"_"},P=RegExp("(?:"+Object.keys(N).join("|")+")","g");async function K(e){return(await fetch("https://xn--80ac9aeh6f.xn--p1ai/api/v2/books/"+e,{credentials:"include"})).json()}function H(e,t){const n=null==e?void 0:e.match(t);return n&&n.length>0?n[n.length-1]:null}const Y=/^\s*data:([image\/jpnf]+);base64/;function B(e,t){return{mime:H(e,Y)||t,data:e.slice(e.indexOf(",")+1)}}async function R(e){if(Y.test(e))return B(e);{const r=await fetch(e);return t=await r.blob(),n=r.headers.get("content-type")||"",new Promise((e,r)=>{const o=new FileReader;o.onloadend=function(){try{2==o.readyState?e(B(o.result,n)):r(o.error)}catch(e){r(e)}},o.readAsDataURL(t)})}var t,n}function U(e,t){const n=(new DOMParser).parseFromString(e,t||"text/html"),r=n.querySelector("parsererror");if(r)throw r.textContent;return n}async function I(e){const t=await fetch(e,{credentials:"include"});return 200===t.status?U(await t.text()):null}function F(e,t,n,r){const o=r?e.createElementNS(r,n):e.createElement(n);for(;t.firstChild;)o.appendChild(t.firstChild);return t.parentNode.replaceChild(o,t),o}function W(e,t){let n=U(e=e.replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g,"</p><p>"));return n.querySelectorAll(".message-delete,.splitnewsnavigation,script").forEach(e=>e.remove()),n.querySelectorAll("i,em").forEach(e=>F(n,e,"emphasis")),n.querySelectorAll("b").forEach(e=>F(n,e,"strong")),n.querySelectorAll("s,strike").forEach(e=>F(n,e,"strikethrough")),n.querySelectorAll(".game-message,.quote").forEach(e=>F(n,e,"blockquote")),n.querySelectorAll("body :not(header):not(section):not(emphasis):not(strong):not(strikethrough):not(blockquote):not(empty-line):not(sub):not(sup):not(img)").forEach(e=>{"SECTION"!==e.parentElement.tagName&&getComputedStyle(e).display.includes("inline")?function(e){for(;e.firstChild;)e.parentNode.insertBefore(e.firstChild,e);e.remove()}(e):F(n,e,"div")}),n=U(n.documentElement.outerHTML.replace(/<\/?div>/g,"</p><p>").replace(/<(\/)?blockquote>/g,"</p><$1blockquote><p>")),n.querySelectorAll("img").forEach(e=>{const r="_"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16);t.push({src:e.src,id:r});const o=n.createElement("image");o.setAttribute("l:href","#"+r),e.parentNode.replaceChild(o,e)}),n.querySelectorAll("blockquote").forEach(e=>F(n,e,"cite")),n.querySelectorAll("body :not(image)").forEach(e=>{for(;e.attributes.length>0;)e.removeAttribute(e.attributes.item(0).name)}),(r=n.body.innerHTML,r.replace(P,e=>N[e])).replace(/><\/image>/g,"/>").replace(/(\s*<p>\s*<\/p>\s*)+/g," ");var r}class z{constructor(e){this.progress=e}date(e){return this.d.format(e)}}class J extends z{async init(){this.bookAlias=location.pathname.split("/",2).find(Boolean);const{genres:e,author:t,description:n,createTime:r,title:o,images:i,country:a}=await K(this.bookAlias);this.cover=i.vertical.find(e=>"bookMain"===e.processor).url,this.d=q(r),this.genres=e.map(e=>e.title),this.title=o,this.description=n,this.lang=null==a?void 0:a.code,this.authors=[t].filter(Boolean)}get homePage(){return`https://xn--80ac9aeh6f.xn--p1ai/${this.bookAlias}/`}async parts(){const{bookAlias:e}=this,{items:t}=await K(e+"/chapters");return D(t.reverse(),async({slug:n},r)=>{try{return await K(e+"/chapters/"+n)}finally{this.progress(r,t.length)}},{concurrency:5})}}class V extends z{extractTitle(e){return null==e?void 0:e.querySelector("h1").firstChild.textContent}async init(){this.bookAlias=document.querySelector(".r-fullstory-chapters-foot > a:nth-child(3n)").href.split("/",5).slice(-1)[0],this.cover=document.querySelector('[itemprop="image"]').href,this.d=q(document.querySelector('[itemprop="datePublished"]').getAttribute("content")),this.genres=Array.from(document.querySelectorAll('[itemprop="genre"] a')).map(e=>e.textContent),this.title=this.extractTitle(document),this.description=document.querySelector('[itemprop="description"]').innerHTML,this.lang=void 0,this.authors=Array.from(document.querySelectorAll('[itemprop="creator"] a')).map(e=>({name:e.textContent,homePage:e.href}))}get homePage(){return location.href}async parts(){const{bookAlias:e}=this,t=[];for(let n=1;;++n){const r=await I(`https://ranobes.com/chapters/${e}/page/${n}/`);if(!r)break;r.querySelectorAll(`.cat_block a[href^="https://ranobes.com/chapters/${e}/"]`).forEach(e=>t.push(e.href))}return D(t.reverse(),async(e,n)=>{let r="",o="";const i=[e];for(let e of i){const t=await I(e);if(!t)break;if(r+=t.getElementById("arrticle").outerHTML,!o){o=this.extractTitle(t);const e=t.querySelector(".splitnewsnavigation");e&&e.querySelectorAll(`a[href^="https://ranobes.com/chapters/${this.bookAlias}/"]`).forEach(e=>i.push(e.href))}}return this.progress(n,t.length),{title:o,text:{text:r}}},{concurrency:5})}}var X="undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().indexOf("firefox")>0;function Z(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on".concat(t),(function(){n(window.event)}))}function G(e,t){for(var n=t.slice(0,t.length-1),r=0;r<n.length;r++)n[r]=e[n[r].toLowerCase()];return n}function Q(e){"string"!=typeof e&&(e="");for(var t=(e=e.replace(/\s/g,"")).split(","),n=t.lastIndexOf("");n>=0;)t[n-1]+=",",t.splice(n,1),n=t.lastIndexOf("");return t}for(var ee={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,"⇪":20,",":188,".":190,"/":191,"`":192,"-":X?173:189,"=":X?61:187,";":X?59:186,"'":222,"[":219,"]":221,"\\":220},te={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},ne={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},re={16:!1,18:!1,17:!1,91:!1},oe={},ie=1;ie<20;ie++)ee["f".concat(ie)]=111+ie;var ae=[],se="all",ce=[],le=function(e){return ee[e.toLowerCase()]||te[e.toLowerCase()]||e.toUpperCase().charCodeAt(0)};function ue(e){se=e||"all"}function fe(){return se||"all"}var de=function(e){var t=e.key,n=e.scope,r=e.method,o=e.splitKey,i=void 0===o?"+":o;Q(t).forEach((function(e){var t=e.split(i),o=t.length,a=t[o-1],s="*"===a?"*":le(a);if(oe[s]){n||(n=fe());var c=o>1?G(te,t):[];oe[s]=oe[s].map((function(e){return(!r||e.method===r)&&e.scope===n&&function(e,t){for(var n=e.length>=t.length?e:t,r=e.length>=t.length?t:e,o=!0,i=0;i<n.length;i++)-1===r.indexOf(n[i])&&(o=!1);return o}(e.mods,c)?{}:e}))}}))};function he(e,t,n){var r;if(t.scope===n||"all"===t.scope){for(var o in r=t.mods.length>0,re)Object.prototype.hasOwnProperty.call(re,o)&&(!re[o]&&t.mods.indexOf(+o)>-1||re[o]&&-1===t.mods.indexOf(+o))&&(r=!1);(0!==t.mods.length||re[16]||re[18]||re[17]||re[91])&&!r&&"*"!==t.shortcut||!1===t.method(e,t)&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}function pe(e){var t=oe["*"],n=e.keyCode||e.which||e.charCode;if(ve.filter.call(this,e)){if(93!==n&&224!==n||(n=91),-1===ae.indexOf(n)&&229!==n&&ae.push(n),["ctrlKey","altKey","shiftKey","metaKey"].forEach((function(t){var n=ne[t];e[t]&&-1===ae.indexOf(n)?ae.push(n):!e[t]&&ae.indexOf(n)>-1?ae.splice(ae.indexOf(n),1):"metaKey"===t&&e[t]&&3===ae.length&&(e.ctrlKey||e.shiftKey||e.altKey||(ae=ae.slice(ae.indexOf(n))))})),n in re){for(var r in re[n]=!0,te)te[r]===n&&(ve[r]=!0);if(!t)return}for(var o in re)Object.prototype.hasOwnProperty.call(re,o)&&(re[o]=e[ne[o]]);e.getModifierState&&(!e.altKey||e.ctrlKey)&&e.getModifierState("AltGraph")&&(-1===ae.indexOf(17)&&ae.push(17),-1===ae.indexOf(18)&&ae.push(18),re[17]=!0,re[18]=!0);var i=fe();if(t)for(var a=0;a<t.length;a++)t[a].scope===i&&("keydown"===e.type&&t[a].keydown||"keyup"===e.type&&t[a].keyup)&&he(e,t[a],i);if(n in oe)for(var s=0;s<oe[n].length;s++)if(("keydown"===e.type&&oe[n][s].keydown||"keyup"===e.type&&oe[n][s].keyup)&&oe[n][s].key){for(var c=oe[n][s],l=c.splitKey,u=c.key.split(l),f=[],d=0;d<u.length;d++)f.push(le(u[d]));f.sort().join("")===ae.sort().join("")&&he(e,c,i)}}}function ve(e,t,n){ae=[];var r=Q(e),o=[],i="all",a=document,s=0,c=!1,l=!0,u="+";for(void 0===n&&"function"==typeof t&&(n=t),"[object Object]"===Object.prototype.toString.call(t)&&(t.scope&&(i=t.scope),t.element&&(a=t.element),t.keyup&&(c=t.keyup),void 0!==t.keydown&&(l=t.keydown),"string"==typeof t.splitKey&&(u=t.splitKey)),"string"==typeof t&&(i=t);s<r.length;s++)o=[],(e=r[s].split(u)).length>1&&(o=G(te,e)),(e="*"===(e=e[e.length-1])?"*":le(e))in oe||(oe[e]=[]),oe[e].push({keyup:c,keydown:l,scope:i,mods:o,shortcut:r[s],method:n,key:r[s],splitKey:u});void 0!==a&&!function(e){return ce.indexOf(e)>-1}(a)&&window&&(ce.push(a),Z(a,"keydown",(function(e){pe(e)})),Z(window,"focus",(function(){ae=[]})),Z(a,"keyup",(function(e){pe(e),function(e){var t=e.keyCode||e.which||e.charCode,n=ae.indexOf(t);if(n>=0&&ae.splice(n,1),e.key&&"meta"===e.key.toLowerCase()&&ae.splice(0,ae.length),93!==t&&224!==t||(t=91),t in re)for(var r in re[t]=!1,te)te[r]===t&&(ve[r]=!1)}(e)})))}var me={setScope:ue,getScope:fe,deleteScope:function(e,t){var n,r;for(var o in e||(e=fe()),oe)if(Object.prototype.hasOwnProperty.call(oe,o))for(n=oe[o],r=0;r<n.length;)n[r].scope===e?n.splice(r,1):r++;fe()===e&&ue(t||"all")},getPressedKeyCodes:function(){return ae.slice(0)},isPressed:function(e){return"string"==typeof e&&(e=le(e)),-1!==ae.indexOf(e)},filter:function(e){var t=e.target||e.srcElement,n=t.tagName,r=!0;return!t.isContentEditable&&("INPUT"!==n&&"TEXTAREA"!==n&&"SELECT"!==n||t.readOnly)||(r=!1),r},unbind:function(e){if(e){if(Array.isArray(e))e.forEach((function(e){e.key&&de(e)}));else if("object"==typeof e)e.key&&de(e);else if("string"==typeof e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var o=n[0],i=n[1];"function"==typeof o&&(i=o,o=""),de({key:e,scope:o,method:i,splitKey:"+"})}}else Object.keys(oe).forEach((function(e){return delete oe[e]}))}};for(var ye in me)Object.prototype.hasOwnProperty.call(me,ye)&&(ve[ye]=me[ye]);if("undefined"!=typeof window){var ge=window.hotkeys;ve.noConflict=function(e){return e&&window.hotkeys===ve&&(window.hotkeys=ge),ve},window.hotkeys=ve}var we=function(e){var t=Object.prototype.hasOwnProperty;function n(e,r){return Array.isArray(e)?function(e,t){for(var r,o="",i="",s=Array.isArray(t),c=0;c<e.length;c++)(r=n(e[c]))&&(s&&t[c]&&(r=a(r)),o=o+i+r,i=" ");return o}(e,r):e&&"object"==typeof e?function(e){var n="",r="";for(var o in e)o&&e[o]&&t.call(e,o)&&(n=n+r+o,r=" ");return n}(e):e||""}function r(e){if(!e)return"";if("object"==typeof e){var n="";for(var r in e)t.call(e,r)&&(n=n+r+":"+e[r]+";");return n}return e+""}function o(e,t,n,r){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(r?e:e+'="'+e+'"');var o=typeof t;return"object"!==o&&"function"!==o||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),n||-1===t.indexOf('"'))?(n&&(t=a(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}e.merge=function e(t,n){if(1===arguments.length){for(var o=t[0],i=1;i<t.length;i++)o=e(o,t[i]);return o}for(var a in n)if("class"===a){var s=t[a]||[];t[a]=(Array.isArray(s)?s:[s]).concat(n[a]||[])}else if("style"===a){s=(s=r(t[a]))&&";"!==s[s.length-1]?s+";":s;var c=r(n[a]);c=c&&";"!==c[c.length-1]?c+";":c,t[a]=s+c}else t[a]=n[a];return t},e.classes=n,e.style=r,e.attr=o,e.attrs=function(e,i){var a="";for(var s in e)if(t.call(e,s)){var c=e[s];if("class"===s){c=n(c),a=o(s,c,!1,i)+a;continue}"style"===s&&(c=r(c)),a+=o(s,c,!1,i)}return a};var i=/["&<>]/;function a(e){var t=""+e,n=i.exec(t);if(!n)return e;var r,o,a,s="";for(r=n.index,o=0;r<t.length;r++){switch(t.charCodeAt(r)){case 34:a="&quot;";break;case 38:a="&amp;";break;case 60:a="&lt;";break;case 62:a="&gt;";break;default:continue}o!==r&&(s+=t.substring(o,r)),o=r+1,s+=a}return o!==r?s+t.substring(o,r):s}return e.escape=a,e.rethrow=function e(t,n,r,o){if(!(t instanceof Error))throw t;if(!("undefined"==typeof window&&n||o))throw t.message+=" on line "+r,t;try{o=o||require("fs").readFileSync(n,"utf8")}catch(n){e(t,null,r)}var i=3,a=o.split("\n"),s=Math.max(r-i,0),c=Math.min(a.length,r+i);i=a.slice(s,c).map((function(e,t){var n=t+s+1;return(n==r?"  > ":"    ")+n+"| "+e})).join("\n");throw t.path=n,t.message=(n||"Pug")+":"+r+"\n"+i+"\n\n"+t.message,t},e}({});function be(e){var t,n="",r=e||{};return function(e,r){n=n+"<!DOCTYPE html>\n<body>\n  <header>\n    <p>"+we.escape(null==(t=r)?"":t)+"</p>\n  </header>",function(){var r=e;if("number"==typeof r.length)for(var o=0,i=r.length;o<i;o++){(a=r[o]).text&&a.text.text&&(n=n+"\n  <section>\n    <header>\n      <p>"+we.escape(null==(t=a.title.trim())?"":t)+"</p>\n    </header>"+(null==(t=a.text.text)?"":t)+"\n  </section>")}else{i=0;for(var o in r){var a;i++,(a=r[o]).text&&a.text.text&&(n=n+"\n  <section>\n    <header>\n      <p>"+we.escape(null==(t=a.title.trim())?"":t)+"</p>\n    </header>"+(null==(t=a.text.text)?"":t)+"\n  </section>")}}}.call(this),n+="\n</body>"}.call(this,"parts"in r?r.parts:"undefined"!=typeof parts?parts:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0),n}function ke(e){let t,n,r,o,i;return{c(){t=l("div"),n=l("div"),n.innerHTML='<div class="c1 h svelte-1nj6wvk"></div> \n            <div class="c2 h svelte-1nj6wvk"></div> \n            <div class="c3 h svelte-1nj6wvk"></div> \n            <div class="c4 h svelte-1nj6wvk"></div> \n            <div class="c5 h svelte-1nj6wvk"></div> \n            <div class="c6 h svelte-1nj6wvk"></div> \n            <div class="c7 h svelte-1nj6wvk"></div> \n            <div class="c8 h svelte-1nj6wvk"></div> \n            <div class="c9 h svelte-1nj6wvk"></div> \n            <div class="c10 h svelte-1nj6wvk"></div> \n            <div class="c11 h svelte-1nj6wvk"></div> \n            <div class="c12 h svelte-1nj6wvk"></div>',r=u(" "),o=u(e[1]),i=u("%"),f(n,"class","c svelte-1nj6wvk"),f(t,"class","bg svelte-1nj6wvk")},m(e,c){s(e,t,c),a(t,n),a(t,r),a(t,o),a(t,i)},p(e,t){2&t&&function(e,t){t=""+t,e.wholeText!==t&&(e.data=t)}(o,e[1])},d(e){e&&c(t)}}}function $e(t){let n,r=t[0]&&ke(t);return{c(){r&&r.c(),n=u("")},m(e,t){r&&r.m(e,t),s(e,n,t)},p(e,[t]){e[0]?r?r.p(e,t):(r=ke(e),r.c(),r.m(n.parentNode,n)):r&&(r.d(1),r=null)},i:e,o:e,d(e){r&&r.d(e),e&&c(n)}}}const xe="http://www.gribuser.ru/xml/fictionbook/2.0";function Se(e,t,n){let r=!1,o=0;p(()=>{ve("ctrl+s",e=>{e.stopImmediatePropagation(),e.preventDefault(),r||async function(){try{n(0,r=!0),n(1,o=0);const e=new i[location.hostname]((e,t)=>n(1,o=Math.max(o,100*(e+1)/t|0)));await e.init(),e.genres.length<1&&e.genres.push("unrecognised");const t=await e.parts(),a=[{id:"cover",src:e.cover}],s=U(function(e){var t,n="",r=e||{};return function(e,r,o,i,a,s,c,l,u,f,d,h,p){n=n+'<?xml version="1.0" encoding="utf-8" ?>\n<FictionBook'+we.attr("xmlns",e,!0,!1)+' xmlns:l="http://www.w3.org/1999/xlink">\n  <description>\n    <title-info>',function(){var e=l;if("number"==typeof e.length)for(var r=0,o=e.length;r<o;r++){var i=e[r];n=n+"\n      <genre>"+we.escape(null==(t=i)?"":t)+"</genre>"}else for(var r in o=0,e)o++,i=e[r],n=n+"\n      <genre>"+we.escape(null==(t=i)?"":t)+"</genre>"}.call(this),function(){var e=i;if("number"==typeof e.length)for(var r=0,o=e.length;r<o;r++){var a=e[r];n=n+"\n      <author>\n        <first-name>"+we.escape(null==(t=a.name)?"":t)+"</first-name>\n        <last-name/>",a.homePage&&(n=n+"\n        <home-page>"+we.escape(null==(t=a.homePage)?"":t)+"</home-page>"),n+="\n      </author>"}else for(var r in o=0,e)o++,a=e[r],n=n+"\n      <author>\n        <first-name>"+we.escape(null==(t=a.name)?"":t)+"</first-name>\n        <last-name/>",a.homePage&&(n=n+"\n        <home-page>"+we.escape(null==(t=a.homePage)?"":t)+"</home-page>"),n+="\n      </author>"}.call(this),n=n+"\n      <book-title>"+we.escape(null==(t=p)?"":t)+"</book-title>",r&&(n=n+"\n      <annotation>"+(null==(t=r)?"":t)+"</annotation>"),n+='\n      <coverpage>\n        <image l:href="#cover"/>\n      </coverpage>\n      <lang>ru</lang>',f&&(n=n+"\n      <src-lang>"+we.escape(null==(t=f)?"":t)+"</src-lang>"),n+="\n    </title-info>\n    <document-info>",function(){var e=i;if("number"==typeof e.length)for(var r=0,o=e.length;r<o;r++){var a=e[r];n=n+"\n      <author>\n        <first-name>"+we.escape(null==(t=a.name)?"":t)+"</first-name>\n        <last-name/>",a.homePage&&(n=n+"\n        <home-page>"+we.escape(null==(t=a.homePage)?"":t)+"</home-page>"),n+="\n      </author>"}else for(var r in o=0,e)o++,a=e[r],n=n+"\n      <author>\n        <first-name>"+we.escape(null==(t=a.name)?"":t)+"</first-name>\n        <last-name/>",a.homePage&&(n=n+"\n        <home-page>"+we.escape(null==(t=a.homePage)?"":t)+"</home-page>"),n+="\n      </author>"}.call(this),n=n+"\n      <program-used>"+we.escape(null==(t=d)?"":t)+"</program-used>\n      <date"+we.attr("value",h,!0,!1)+">"+we.escape(null==(t=c)?"":t)+"</date>\n      <src-url>"+we.escape(null==(t=u)?"":t)+"</src-url>\n      <id>"+we.escape(null==(t=s)?"":t)+"</id>\n      <version>1</version>\n    </document-info>\n  </description>\n  <body>"+(null==(t=a)?"":t)+"</body>",function(){var e=o;if("number"==typeof e.length)for(var r=0,i=e.length;r<i;r++){var a=e[r];n=n+"\n  <binary"+(we.attr("id",a.id,!0,!1)+we.attr("content-type",a.mime,!0,!1))+">"+(null==(t=a.data)?"":t)+"</binary>"}else for(var r in i=0,e)i++,a=e[r],n=n+"\n  <binary"+(we.attr("id",a.id,!0,!1)+we.attr("content-type",a.mime,!0,!1))+">"+(null==(t=a.data)?"":t)+"</binary>"}.call(this),n+="\n</FictionBook>"}.call(this,"NS"in r?r.NS:"undefined"!=typeof NS?NS:void 0,"annotation"in r?r.annotation:"undefined"!=typeof annotation?annotation:void 0,"attaches"in r?r.attaches:"undefined"!=typeof attaches?attaches:void 0,"authors"in r?r.authors:"undefined"!=typeof authors?authors:void 0,"body"in r?r.body:"undefined"!=typeof body?body:void 0,"bookAlias"in r?r.bookAlias:"undefined"!=typeof bookAlias?bookAlias:void 0,"fullDate"in r?r.fullDate:"undefined"!=typeof fullDate?fullDate:void 0,"genres"in r?r.genres:"undefined"!=typeof genres?genres:void 0,"homePage"in r?r.homePage:"undefined"!=typeof homePage?homePage:void 0,"lang"in r?r.lang:"undefined"!=typeof lang?lang:void 0,"programName"in r?r.programName:"undefined"!=typeof programName?programName:void 0,"shortDate"in r?r.shortDate:"undefined"!=typeof shortDate?shortDate:void 0,"title"in r?r.title:"undefined"!=typeof title?title:void 0),n}({...e,NS:xe,body:W(be({title:e.title,parts:t}),a),annotation:W("<div>"+e.description+"</div>",a),programName:"ranobe-rf-fb2-loader",shortDate:e.date("YYYY-MM-DD"),fullDate:e.date("DD.MM.YYYY"),attaches:await D(a,async e=>Object.assign(e,await R(e.src)),{concurrency:5})}),"application/xml");s.querySelectorAll("header").forEach(e=>F(s,e,"title",xe)),T.saveAs(new Blob(['<?xml version="1.0" encoding="utf-8" ?>'+s.documentElement.outerHTML],{type:"text/xml;charset=utf-8"}),e.bookAlias+".fb2")}catch(e){console.error(e),alert("Ошибка загрузки. Попробуйте снова.")}finally{n(0,r=!1),n(1,o=0)}}()}),console.log("ranobe-rf-fb2-loader 0.1.0")});const i={"ранобэ.рф":J,"xn--80ac9aeh6f.xn--p1ai":J,"ranobes.com":V};return[r,o]}class je extends class{$destroy(){!function(e,t){const n=e.$$;null!==n.fragment&&(r(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}{constructor(e){var t;super(),document.getElementById("svelte-1nj6wvk-style")||((t=l("style")).id="svelte-1nj6wvk-style",t.textContent='.c.svelte-1nj6wvk{margin:auto;top:0;bottom:0;left:0;right:0;position:absolute;pointer-events:none;width:100px;height:100px}.h.svelte-1nj6wvk{width:100%;height:100%;position:absolute;left:0;top:0}.h.svelte-1nj6wvk:before{content:"";display:block;margin:0 auto;width:15%;height:15%;background-color:#303745;border-radius:100%;animation:svelte-1nj6wvk-sk-circleBounceDelay 1.2s infinite ease-in-out both}.c2.svelte-1nj6wvk{transform:rotate(30deg)}.c2.svelte-1nj6wvk:before{animation-delay:-1.1s}.c3.svelte-1nj6wvk{transform:rotate(60deg)}.c3.svelte-1nj6wvk:before{animation-delay:-1s}.c4.svelte-1nj6wvk{transform:rotate(90deg)}.c4.svelte-1nj6wvk:before{animation-delay:-0.9s}.c5.svelte-1nj6wvk{transform:rotate(120deg)}.c5.svelte-1nj6wvk:before{animation-delay:-0.8s}.c6.svelte-1nj6wvk{transform:rotate(150deg)}.c6.svelte-1nj6wvk:before{animation-delay:-0.7s}.c7.svelte-1nj6wvk{transform:rotate(180deg)}.c7.svelte-1nj6wvk:before{animation-delay:-0.6s}.c8.svelte-1nj6wvk{transform:rotate(210deg)}.c8.svelte-1nj6wvk:before{animation-delay:-0.5s}.c9.svelte-1nj6wvk{transform:rotate(240deg)}.c9.svelte-1nj6wvk:before{animation-delay:-0.4s}.c10.svelte-1nj6wvk{transform:rotate(270deg)}.c10.svelte-1nj6wvk:before{animation-delay:-0.3s}.c11.svelte-1nj6wvk{transform:rotate(300deg)}.c11.svelte-1nj6wvk:before{animation-delay:-0.2s}.c12.svelte-1nj6wvk{transform:rotate(330deg)}.c12.svelte-1nj6wvk:before{animation-delay:-0.1s}@keyframes svelte-1nj6wvk-sk-circleBounceDelay{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}.bg.svelte-1nj6wvk{background:rgba(255, 255, 255, 0.8);width:100vw;height:100vh;line-height:100vh;display:block;position:fixed;top:0;left:0;text-align:center;font-size:16px;color:#303745;-moz-user-select:none;-webkit-user-select:none;user-select:none}',a(document.head,t)),E(this,e,Se,$e,i,{})}}let Oe=()=>{document.removeEventListener("DOMContentLoaded",Oe);const e=document.createElement("div");e.style.zIndex="16777270",e.style.position="fixed",e.style.top="0",e.style.left="0",document.body.appendChild(e),new je({target:e})};"complete"===document.readyState||"interactive"===document.readyState?Oe():document.addEventListener("DOMContentLoaded",Oe)}();
