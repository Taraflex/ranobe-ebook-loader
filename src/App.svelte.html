<style>
	.sk-circle {
		margin: auto;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		position: absolute;
		pointer-events: none;
	}

	.sk-circle {
		width: 100px;
		height: 100px;
	}

	.sk-circle .sk-child {
		width: 100%;
		height: 100%;
		position: absolute;
		left: 0;
		top: 0;
	}

	.sk-circle .sk-child:before {
		content: '';
		display: block;
		margin: 0 auto;
		width: 15%;
		height: 15%;
		background-color: #303745;
		border-radius: 100%;
		-webkit-animation: sk-circleBounceDelay 1.2s infinite ease-in-out both;
		animation: sk-circleBounceDelay 1.2s infinite ease-in-out both;
	}

	.sk-circle .sk-circle2 {
		-webkit-transform: rotate(30deg);
		-ms-transform: rotate(30deg);
		transform: rotate(30deg);
	}

	.sk-circle .sk-circle3 {
		-webkit-transform: rotate(60deg);
		-ms-transform: rotate(60deg);
		transform: rotate(60deg);
	}

	.sk-circle .sk-circle4 {
		-webkit-transform: rotate(90deg);
		-ms-transform: rotate(90deg);
		transform: rotate(90deg);
	}

	.sk-circle .sk-circle5 {
		-webkit-transform: rotate(120deg);
		-ms-transform: rotate(120deg);
		transform: rotate(120deg);
	}

	.sk-circle .sk-circle6 {
		-webkit-transform: rotate(150deg);
		-ms-transform: rotate(150deg);
		transform: rotate(150deg);
	}

	.sk-circle .sk-circle7 {
		-webkit-transform: rotate(180deg);
		-ms-transform: rotate(180deg);
		transform: rotate(180deg);
	}

	.sk-circle .sk-circle8 {
		-webkit-transform: rotate(210deg);
		-ms-transform: rotate(210deg);
		transform: rotate(210deg);
	}

	.sk-circle .sk-circle9 {
		-webkit-transform: rotate(240deg);
		-ms-transform: rotate(240deg);
		transform: rotate(240deg);
	}

	.sk-circle .sk-circle10 {
		-webkit-transform: rotate(270deg);
		-ms-transform: rotate(270deg);
		transform: rotate(270deg);
	}

	.sk-circle .sk-circle11 {
		-webkit-transform: rotate(300deg);
		-ms-transform: rotate(300deg);
		transform: rotate(300deg);
	}

	.sk-circle .sk-circle12 {
		-webkit-transform: rotate(330deg);
		-ms-transform: rotate(330deg);
		transform: rotate(330deg);
	}

	.sk-circle .sk-circle2:before {
		-webkit-animation-delay: -1.1s;
		animation-delay: -1.1s;
	}

	.sk-circle .sk-circle3:before {
		-webkit-animation-delay: -1s;
		animation-delay: -1s;
	}

	.sk-circle .sk-circle4:before {
		-webkit-animation-delay: -0.9s;
		animation-delay: -0.9s;
	}

	.sk-circle .sk-circle5:before {
		-webkit-animation-delay: -0.8s;
		animation-delay: -0.8s;
	}

	.sk-circle .sk-circle6:before {
		-webkit-animation-delay: -0.7s;
		animation-delay: -0.7s;
	}

	.sk-circle .sk-circle7:before {
		-webkit-animation-delay: -0.6s;
		animation-delay: -0.6s;
	}

	.sk-circle .sk-circle8:before {
		-webkit-animation-delay: -0.5s;
		animation-delay: -0.5s;
	}

	.sk-circle .sk-circle9:before {
		-webkit-animation-delay: -0.4s;
		animation-delay: -0.4s;
	}

	.sk-circle .sk-circle10:before {
		-webkit-animation-delay: -0.3s;
		animation-delay: -0.3s;
	}

	.sk-circle .sk-circle11:before {
		-webkit-animation-delay: -0.2s;
		animation-delay: -0.2s;
	}

	.sk-circle .sk-circle12:before {
		-webkit-animation-delay: -0.1s;
		animation-delay: -0.1s;
	}

	@-webkit-keyframes sk-circleBounceDelay {

		0%,
		80%,
		100% {
			-webkit-transform: scale(0);
			transform: scale(0);
		}

		40% {
			-webkit-transform: scale(1);
			transform: scale(1);
		}
	}

	@keyframes sk-circleBounceDelay {

		0%,
		80%,
		100% {
			-webkit-transform: scale(0);
			transform: scale(0);
		}

		40% {
			-webkit-transform: scale(1);
			transform: scale(1);
		}
	}

	.rg-loader-bg {
		background: rgba(255, 255, 255, 0.8);
		width: 100vw;
		height: 100vh;
		line-height: 100vh;
		display: block;
		position: fixed;
		top: 0;
		left: 0;
		text-align: center;
		font-size: 16px;
		color: #303745;
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
		user-select: none;
	}
</style>
<div>
	{#if loading}
	<div class="rg-loader-bg">
		<div class="sk-circle">
			<div class="sk-circle1 sk-child"></div>
			<div class="sk-circle2 sk-child"></div>
			<div class="sk-circle3 sk-child"></div>
			<div class="sk-circle4 sk-child"></div>
			<div class="sk-circle5 sk-child"></div>
			<div class="sk-circle6 sk-child"></div>
			<div class="sk-circle7 sk-child"></div>
			<div class="sk-circle8 sk-child"></div>
			<div class="sk-circle9 sk-child"></div>
			<div class="sk-circle10 sk-child"></div>
			<div class="sk-circle11 sk-child"></div>
			<div class="sk-circle12 sk-child"></div>
		</div>
		{percent}%
	</div>
	{/if}
</div>
<script>
	import 'nodelist-foreach-polyfill';
	import saveAs from 'file-saver';
	import dayjs from 'dayjs';
	import hotkeys from 'hotkeys-js';
	import * as rndHex from 'rnd-hex';
	import * as fb2Template from './fb2.pug';
	import * as pageTemplate from './page.pug';
	import lastMatch from 'last-match';
	import pMap from 'p-map';

	const unescapeMap = {
		//'&amp;': '&',
		'&quot;': '"',
		'&quote;': '"',
		'&#x27;': "'",
		'&#39;': "'",
		'&apos;': "'",
		// ['#x2F', '/'],
		// ['#47', '/'],
		'&#x60;': '`',
		'&nbsp;': ' ',
		'&#95;': '_',
		'&#34;': '"'
	}

	function createEscaper(map) {
		const escaper = function (match) {
			return map[match];
		};
		// Regexes for identifying a key that needs to be escaped.
		const source = '(?:' + Object.keys(map).join('|') + ')';
		const testRegexp = RegExp(source);
		const replaceRegexp = RegExp(source, 'g');
		return function (string) {
			string = string == null ? '' : '' + string;
			return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
		};
	};

	const unescape = createEscaper(unescapeMap);

	const NS = "http://www.gribuser.ru/xml/fictionbook/2.0";

	//todo подобрать лучшие соответствия http://www.fictionbook.org/index.php/%D0%96%D0%B0%D0%BD%D1%80%D1%8B_FictionBook_2.1
	const genresMap = {
		"Adult": "home_sex",
		"Josei": "sf_action",
		"Mature": "",
		"Shounen": "sf_action",
		"Xianxia": "sf_fantasy",
		"Xuanhuan": "sf_fantasy",
		"Боевик": "det_action",
		"Боевые Искусства": "fantasy_fight",
		"Вампиры": "vampire_book",
		"Виртуальный Мир": "sf",
		"Гарем": "",
		"Гендерная Интрига": "",
		"Героическое Фэнтези": "sf_heroic",
		"Детектив": "detective",
		"Дзёсэй": "sf_action",
		"Драма": "dramaturgy",
		"Игра": "sf",
		"История": "sci_history",
		"Комедия": "humor",
		"Меха": "sf",
		"Мистика": "sf_horror",
		"Научная Фантастика": "sf",
		"Оригинальный сюжет": "",
		"Повседневность": "",
		"Приключения": "adventure",
		"Психология": "sci_psychology",
		"Романтика": "",
		"Сверхъестественное": "sf_horror",
		"Смена Пола": "",
		"Спорт": "home_sport",
		"Сэйнэн": "sf_action",
		"Сёдзе": "",
		"Сёдзе-ай": "",
		"Сёнэн": "sf_action",
		"Трагедия": "",
		"Триллер": "thriller",
		"Ужасы": "sf_horror",
		"Уся": "fantasy_fight",
		"Фэнтези": "sf_fantasy",
		"Хентай": "home_sex",
		"Школьная Жизнь": "children",
		"Экшн": "sf_action",
		"Эротика": "love_erotica",
		"Этти": "love_erotica",
		"Юри": ""
	}

	async function fetchJson(entry, query) {
		return (await fetch(
			`https://xn--80ac9aeh6f.xn--p1ai/v1/${entry}/get/?` + Object.keys(query).map(k => `${k}=${query[k]}`).join('&'),
			{ credentials: 'include' }
		)).json();
	}

	const fetchBook = fetchJson.bind(null, 'book');
	const fetchPart = fetchJson.bind(null, 'part');

	function last(a) {
		return a[a.length - 1];
	}

	const B64_RE = /^\s*data:([image\/jpnf]+);base64/;

	function splitImageBase64(dataUrl, mime) {
		return {
			mime: lastMatch(dataUrl, B64_RE) || mime,
			data: dataUrl.slice(dataUrl.indexOf(',') + 1)
		};
	}

	function toBase64(blob, mime) {
		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.onloadend = function (evt) {
				try {
					if (reader.readyState == /*FileReader.DONE*/ 2) {
						resolve(splitImageBase64(reader.result, mime));
					} else {
						reject(reader.error);
					}
				} catch (err) {
					reject(err);
				}
			};
			reader.readAsDataURL(blob);
		});
	}

	async function downloadImage(url) {
		if (B64_RE.test(url)) {
			return splitImageBase64(url);
		} else {
			const bookResp = await fetch(url);
			return toBase64(await bookResp.blob(), bookResp.headers.get('content-type'));
		}
	}

	function parse(text, mime) {
		const doc = new DOMParser().parseFromString(text, mime);
		const err = doc.querySelector('parsererror');
		if (err) {
			throw err.textContent;
		}
		return doc;
	}

	function replaceTag(doc, elem, tag) {
		const t = doc.createElement(tag);
		while (elem.firstChild) {
			t.appendChild(elem.firstChild);
		}
		elem.parentNode.replaceChild(t, elem);
	}

	function processHtml(raw, images) {
		raw = raw
			.replace(/>(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g, '>')
			.replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+<\//g, '</')
			.replace(/(\s*<br(\s+[^\/<>]+)?\/?>\s*)+/g, '</p><p>');

		const doc = parse(raw, 'text/html');

		doc.querySelectorAll('i,em').forEach(e => {
			replaceTag(doc, e, 'emphasis');
		});
		doc.querySelectorAll('b').forEach(e => {
			replaceTag(doc, e, 'strong');
		});
		doc.querySelectorAll('s,strike').forEach(e => {
			replaceTag(doc, e, 'strikethrough');
		});
		doc.querySelectorAll('div').forEach(e => {
			replaceTag(doc, e, 'p');
		});
		doc.querySelectorAll('img').forEach(e => {
			const id = '_' + rndHex();
			images.push({ src: e.src, id });
			const i = doc.createElement('image');
			i.setAttribute('l:href', '#' + id);
			e.parentNode.replaceChild(i, e);
		});
		doc.querySelectorAll('body :not(section):not(emphasis):not(code):not(header):not(strong):not(strikethrough):not(p):not(empty-line):not(sub):not(sup):not(image)').forEach(e => {
			replaceTag(doc, e, 'code');
		});
		let wrapped;
		while ((wrapped = doc.querySelectorAll('p > p')) && wrapped.length > 0) {
			wrapped.forEach(e => {
				while (e.firstChild) e.parentNode.insertBefore(e.firstChild, e);
				e.parentNode.removeChild(e);
			});
		}
		doc.querySelectorAll('body :not(image)').forEach(e => {
			if (e.attributes.length > 0) {
				Array.from(e.attributes).forEach(attr => e.removeAttribute(attr.name));
			}
		});

		return unescape(doc.body.innerHTML)
			.replace(/><\/image>/g, '/>')
			.replace(/(\s*<code>\s*<\/code>\s*)+/g, ' ')
			.replace(/(\s*<p>\s*<\/p>\s*)+/g, ' ');
	}

	export default {
		data() {
			return {
				loading: false,
				percent: 0,
				error: null
			};
		},

		oncreate() {
			hotkeys('ctrl+s', event => {
				event.stopPropagation();
				event.preventDefault();
				const { loading } = this.get();
				if (!loading) {
					this.load();
				}
			});
			console.log(APP_TITLE + ' loaded');
		},

		methods: {
			async load() {
				try {
					this.set({ loading: true, percent: 0, error: null });
					const bookAlias = location.pathname.split('/', 2).filter(s => s)[0];
					const { result } = await fetchBook({ bookAlias });
					const { book, genres, parts } = result;
					const d = dayjs(book.publishedAt);

					const g = new Set(genres.map(g => genresMap[g.title]));
					g.delete(undefined);
					g.delete('');
					if (g.size < 1) {
						g.add('unrecognised');
					}

					const { mime, data } = await downloadImage(book.image.desktop.image);

					const concurrency = 5;

					const results = await pMap(parts.reverse(), async ({ url }, i) => {
						try {
							return fetchPart({ bookAlias, partAlias: last(url.split('/').filter(s => s)) });
						} catch (_) {
							return fetchPart({ bookAlias, partAlias: last(url.split('/').filter(s => s)) });
						} finally {
							const { percent } = this.get();
							this.set({ percent: Math.max(percent, ((i + 1) * 100 / parts.length) | 0) });
						}
					}, { concurrency });

					const images = [];

					const body = processHtml(pageTemplate({
						title: book.title,
						parts: results,
					}), images);

					const annotation = processHtml(book.description, images);

					const doc = parse(fb2Template({
						NS,
						genres: Array.from(g),
						title: book.title,
						annotation,
						//lang: 'jp',//todo
						author: book.author,
						programName: APP_TITLE,
						bookAlias,
						shortDate: d.format('YYYY-MM-DD'),
						fullDate: d.format('DD.MM.YYYY'),
						body,
						attaches: [
							{ id: 'cover', mime, data },
							... await pMap(images, async image => Object.assign(image, await downloadImage(image.src)), { concurrency })
						]
					}), 'application/xml');

					doc.querySelectorAll('header').forEach(e => {
						const t = doc.createElementNS(NS, 'title');
						while (e.firstChild) {
							t.appendChild(e.firstChild);
						}
						e.parentNode.replaceChild(t, e);
					});

					saveAs(new Blob(['<?xml version="1.0" encoding="utf-8" ?>' + doc.documentElement.outerHTML], { type: "text/xml;charset=utf-8" }), bookAlias + '.fb2');
				} catch (e) {
					console.error(e);
					//todo better message
					alert('Ошибка загрузки. Попробуйте снова.');
				} finally {
					this.set({ loading: false, percent: 0 });
				}
			}
		}
	}
</script>